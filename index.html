<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Livres & Reliures — CRM</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#080c18;color:#ccd6f6;font-family:'Georgia','Times New Roman',serif}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:#0a0f1e}
::-webkit-scrollbar-thumb{background:#1e2d4a;border-radius:3px}
input:focus,select:focus,textarea:focus{border-color:#c9a84c!important;outline:none}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useMemo,useCallback} = React;

// ─── Supabase Config ─────────────────────────────────────────────
const SB_URL="https://eruxkubcprvmrqiwycvl.supabase.co";
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVydXhrdWJjcHJ2bXJxaXd5Y3ZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MzAzOTksImV4cCI6MjA4NzAwNjM5OX0.oSwLDUODs_CcmTyrMGyMbxcDH1wJ4o9l-7cxxAk2Zi0";
const SB_H={"apikey":SB_KEY,"Authorization":"Bearer "+SB_KEY,"Content-Type":"application/json","Prefer":"return=representation"};
const bookToDb=(b)=>({id:b.id,titre:b.titre||"",auteur:b.auteur||"",date:b.date||"",editeur:b.editeur||"",lieu_edition:b.lieuEdition||"",completion:b.completion||"",categorie:b.categorie||"",nb_vol:b.nbVol||0,siecle:b.siecle||0,eo:b.eo||"",theme:b.theme||"",etat:b.etat||"",format:b.format||"",nb_pages:b.nbPages||0,poids:b.poids||0,stockage:b.stockage||"",num_achat:b.numAchat||"",date_achat:b.dateAchat||"",px_achat:b.pxAchat||0,total_achat:b.totalAchat||0,lieu_achat:b.lieuAchat||"",publie:b.publie||"Non",vendu:b.vendu||"Non",date_mise_en_vente:b.dateMiseEnVente||"",date_vente:b.dateVente||"",duree_vente:b.dureeVente||"",px_mise_en_vente:b.pxMiseEnVente||0,px_encaisse:b.pxEncaisse||0,modalites:b.modalites||"",livre:b.livre||"",frais_expedition:b.fraisExpedition||0,benef_attendu:b.benefAttendu||0,benef_realise:b.benefRealise||0,difference:b.difference||0,prix_conseille_ia:b.prixConseilleIA||0,carac_spec:b.caracSpec||{frontispice:false,gravures:false,exLibris:false,cartes:false,illustrations:false},annonce_html:b.annonceHtml||"",updated_at:new Date().toISOString()});
const dbToBook=(r)=>{const e=r.etat==="Excellent"?"Bon":r.etat==="Moyen"?"Correct":r.etat||"";return{id:r.id,titre:r.titre||"",auteur:r.auteur||"",date:r.date||"",editeur:r.editeur||"",lieuEdition:r.lieu_edition||"",completion:r.completion||"",categorie:r.categorie||"",nbVol:r.nb_vol||0,siecle:r.siecle||0,eo:r.eo||"",theme:r.theme||"",etat:e,format:r.format||"",nbPages:r.nb_pages||0,poids:r.poids||0,stockage:r.stockage||"",numAchat:r.num_achat||"",dateAchat:r.date_achat||"",pxAchat:r.px_achat||0,totalAchat:r.total_achat||0,lieuAchat:r.lieu_achat||"",publie:r.publie||"Non",vendu:r.vendu||"Non",dateMiseEnVente:r.date_mise_en_vente||"",dateVente:r.date_vente||"",dureeVente:r.duree_vente||"",pxMiseEnVente:r.px_mise_en_vente||0,pxEncaisse:r.px_encaisse||0,modalites:r.modalites||"",livre:r.livre||"",fraisExpedition:r.frais_expedition||0,benefAttendu:r.benef_attendu||0,benefRealise:r.benef_realise||0,difference:r.difference||0,prixConseilleIA:r.prix_conseille_ia||0,caracSpec:r.carac_spec||{},annonceHtml:r.annonce_html||""}};
const expToDb=(e)=>({vente_num:e.venteNum||"",date:e.date||"",categorie:e.categorie||"",vendeur:e.vendeur||"",description:e.description||"",montant:e.montant||0});
const dbToExp=(r)=>({id:r.id,venteNum:r.vente_num||"",date:r.date||"",categorie:r.categorie||"",vendeur:r.vendeur||"",description:r.description||"",montant:r.montant||0});

// ─── Data ───────────────────────────────────────────────────────────
const IMPORTED_BOOKS = [{"id":"1","titre":"Histoire des Révolutions de Corse","auteur":"Abbé de Germanes","date":"1771","editeur":"","completion":"2/2","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"EO","theme":"Histoire","etat":"Bon","format":"In 12","poids":0.715,"stockage":"1","numAchat":"1","dateAchat":"2025-09-24","pxAchat":63.56,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Oui","dateMiseEnVente":"2025-10-14","dateVente":"2025-10-16","dureeVente":"2 jours","pxMiseEnVente":500,"pxEncaisse":400,"modalites":"Ebay","livre":"OK","fraisExpedition":10,"benefAttendu":426.44,"benefRealise":326.44,"difference":-100},{"id":"2","titre":"Mélange critique de littérature","auteur":"La Morlière","date":"1701","editeur":"Pierre Brunel","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"Non","theme":"Littérature","etat":"Bon","format":"In 12","poids":0.326,"stockage":"1","numAchat":"1","dateAchat":"2025-09-24","pxAchat":12.71,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-10-19","dateVente":"","dureeVente":"121 jours","pxMiseEnVente":100,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":87.29,"benefRealise":0,"difference":0},{"id":"3","titre":"L'esprit de Montaigne","auteur":"Montaigne","date":"1783","editeur":"","completion":"2/2","categorie":"Ouvrage","nbVol":2,"siecle":18,"eo":"Non","theme":"Philosophie","etat":"Bon","format":"In 18","poids":0.318,"stockage":"1","numAchat":"1","dateAchat":"2025-09-24","pxAchat":15.25,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-10-19","dateVente":"","dureeVente":"121 jours","pxMiseEnVente":120,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":104.75,"benefRealise":0,"difference":0},{"id":"4","titre":"Récit des temps Mérovingiens","auteur":"A. Thierry","date":"1846","editeur":"Furne & Cie","completion":"2/2","categorie":"Ouvrage","nbVol":2,"siecle":19,"eo":"Non","theme":"Histoire","etat":"Bon","format":"In 12","poids":0.868,"stockage":"3","numAchat":"1","dateAchat":"2025-09-29","pxAchat":6.36,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-09","dateVente":"","dureeVente":"100 jours","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":43.64,"benefRealise":0,"difference":0},{"id":"5","titre":"Formulaire de prières à l'usage des Ursulines de Metz","auteur":"-","date":"1717","editeur":"Brice Antoine","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"Non","theme":"Religion","etat":"Bon","format":"In 12","poids":0.386,"stockage":"1","numAchat":"1","dateAchat":"2025-09-29","pxAchat":12.71,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-12","dateVente":"","dureeVente":"97 jours","pxMiseEnVente":100,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":87.29,"benefRealise":0,"difference":0},{"id":"6","titre":"L'esprit de Saint François de Sales","auteur":"Mgr Camus","date":"1740","editeur":"","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"Non","theme":"Religion","etat":"Bon","format":"In 12","poids":0.495,"stockage":"1","numAchat":"1","dateAchat":"2025-09-29","pxAchat":12.71,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-13","dateVente":"","dureeVente":"96 jours","pxMiseEnVente":100,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":87.29,"benefRealise":0,"difference":0},{"id":"7","titre":"Bucoliques","auteur":"Virgile","date":"1812","editeur":"Delaunay","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Poésie","etat":"Bon","format":"In 12","poids":0.263,"stockage":"3","numAchat":"1","dateAchat":"2025-09-29","pxAchat":7.63,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-09","dateVente":"","dureeVente":"100 jours","pxMiseEnVente":60,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":52.37,"benefRealise":0,"difference":0},{"id":"8","titre":"La Satyre de Petrone","auteur":"-","date":"1694","editeur":"Pierre Marteau","completion":"1/2","categorie":"Ouvrage","nbVol":1,"siecle":17,"eo":"EO","theme":"Littérature","etat":"Correct","format":"In 12","poids":0.235,"stockage":"1","numAchat":"1","dateAchat":"2025-09-29","pxAchat":12.71,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-14","dateVente":"","dureeVente":"95 jours","pxMiseEnVente":100,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":87.29,"benefRealise":0,"difference":0},{"id":"9","titre":"Le devoir des pasteurs","auteur":"-","date":"1699","editeur":"François Godard","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":17,"eo":"EO","theme":"Religion","etat":"Bon","format":"In 12","poids":0.265,"stockage":"1","numAchat":"1","dateAchat":"2025-09-29","pxAchat":25.42,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-15","dateVente":"","dureeVente":"94 jours","pxMiseEnVente":200,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":174.58,"benefRealise":0,"difference":0},{"id":"10","titre":"Recueil de pièces sur la religion","auteur":"-","date":"1755","editeur":"Veuve Bordelet","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"EO","theme":"Religion","etat":"Bon","format":"In 12","poids":0.46,"stockage":"1","numAchat":"1","dateAchat":"2025-09-29","pxAchat":19.07,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-16","dateVente":"","dureeVente":"93 jours","pxMiseEnVente":150,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":130.93,"benefRealise":0,"difference":0},{"id":"11","titre":"Office de l'Eglise","auteur":"-","date":"1821","editeur":"Mégard","completion":"4/4","categorie":"Ouvrage","nbVol":4,"siecle":19,"eo":"EO","theme":"Religion","etat":"Bon","format":"In 12","poids":2.483,"stockage":"3","numAchat":"1","dateAchat":"2025-09-29","pxAchat":12.71,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-09","dateVente":"","dureeVente":"100 jours","pxMiseEnVente":100,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":87.29,"benefRealise":0,"difference":0},{"id":"12","titre":"Salammbô","auteur":"Gustave Flaubert","date":"1864","editeur":"Michel Levy frères","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Littérature","etat":"Correct","format":"In 12","poids":0.4,"stockage":"3","numAchat":"1","dateAchat":"2025-09-29","pxAchat":6.36,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-09","dateVente":"","dureeVente":"100 jours","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":43.64,"benefRealise":0,"difference":0},{"id":"13","titre":"Lot de 25 volumes du 18ème (comprenant 18 volumes de l'Histoire de France de M. Garnier)","auteur":"-","date":"-","editeur":"-","completion":"","categorie":"Lot","nbVol":25,"siecle":18,"eo":"Non","theme":"","etat":"","format":"","poids":0,"stockage":"1","numAchat":"1","dateAchat":"2025-09-29","pxAchat":75,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"","vendu":"","dateMiseEnVente":"","dateVente":"","dureeVente":"","pxMiseEnVente":250,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":175,"benefRealise":0,"difference":0},{"id":"14","titre":"Théâtre complet - A. de Vigny","auteur":"A. de Vigny","date":"1841","editeur":"Charpentier","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"EO","theme":"Littérature","etat":"Bon","format":"In 12","poids":0.354,"stockage":"3","numAchat":"1","dateAchat":"2025-09-29","pxAchat":6.36,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-09","dateVente":"","dureeVente":"100 jours","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":43.64,"benefRealise":0,"difference":0},{"id":"15","titre":"Profils et Grimaces","auteur":"Auguste Vacquerie","date":"1856","editeur":"Michel Levy Frères","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"EO","theme":"Littérature","etat":"Correct","format":"In 12","poids":0.357,"stockage":"3","numAchat":"1","dateAchat":"2025-09-29","pxAchat":3.81,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-09","dateVente":"","dureeVente":"100 jours","pxMiseEnVente":30,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":26.19,"benefRealise":0,"difference":0},{"id":"16","titre":"Lot de 9 ouvrages du 19ème","auteur":"-","date":"-","editeur":"-","completion":"-","categorie":"Lot","nbVol":9,"siecle":19,"eo":"Non","theme":"Divers","etat":"Bon","format":"","poids":0,"stockage":"0","numAchat":"1","dateAchat":"2025-09-29","pxAchat":18,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"","vendu":"","dateMiseEnVente":"","dateVente":"","dureeVente":"","pxMiseEnVente":45,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":27,"benefRealise":0,"difference":0},{"id":"17","titre":"Paul et Virginie","auteur":"Bernadin de Saint Pierre","date":"1868","editeur":"Alphonse Lemerre","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Littérature","etat":"Bon","format":"In Folio","poids":2.655,"stockage":"4","numAchat":"3","dateAchat":"2025-10-22","pxAchat":8.81,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-08","dateVente":"","dureeVente":"101 jours","pxMiseEnVente":100,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":91.19,"benefRealise":0,"difference":0},{"id":"18","titre":"Beautés de l'histoire de Russie","auteur":"PJB Nougaret","date":"1814","editeur":"Le Prieur","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"EO","theme":"Histoire","etat":"Bon","format":"In 12","poids":0.349,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":10.49,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-16","dateVente":"","dureeVente":"1 jours","pxMiseEnVente":119,"pxEncaisse":90,"modalites":"Ebay","livre":"Non","fraisExpedition":0,"benefAttendu":108.51,"benefRealise":0,"difference":0},{"id":"19","titre":"L'abeille littéraire","auteur":"-","date":"1779","editeur":"-","completion":"4/4","categorie":"Ouvrage","nbVol":4,"siecle":18,"eo":"EO","theme":"Littérature","etat":"Bon","format":"In 8","poids":1.9,"stockage":"1","numAchat":"3","dateAchat":"2025-10-22","pxAchat":21.59,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-13","dateVente":"","dureeVente":"4 jours","pxMiseEnVente":245,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":223.41,"benefRealise":0,"difference":0},{"id":"20","titre":"The last of the Mortimers","auteur":"Margaret Oliphant","date":"1862","editeur":"B. Tauchnitz","completion":"2/2","categorie":"Ouvrage","nbVol":2,"siecle":19,"eo":"Oui","theme":"Littérature","etat":"Bon","format":"In 16","poids":0.5,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":8.52,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-23","dateVente":"","dureeVente":"","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":41.48,"benefRealise":0,"difference":0},{"id":"21","titre":"Œuvres poétiques (seconde partie)","auteur":"Gresset","date":"1741","editeur":"Pelissart","completion":"1/2","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"EO","theme":"Poésie","etat":"Correct","format":"In 12","poids":0.274,"stockage":"1","numAchat":"3","dateAchat":"2025-10-22","pxAchat":4.41,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-14","dateVente":"","dureeVente":"3 jours","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":45.59,"benefRealise":0,"difference":0},{"id":"22","titre":"Ordonnance de Louis XIV","auteur":"-","date":"1720","editeur":"-","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"Non","theme":"Droit","etat":"Bon","format":"In 12","poids":0.22,"stockage":"1","numAchat":"3","dateAchat":"2025-10-22","pxAchat":10.49,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-12","dateVente":"","dureeVente":"5 jours","pxMiseEnVente":119,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":108.51,"benefRealise":0,"difference":0},{"id":"23","titre":"Hermès ou recherches philosophiques sur la grammaire universelle","auteur":"Jacques Harris","date":"1796","editeur":"-","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"EO","theme":"Philosophie","etat":"Correct","format":"In 8","poids":0.59,"stockage":"1","numAchat":"3","dateAchat":"2025-10-22","pxAchat":8.37,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-15","dateVente":"","dureeVente":"2 jours","pxMiseEnVente":95,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":86.63,"benefRealise":0,"difference":0},{"id":"24","titre":"Réflexions et menus-propos d'un peintre genevois","auteur":"R. Topffer","date":"1878","editeur":"Hachette","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Art & architecture","etat":"Bon","format":"In 12","poids":0.6,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":1.76,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-17","dateVente":"","dureeVente":"0 jours","pxMiseEnVente":20,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":18.24,"benefRealise":0,"difference":0},{"id":"25","titre":"Barthèle ou encore une victime de la jalousie","auteur":"M. Duronceray","date":"1808","editeur":"Chaumerot","completion":"2/2","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"EO","theme":"Littérature","etat":"Correct","format":"In 12","poids":0.23,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":5.2,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-18","dateVente":"","dureeVente":"","pxMiseEnVente":59,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":53.8,"benefRealise":0,"difference":0},{"id":"26","titre":"Dictionnaire raisonné universel d'histoire naturelle","auteur":"Valmont de Bomare","date":"1768","editeur":"Lacombe","completion":"6/6","categorie":"Ouvrage","nbVol":6,"siecle":18,"eo":"Non","theme":"Sciences et mathématiques","etat":"Bon","format":"In 8","poids":2.9,"stockage":"1","numAchat":"3","dateAchat":"2025-10-22","pxAchat":22.03,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-11","dateVente":"","dureeVente":"6 jours","pxMiseEnVente":250,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":227.97,"benefRealise":0,"difference":0},{"id":"27","titre":"Fables","auteur":"John Gay","date":"1813","editeur":"Didot","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Poésie","etat":"Bon","format":"In 12","poids":0.12,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":4.32,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-19","dateVente":"","dureeVente":"","pxMiseEnVente":49,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":44.68,"benefRealise":0,"difference":0},{"id":"28","titre":"Manuel complet des poids et mesures","auteur":"M. Tarbé","date":"1840","editeur":"Roret","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Sciences et mathématiques","etat":"Bon","format":"In 12","poids":0.27,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":3.08,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-20","dateVente":"","dureeVente":"","pxMiseEnVente":35,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":31.92,"benefRealise":0,"difference":0},{"id":"29","titre":"Chinese tales - Mandarin Fum-Hoam","auteur":"M. Gueulett","date":"1798","editeur":"Cooke","completion":"2/2","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"Non","theme":"Littérature","etat":"Bon","format":"In 12","poids":0.181,"stockage":"1","numAchat":"3","dateAchat":"2025-10-22","pxAchat":7.93,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-10","dateVente":"","dureeVente":"7 jours","pxMiseEnVente":90,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":82.07,"benefRealise":0,"difference":0},{"id":"30","titre":"Oeuvres illustrées","auteur":"Balzac","date":"1867","editeur":"Michel Levy Frères","completion":"5/5","categorie":"Ouvrage","nbVol":5,"siecle":19,"eo":"Non","theme":"Littérature","etat":"Bon","format":"In 4","poids":6.4,"stockage":"4","numAchat":"3","dateAchat":"2025-10-22","pxAchat":13.13,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-15","dateVente":"","dureeVente":"2 jours","pxMiseEnVente":149,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":135.87,"benefRealise":0,"difference":0},{"id":"31","titre":"Oeuvres complètes de Boileau","auteur":"Boileau","date":"1856","editeur":"Hachette","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Littérature","etat":"Bon","format":"In 8","poids":0.602,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":2.2,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-28","dateVente":"","dureeVente":"","pxMiseEnVente":25,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":22.8,"benefRealise":0,"difference":0},{"id":"32","titre":"Les cinq codes","auteur":"M. Pailliet","date":"1813","editeur":"Alphonse Garnery","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Droit","etat":"Mauvais","format":"In 12","poids":0.644,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":3.53,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-27","dateVente":"","dureeVente":"","pxMiseEnVente":40,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":36.47,"benefRealise":0,"difference":0},{"id":"33","titre":"Letters of Lady Mary Wortley Montague","auteur":"Mary W. Montague","date":"1793","editeur":"H.DD Symonds","completion":"2/2","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"Non","theme":"Voyages","etat":"Correct","format":"In 12","poids":0.223,"stockage":"1","numAchat":"3","dateAchat":"2025-10-22","pxAchat":4.32,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-10","dateVente":"","dureeVente":"7 jours","pxMiseEnVente":49,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":44.68,"benefRealise":0,"difference":0},{"id":"34","titre":"Opuscules sur les sciences physiques","auteur":"AN Desvaux","date":"1831","editeur":"","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"EO","theme":"Sciences et mathématiques","etat":"Bon","format":"In 8","poids":0.48,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":10.49,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-21","dateVente":"","dureeVente":"","pxMiseEnVente":119,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":108.51,"benefRealise":0,"difference":0},{"id":"35","titre":"Le Danube Allemand et l'Allemagne du Sud","auteur":"Hippolyte Durand","date":"1863","editeur":"A. Mame","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"EO","theme":"Voyages","etat":"Bon","format":"In 4","poids":1.373,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":4.23,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-26","dateVente":"","dureeVente":"","pxMiseEnVente":48,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":43.77,"benefRealise":0,"difference":0},{"id":"36","titre":"Les lois rurales de la France","auteur":"M. Fournel","date":"1820","editeur":"Bossange","completion":"3/3","categorie":"Ouvrage","nbVol":3,"siecle":19,"eo":"Non","theme":"Droit","etat":"Bon","format":"In 8","poids":1.895,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":6.08,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-23","dateVente":"","dureeVente":"","pxMiseEnVente":69,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":62.92,"benefRealise":0,"difference":0},{"id":"37","titre":"Lord Oakburn's Daughters","auteur":"Mrs. Henry Wood","date":"1864","editeur":"Tauchnitz","completion":"2/2","categorie":"Ouvrage","nbVol":2,"siecle":19,"eo":"EO","theme":"Littérature","etat":"Bon","format":"In 12","poids":0.643,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":5.2,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-25","dateVente":"","dureeVente":"","pxMiseEnVente":59,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":53.8,"benefRealise":0,"difference":0},{"id":"38","titre":"Histoire d'Alger","auteur":"Stéphen d'Estry","date":"1841","editeur":"Ad Mame","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Oui","theme":"Histoire","etat":"Correct","format":"In 12","poids":0.55,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":13.63,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-24","dateVente":"","dureeVente":"","pxMiseEnVente":80,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":66.37,"benefRealise":0,"difference":0},{"id":"39","titre":"Les trois Marie","auteur":"Michel Masson","date":"1840","editeur":"Librairie de Dumont","completion":"2/2","categorie":"Ouvrage","nbVol":2,"siecle":19,"eo":"EO","theme":"Littérature","etat":"Bon","format":"In 8","poids":0.903,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":4.32,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-12","dateVente":"","dureeVente":"5 jours","pxMiseEnVente":49,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":44.68,"benefRealise":0,"difference":0},{"id":"40","titre":"Les écorcheurs ou l'usurpation et la peste","auteur":"Vicomte d'Arlincourt","date":"1833","editeur":"Eugène Renduel","completion":"2/2","categorie":"Ouvrage","nbVol":2,"siecle":19,"eo":"Non","theme":"Littérature","etat":"Bon","format":"In 8","poids":0.914,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":5.29,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-24","dateVente":"","dureeVente":"","pxMiseEnVente":60,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":54.71,"benefRealise":0,"difference":0},{"id":"41","titre":"Mémoires d'un prisonnier d'Etat au Spielberg","auteur":"A. Andryane","date":"1838","editeur":"Ladvocat","completion":"3/3","categorie":"Ouvrage","nbVol":3,"siecle":19,"eo":"Non","theme":"Histoire","etat":"Bon","format":"In 8","poids":1.403,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":13.22,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Non","vendu":"","dateMiseEnVente":"","dateVente":"","dureeVente":"","pxMiseEnVente":150,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":136.78,"benefRealise":0,"difference":0},{"id":"42","titre":"Mes loisirs","auteur":"Baronne de Montaran","date":"1846","editeur":"Librairie d'Amyot","completion":"2/2","categorie":"Ouvrage","nbVol":2,"siecle":19,"eo":"EO","theme":"Littérature","etat":"Bon","format":"In 8","poids":1.153,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":7.05,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-22","dateVente":"","dureeVente":"","pxMiseEnVente":80,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":72.95,"benefRealise":0,"difference":0},{"id":"43","titre":"Sermons de M. Massillon","auteur":"M. Massillon","date":"1776","editeur":"La Veuve Estienne","completion":"","categorie":"Ouvrage","nbVol":4,"siecle":18,"eo":"Non","theme":"Religion","etat":"Bon","format":"In 12","poids":1.08,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":15.17,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-23","dateVente":"","dureeVente":"86 jours","pxMiseEnVente":89,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":73.83,"benefRealise":0,"difference":0},{"id":"44","titre":"Biblia sacra vulgatoe editionis","auteur":"-","date":"1741","editeur":"Frères Deville","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"Non","theme":"Religion","etat":"Bon","format":"In 12","poids":0.78,"stockage":"2","numAchat":"2","dateAchat":"2025-10-11","pxAchat":51.13,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-23","dateVente":"","dureeVente":"86 jours","pxMiseEnVente":300,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":248.87,"benefRealise":0,"difference":0},{"id":"45","titre":"Œuvres complètes - Flaubert","auteur":"Gustave Flaubert","date":"1885","editeur":"A. Quantin","completion":"8/8","categorie":"Ouvrage","nbVol":8,"siecle":19,"eo":"Oui","theme":"Littérature","etat":"Bon","format":"In 8","poids":10,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":127.83,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-03-01","dateVente":"","dureeVente":"","pxMiseEnVente":750,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":622.17,"benefRealise":0,"difference":0},{"id":"46","titre":"Les convulsions de Paris","auteur":"Maxime du Camp","date":"1878","editeur":"Hachette","completion":"4/4","categorie":"Ouvrage","nbVol":4,"siecle":19,"eo":"Non","theme":"Histoire","etat":"Bon","format":"In 8","poids":3.6,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":14.49,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-03-02","dateVente":"","dureeVente":"","pxMiseEnVente":85,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":70.51,"benefRealise":0,"difference":0},{"id":"47","titre":"Mes souvenirs","auteur":"Général du Barail","date":"1894","editeur":"Plon","completion":"3/3","categorie":"Ouvrage","nbVol":3,"siecle":19,"eo":"Non","theme":"Histoire","etat":"Bon","format":"In 8","poids":2.7,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":8.52,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-03-03","dateVente":"","dureeVente":"","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":41.48,"benefRealise":0,"difference":0},{"id":"48","titre":"René d'Anjou","auteur":"Cordellier-Delanoue","date":"1855","editeur":"Ad Mame","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Histoire","etat":"Bon","format":"In 12","poids":0.3,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":6.82,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-03-04","dateVente":"","dureeVente":"","pxMiseEnVente":40,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":33.18,"benefRealise":0,"difference":0},{"id":"49","titre":"Mémoires du Général Baron Thiébault","auteur":"Claire Thibéault","date":"1896","editeur":"Plon","completion":"5/5","categorie":"Ouvrage","nbVol":5,"siecle":19,"eo":"Non","theme":"Histoire","etat":"Bon","format":"In 8","poids":5,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":51.13,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-03-05","dateVente":"","dureeVente":"","pxMiseEnVente":300,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":248.87,"benefRealise":0,"difference":0},{"id":"50","titre":"Histoire de Princes de Condé","auteur":"M. le duc d'Aumale","date":"1863","editeur":"Michel Levy Frères","completion":"5/5","categorie":"Ouvrage","nbVol":5,"siecle":19,"eo":"Oui","theme":"Histoire","etat":"Bon","format":"In 8","poids":5,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":15.34,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-03-06","dateVente":"","dureeVente":"","pxMiseEnVente":90,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":74.66,"benefRealise":0,"difference":0},{"id":"51","titre":"Dictionnaire de Diplomatique Chrétienne","auteur":"Quantin","date":"1846","editeur":"J.-P. Migne","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Oui","theme":"Religion","etat":"Bon","format":"In 8","poids":1.3,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":8.52,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-03-07","dateVente":"","dureeVente":"","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":41.48,"benefRealise":0,"difference":0},{"id":"52","titre":"Marysienka — Reine de Pologne","auteur":"K. Waliszewski","date":"1898","editeur":"Plon","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Oui","theme":"Histoire","etat":"Bon","format":"In 8","poids":0.95,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":6.82,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-03-07","dateVente":"","dureeVente":"","pxMiseEnVente":40,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":33.18,"benefRealise":0,"difference":0},{"id":"53","titre":"Liste générale des postes de France","auteur":"Sr. Jaillot","date":"1757","editeur":"Chez le Sr. Jaillot","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"Non","theme":"Géographie","etat":"Correct","format":"In 12","poids":0.15,"stockage":"2","numAchat":"2","dateAchat":"2025-10-11","pxAchat":20.45,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-03-06","dateVente":"","dureeVente":"","pxMiseEnVente":120,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":99.55,"benefRealise":0,"difference":0},{"id":"54","titre":"Abrégé de l'histoire universelle","auteur":"Claude de l'Isle","date":"1731","editeur":"Didot","completion":"7/7","categorie":"Ouvrage","nbVol":7,"siecle":18,"eo":"Oui","theme":"Histoire","etat":"Bon","format":"In 12","poids":2.5,"stockage":"2","numAchat":"2","dateAchat":"2025-10-11","pxAchat":153.39,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-16","dateVente":"","dureeVente":"1 jours","pxMiseEnVente":900,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":746.61,"benefRealise":0,"difference":0},{"id":"55","titre":"Abrégé des trois siècles de la littérature française","auteur":"Abbé Sabattier","date":"1821","editeur":"C. Painparré","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Littérature","etat":"Bon","format":"In 12","poids":0.28,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":8.52,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-17","dateVente":"","dureeVente":"0 jours","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":41.48,"benefRealise":0,"difference":0},{"id":"56","titre":"La France à Jérusalem","auteur":"Adrien Peladan","date":"1855","editeur":"Gaume Frères","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Oui","theme":"Histoire","etat":"Correct","format":"In 12","poids":0.25,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":8.52,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-18","dateVente":"","dureeVente":"","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":41.48,"benefRealise":0,"difference":0},{"id":"57","titre":"Voyage en Angleterre et en Russe (Vol 2)","auteur":"Edouard de Montule","date":"1825","editeur":"Arthus Bertrand","completion":"1/2","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Oui","theme":"Voyages","etat":"Bon","format":"In 8","poids":0.5,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":17.04,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-19","dateVente":"","dureeVente":"","pxMiseEnVente":100,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":82.96,"benefRealise":0,"difference":0},{"id":"58","titre":"Traité de peinture (Vol 1)","auteur":"Dandré Bardon","date":"1765","editeur":"Desaint","completion":"1/2","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"Oui","theme":"Art","etat":"Bon","format":"In 12","poids":0.3,"stockage":"2","numAchat":"2","dateAchat":"2025-10-11","pxAchat":8.52,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-03-08","dateVente":"","dureeVente":"","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":41.48,"benefRealise":0,"difference":0},{"id":"59","titre":"Le Buffon du jeune age","auteur":"Elisabeth Müller","date":"-","editeur":"Amédée Bédelet","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Enfants","etat":"Bon","format":"In 8","poids":0.45,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":8.52,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-03-09","dateVente":"","dureeVente":"","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":41.48,"benefRealise":0,"difference":0},{"id":"60","titre":"Essai sur le beau","auteur":"Père André","date":"1810","editeur":"Ferra","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Philosophie","etat":"Bon","format":"In 12","poids":0.35,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":8.52,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-21","dateVente":"","dureeVente":"","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":41.48,"benefRealise":0,"difference":0},{"id":"61","titre":"Nouveau Voyage de France","auteur":"MLR","date":"1778","editeur":"Libraires Associés","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"Non","theme":"Voyage","etat":"Correct","format":"In 12","poids":0.4,"stockage":"2","numAchat":"2","dateAchat":"2025-10-11","pxAchat":27.27,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-22","dateVente":"","dureeVente":"","pxMiseEnVente":160,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":132.73,"benefRealise":0,"difference":0},{"id":"62","titre":"Vocabulaire ou dictionnaire portatif","auteur":"MM. R et L","date":"1812","editeur":"Amable Leroy","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":0,"eo":"Non","theme":"Dictionnaire","etat":"Correct","format":"In 12","poids":0.77,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":0,"totalAchat":0,"lieuAchat":"Passerelle des enchères","publie":"","vendu":"","dateMiseEnVente":"","dateVente":"","dureeVente":"","pxMiseEnVente":0,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":0,"benefRealise":0,"difference":0}];

const IMPORTED_EXPENSES = [{"venteNum":"0","date":"2025-01-01","categorie":"Achat de livres","vendeur":"Gratuit","montant":0,"description":"Livres obtenus gratuitement"},{"venteNum":"1","date":"2025-09-26","categorie":"Frais de livraison","vendeur":"Cocolis","montant":57,"description":"Livraison de la vente du 24/09/2025"},{"venteNum":"1","date":"2025-09-29","categorie":"Achat de livres","vendeur":"Inter Ville CP","montant":253.38,"description":"Achat vente du 24/09/25 (lots 12 et 14)"},{"venteNum":"2","date":"2025-10-11","categorie":"Achat de livres","vendeur":"La passerelle des Enchères","montant":488.68,"description":"Lot 715 (vente du 11/10/2025)"},{"venteNum":"2","date":"2025-11-12","categorie":"Frais de livraison","vendeur":"Pacaud transports","montant":100,"description":"Livraison de la vente du 11/10/2025"},{"venteNum":"3","date":"2025-10-22","categorie":"Achat de livres","vendeur":"Deloys","montant":187.55,"description":"Lot 144 (vente du 22/10/2025)"},{"venteNum":"TOUTES","date":"2025-10-01","categorie":"Abonnement Ebay","vendeur":"eBay","montant":20,"description":"Abonnement eBay - Octobre 2025"},{"venteNum":"TOUTES","date":"2025-11-01","categorie":"Abonnement Ebay","vendeur":"eBay","montant":20,"description":"Abonnement eBay - Novembre 2025"},{"venteNum":"TOUTES","date":"2025-12-01","categorie":"Abonnement Ebay","vendeur":"eBay","montant":20,"description":"Abonnement eBay - Décembre 2025"},{"venteNum":"TOUTES","date":"2026-01-01","categorie":"Abonnement Ebay","vendeur":"eBay","montant":20,"description":"Abonnement eBay - Janvier 2026"},{"venteNum":"TOUTES","date":"2026-02-01","categorie":"Abonnement Ebay","vendeur":"eBay","montant":20,"description":"Abonnement eBay - Février 2026"}];

// ─── Calcul automatique du prix d'achat ──────────────────────────
function computePxAchat(books, expenses){
  // Group books by numAchat
  const byAchat={};
  books.forEach(b=>{const k=b.numAchat||"0";if(!byAchat[k])byAchat[k]=[];byAchat[k].push(b)});
  // Get total achat amount per vente from expenses
  const totalAchatByVente={};
  expenses.forEach(e=>{if(e.categorie==="Achat de livres")totalAchatByVente[e.venteNum]=(totalAchatByVente[e.venteNum]||0)+e.montant});
  // Compute for each group
  const result={};
  Object.entries(byAchat).forEach(([num, grp])=>{
    const totalVente=totalAchatByVente[num]||0;
    // Step 1: Lots get forfait
    let totalLots=0;
    grp.forEach(b=>{
      if(b.categorie==="Lot"){
        const s=parseInt(b.siecle)||0;
        const forfait=s===18?30:s===19?20:0;
        result[b.id]=forfait;
        totalLots+=forfait;
      }
    });
    // Step 2: Ouvrages share the rest proportionally by pxMiseEnVente
    const ouvrages=grp.filter(b=>b.categorie==="Ouvrage"||b.categorie!=="Lot");
    const ouvragesOnly=grp.filter(b=>b.categorie!=="Lot");
    const restant=Math.max(0, totalVente-totalLots);
    const sommeMEV=ouvragesOnly.reduce((a,b)=>a+(b.pxMiseEnVente||0),0);
    ouvragesOnly.forEach(b=>{
      if(sommeMEV>0&&restant>0){
        result[b.id]=Math.round(((b.pxMiseEnVente||0)/sommeMEV)*restant*100)/100;
      } else {
        result[b.id]=0;
      }
    });
  });
  return result;
}

const THEMES=["Art & architecture","Equitation","Histoire","Littérature","Divers","Poésie","Voyages","Religion","Sciences et mathématiques","Philosophie","Médecine","Droit","Nature et Chasse","Géographie","Dictionnaire","Enfants","Art","Voyage"];
const ETATS=["Bon","Correct","Mauvais"];
const FORMATS=["In 32","In 18","In 16","In 12","In 8","In 4","In Folio"];
const CATEGORIES=["Lot","Ouvrage"];
const EO_VALS=["Oui","Non"];
const SIECLES=[16,17,18,19];
const EXPENSE_CATS=["Achat de livres","Frais de livraison","Frais d'envoi","Abonnement Ebay","Matériel","Divers"];

const fmt=(n)=>n?new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR",minimumFractionDigits:2}).format(n).replace(/\u202F/g,".").replace(/\u00A0/g,"."):"—";
const fmtD=(d)=>d?new Date(d+"T00:00:00").toLocaleDateString("fr-FR"):"—";
const TABS=[{key:"dashboard",label:"Tableau de bord",icon:"◈"},{key:"inventaire",label:"Inventaire",icon:"◉"},{key:"ventes",label:"Ventes",icon:"◆"},{key:"sourcing",label:"Sourcing",icon:"◇"},{key:"depenses",label:"Achats / Frais",icon:"▣"},{key:"encheres",label:"Enchères",icon:"⚒"}];

const c={background:"linear-gradient(135deg,#1a1a2e,#16213e)",border:"1px solid #1e2d4a",borderRadius:12,padding:24};
const inp={width:"100%",padding:"9px 12px",background:"#0d1525",border:"1px solid #1e2d4a",borderRadius:8,color:"#e6f1ff",fontSize:13,fontFamily:"'JetBrains Mono',monospace",outline:"none",boxSizing:"border-box"};
const sel={...inp,cursor:"pointer"};
const btnP={padding:"10px 24px",background:"linear-gradient(135deg,#c9a84c,#a07c30)",border:"none",borderRadius:8,color:"#0a0f1e",fontSize:13,fontWeight:700,cursor:"pointer",fontFamily:"'JetBrains Mono',monospace"};
const btnS={...btnP,background:"transparent",border:"1px solid #2a3a5a",color:"#8892b0"};

const Stat=({label,value,sub,accent="#c9a84c"})=>(
  <div style={{...c,flex:"1 1 180px",minWidth:170,padding:"18px 22px"}}>
    <div style={{fontSize:11,textTransform:"uppercase",letterSpacing:2,color:"#6a7a9a",marginBottom:6,fontFamily:"'JetBrains Mono',monospace"}}>{label}</div>
    <div style={{fontSize:24,fontWeight:700,color:accent,fontFamily:"'Playfair Display',serif"}}>{value}</div>
    {sub&&<div style={{fontSize:11,color:"#4a5a7a",marginTop:4,fontFamily:"'JetBrains Mono',monospace"}}>{sub}</div>}
  </div>
);

const Modal=({open,onClose,title,children,wide,narrow,noClickOutside,confirmClose})=>{if(!open)return null;const handleClose=()=>{if(confirmClose){if(window.confirm("Êtes-vous sûr de vouloir fermer ? Les modifications non enregistrées seront perdues."))onClose()}else{onClose()}};return(
  <div onClick={noClickOutside?undefined:handleClose} style={{position:"fixed",inset:0,background:"rgba(0,0,0,.7)",backdropFilter:"blur(8px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000,padding:16}}>
    <div onClick={e=>e.stopPropagation()} style={{background:"linear-gradient(180deg,#0f1629,#0a0f1e)",border:"1px solid #1e2d4a",borderRadius:16,padding:28,width:"100%",maxWidth:narrow?460:wide?820:640,maxHeight:"88vh",overflowY:"auto"}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}>
        <h2 style={{margin:0,fontSize:18,color:"#e6f1ff",fontFamily:"'Playfair Display',serif"}}>{title}</h2>
        <button onClick={handleClose} style={{background:"none",border:"none",color:"#5a6a8a",fontSize:22,cursor:"pointer"}}>✕</button>
      </div>{children}
    </div>
  </div>
);};

const Field=({label,children,w})=>(
  <div style={{flex:w||"1 1 48%",minWidth:180,marginBottom:14}}>
    <label style={{display:"block",fontSize:10,textTransform:"uppercase",letterSpacing:1.5,color:"#5a7a9a",marginBottom:5,fontFamily:"'JetBrains Mono',monospace"}}>{label}</label>{children}
  </div>
);

const BookDetail=({book})=>{if(!book)return null;
  const [showCompta,setShowCompta]=useState(false);
  const isVendu=book.vendu==="Oui";
  const Sec=({title,children})=>(<div style={{marginBottom:22}}><div style={{fontSize:11,textTransform:"uppercase",letterSpacing:2,color:"#c9a84c",marginBottom:12,fontFamily:"'JetBrains Mono',monospace",borderBottom:"1px solid #1a2540",paddingBottom:6}}>{title}</div><div>{children}</div></div>);
  const I=({l,v,bold})=>(<div style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 0",borderBottom:"1px solid #0d1525"}}><span style={{fontSize:11,color:"#4a5a7a",textTransform:"uppercase",letterSpacing:1,fontFamily:"'JetBrains Mono',monospace"}}>{l}</span><span style={{fontSize:13,color:bold?"#e6f1ff":"#ccd6f6",fontWeight:bold?700:500,textAlign:"right",maxWidth:"60%"}}>{v||"—"}</span></div>);
  const multiple=book.pxAchat>0&&book.benefRealise?((book.benefRealise/book.pxAchat).toFixed(1)):"";
  if(showCompta)return(<div>
    <h2 style={{textAlign:"center",fontSize:18,fontWeight:700,color:"#e6f1ff",fontFamily:"'Playfair Display',serif",margin:"0 0 20px"}}>{book.titre}</h2>
    <Sec title="Bilan comptable">
      <I l="Prix d'achat" v={fmt(book.pxAchat)}/>
      <I l="Prix de vente net" v={book.vendu==="Oui"?fmt((book.pxEncaisse||0)-(book.commissionVente||0)-(book.fraisExpedition||0)):"—"}/>
      <I l="Bénéfice réalisé" v={book.vendu==="Oui"?fmt((book.pxEncaisse||0)-(book.commissionVente||0)-(book.fraisExpedition||0)-(book.pxAchat||0)):"—"} bold/>
      {multiple&&<div style={{textAlign:"right",padding:"4px 0",fontSize:12,color:"#8892b0",fontFamily:"'JetBrains Mono',monospace"}}>Multiple : x {multiple}</div>}
    </Sec>
    <div style={{display:"flex",justifyContent:"center",marginTop:20}}>
      <button onClick={()=>setShowCompta(false)} style={{background:"none",border:"1px solid #2a3a5a",borderRadius:8,color:"#c9a84c",fontSize:12,padding:"8px 20px",cursor:"pointer",fontFamily:"'JetBrains Mono',monospace"}}>← Retour</button>
    </div>
  </div>);
  return(<div>
    <h2 style={{textAlign:"center",fontSize:26,fontWeight:700,color:"#e6f1ff",fontFamily:"'Playfair Display',serif",margin:"0 0 16px",lineHeight:1.3,textTransform:"uppercase",letterSpacing:1}}>{book.titre}</h2>
    <div style={{display:"flex",justifyContent:"center",alignItems:"center",marginBottom:24,position:"relative"}}>
      <span style={{display:"inline-block",padding:"4px 14px",borderRadius:20,fontSize:11,fontWeight:700,fontFamily:"'JetBrains Mono',monospace",letterSpacing:1,background:isVendu?"rgba(76,201,140,.12)":"rgba(201,168,76,.12)",color:isVendu?"#4cc98c":"#c9a84c",border:isVendu?"1px solid rgba(76,201,140,.25)":"1px solid rgba(201,168,76,.25)"}}>{isVendu?"VENDU":"EN VENTE"}</span>
      <button onClick={()=>setShowCompta(true)} style={{position:"absolute",right:0,background:"linear-gradient(135deg,#c9a84c22,#c9a84c11)",border:"1px solid #c9a84c44",borderRadius:8,color:"#c9a84c",fontSize:14,fontWeight:700,padding:"4px 12px",cursor:"pointer",fontFamily:"'JetBrains Mono',monospace"}} title="Bilan comptable">€</button>
    </div>
    <Sec title="Caractéristiques"><I l="Auteur" v={book.auteur}/><I l="Date d'édition" v={book.date}/><I l="Éditeur" v={book.editeur}/><I l="Complétion" v={book.completion}/><I l="Catégorie" v={book.categorie}/><I l="Nb volumes" v={book.nbVol}/><I l="Siècle" v={book.siecle?book.siecle+"ème":""}/><I l="Édition originale" v={book.eo}/><I l="Thème" v={book.theme}/><I l="État" v={book.etat}/><I l="Format" v={book.format}/><I l="Poids" v={book.poids?book.poids+" g":""}/><I l="Stockage" v={book.stockage}/>{book.notes&&<I l="Notes" v={book.notes}/>}</Sec>
    <Sec title="Achat"><I l="N° achat" v={book.numAchat}/><I l="Date d'achat" v={fmtD(book.dateAchat)}/><I l="Prix d'achat" v={fmt(book.pxAchat)}/><I l="Lieu d'achat" v={book.lieuAchat}/></Sec>
    <Sec title="Vente"><I l="Publié" v={book.publie}/><I l="Vendu" v={book.vendu}/><I l="Date mise en vente" v={fmtD(book.dateMiseEnVente)}/><I l="Date de vente" v={fmtD(book.dateVente)}/><I l="Durée de vente" v={book.dateMiseEnVente&&book.dateVente?Math.round((new Date(book.dateVente)-new Date(book.dateMiseEnVente))/86400000)+" jours":book.dateMiseEnVente&&book.vendu!=="Oui"?Math.round((new Date()-new Date(book.dateMiseEnVente))/86400000)+" jours (en cours)":"—"}/><I l="Prix mise en vente" v={fmt(book.pxMiseEnVente)}/><I l="Prix encaissé" v={fmt(book.pxEncaisse)}/><I l="Commissions" v={book.commissionVente?fmt(book.commissionVente):"—"}/><I l="Prix de vente net" v={book.pxEncaisse?fmt((book.pxEncaisse||0)-(book.commissionVente||0)):"—"}/></Sec>
    {(()=>{const livré=book.dateLivraison?"Oui":"Non";const ba=book.pxMiseEnVente?(book.pxMiseEnVente-(book.pxAchat||0)-(book.pxMiseEnVente*0.1)-10):0;const br=book.vendu==="Oui"?((book.pxEncaisse||0)-(book.commissionVente||0)-(book.fraisExpedition||0)-(book.pxAchat||0)):0;const diff=book.vendu==="Oui"?(br-ba):0;return(<Sec title="Expédition & Bénéfice"><I l="Livré" v={livré}/><I l="Frais d'expédition" v={fmt(book.fraisExpedition)}/><I l="Bénéfice attendu" v={book.pxMiseEnVente?fmt(ba):"—"}/><I l="Bénéfice réalisé" v={book.vendu==="Oui"?fmt(br):"—"}/><I l="Différence" v={book.vendu==="Oui"?fmt(diff):"—"}/></Sec>)})()}
  </div>);
};

const BookForm=({book,onSave,onCancel,onSyncExpense,expenses=[],books=[]})=>{
  const [f,setF]=useState(book||{titre:"",auteur:"",date:"",editeur:"",lieuEdition:"",completion:"Oui",categorie:"Ouvrage",nbVol:"",eo:"",theme:"",etat:"",format:"",nbPages:"",poids:"",stockage:"",numAchat:"",dateAchat:"",pxAchat:"",totalAchat:"",lieuAchat:"",publie:"Non",vendu:"Non",dateMiseEnVente:"",dateVente:"",dateLivraison:"",dureeVente:"",pxMiseEnVente:"",pxEncaisse:"",commissionVente:"",modalites:"",modeLivraison:"",livre:"",fraisExpedition:"",benefAttendu:"",benefRealise:"",difference:"",prixConseilleIA:"",notes:"",caracSpec:{frontispice:false,gravures:false,exLibris:false,cartes:false}});
  const s=(k,v)=>setF(p=>({...p,[k]:v}));
  const toggleSpec=(k)=>setF(p=>({...p,caracSpec:{...(p.caracSpec||{}), [k]:!(p.caracSpec||{})[k]}}));
  const [formErr,setFormErr]=useState("");
  const [formTab,setFormTab]=useState("carac");
  const venteNums=useMemo(()=>[...new Set(expenses.map(e=>e.venteNum).filter(v=>v&&v!=="G"&&v!=="TOUTES"&&v!=="CUSTOM"))].sort((a,b)=>Number(a)-Number(b)),[expenses]);
  const venteInfo=useMemo(()=>{const m={};expenses.filter(e=>e.categorie==="Achat de livres"||e.categorie==="Divers").forEach(e=>{if(!m[e.venteNum])m[e.venteNum]={date:e.date,lieu:e.vendeur}});return m},[expenses]);
  const venteDates={"0":"Achat Gratuit (01/01/2025)","1":"24/09/2025","2":"11/10/2025","3":"22/10/2025"};
  const latestVente=useMemo(()=>{const achats=expenses.filter(e=>e.categorie==="Achat de livres"&&e.venteNum).sort((a,b)=>(b.date||"").localeCompare(a.date||""));return achats.length?achats[0].venteNum:""},[expenses]);
  useEffect(()=>{if(!book&&latestVente&&!f.numAchat){selectVente(latestVente)}},[]);
  const selectVente=(num)=>{
    s("numAchat",num);setFormErr("");
    if(num&&venteInfo[num]){s("dateAchat",venteInfo[num].date);s("lieuAchat",venteInfo[num].lieu)}
    else{s("dateAchat","");s("lieuAchat","")}
  };
  const handleSave=()=>{
    if(!f.titre.trim()){setFormErr("Le titre est obligatoire.");return}
    if(!f.numAchat){setFormErr("Le N° achat est obligatoire.");return}
    setFormErr("");
    const nextId=(()=>{if(f.id)return f.id;const nums=books.map(bk=>parseInt(bk.id)).filter(n=>!isNaN(n)&&n>0);const maxNum=nums.length?Math.max(...nums):0;return String(Math.max(maxNum,books.length)+1)})();
    const savedBook={...f,id:nextId};
    onSave(savedBook);
    // Sync frais d'envoi to Achats/Frais (upsert or delete)
    if(onSyncExpense){
      const fraisData=f.vendu==="Oui"&&f.fraisExpedition&&+f.fraisExpedition>0?{venteNum:f.numAchat||"TOUTES",date:f.dateVente||f.dateLivraison||new Date().toISOString().slice(0,10),vendeur:f.modeLivraison||"Colissimo",montant:+f.fraisExpedition,description:"Envoi livre #"+nextId+" — "+(f.titre||"").slice(0,40)}:null;
      onSyncExpense(nextId,"Frais d'envoi",fraisData);
    }
  };
  const [photos,setPhotos]=useState([]);
  const [analyzing,setAnalyzing]=useState(false);
  const [analyzeMsg,setAnalyzeMsg]=useState("");
  const [apiKey,setApiKey]=useState("");
  const [showKeyInput,setShowKeyInput]=useState(false);
  useEffect(()=>{(async()=>{try{const r=await fetch(SB_URL+"/rest/v1/settings?key=eq.anthropic_api_key&select=value",{headers:{"apikey":SB_KEY,"Authorization":"Bearer "+SB_KEY}});if(r.ok){const d=await r.json();if(d.length&&d[0].value){setApiKey(d[0].value);return}}}catch(e){}try{const v=localStorage.getItem("rl-anthropic-key");if(v)setApiKey(v)}catch(e){}})()},[]); 
  const fileRef=React.useRef(null);
  const galleryRef=React.useRef(null);

  const videoRef=React.useRef(null);
  const canvasRef=React.useRef(null);
  const [cameraOpen,setCameraOpen]=useState(false);
  const [stream,setStream]=useState(null);

  // ─── iCloud Dossier Picker (persistant) ───
  const [dirHandle,setDirHandle]=useState(null);
  const [dirName,setDirName]=useState("");
  const [dirFiles,setDirFiles]=useState([]);
  const [showDirPicker,setShowDirPicker]=useState(false);
  const [dirSelected,setDirSelected]=useState(new Set());
  const [dirLoading,setDirLoading]=useState(false);
  const [dirPreviews,setDirPreviews]=useState({});
  const [dirError,setDirError]=useState("");

  // Persist / restore folder handle via IndexedDB
  const idbStore=useCallback(async(action,handle)=>{
    return new Promise((res,rej)=>{
      const req=indexedDB.open("rl-crm-dirs",1);
      req.onupgradeneeded=()=>{req.result.createObjectStore("handles")};
      req.onsuccess=()=>{
        const db=req.result;
        if(action==="save"){
          const tx=db.transaction("handles","readwrite");
          tx.objectStore("handles").put(handle,"icloud");
          tx.oncomplete=()=>res(true);
        }else{
          const tx=db.transaction("handles","readonly");
          const g=tx.objectStore("handles").get("icloud");
          g.onsuccess=()=>res(g.result||null);
        }
      };
      req.onerror=()=>res(null);
    });
  },[]);

  // Load saved handle on mount
  useEffect(()=>{
    (async()=>{
      try{
        const saved=await idbStore("load");
        if(saved){setDirHandle(saved);setDirName(saved.name)}
      }catch(e){}
    })();
  },[]);

  const loadDirFiles=async(handle)=>{
    setDirLoading(true);setDirError("");setDirPreviews({});setDirSelected(new Set());
    try{
      // Verify permission
      const perm=await handle.queryPermission({mode:"read"});
      if(perm!=="granted"){
        const req=await handle.requestPermission({mode:"read"});
        if(req!=="granted"){setDirError("Accès refusé au dossier.");setDirLoading(false);return}
      }
      const files=[];
      for await(const entry of handle.values()){
        if(entry.kind==="file"){
          const f=await entry.getFile();
          if(f.type.startsWith("image/")){
            files.push({name:f.name,file:f,size:f.size,lastModified:f.lastModified});
          }
        }
      }
      // Tri par date décroissante (plus récentes d'abord)
      files.sort((a,b)=>b.lastModified-a.lastModified);
      setDirFiles(files);
      setDirLoading(false);
      // Générer les previews pour les 60 premières images
      const batch=files.slice(0,60);
      for(const item of batch){
        try{
          const blob=item.file.slice(0,item.file.size);
          const bmp=await createImageBitmap(blob);
          const cv=document.createElement("canvas");
          const MAX=240;
          let w=bmp.width,h=bmp.height;
          if(w>h){h=Math.round(h*MAX/w);w=MAX}else{w=Math.round(w*MAX/h);h=MAX}
          cv.width=w;cv.height=h;
          cv.getContext("2d").drawImage(bmp,0,0,w,h);
          const url=cv.toDataURL("image/jpeg",0.7);
          setDirPreviews(prev=>({...prev,[item.name]:url}));
          bmp.close();
        }catch(e){}
      }
    }catch(err){
      console.error(err);
      setDirError("Erreur de lecture. Sélectionnez à nouveau le dossier.");
      setDirLoading(false);
    }
  };

  const openFolderPicker=async(forceNew)=>{
    if(!window.showDirectoryPicker){
      galleryRef.current&&galleryRef.current.click();return;
    }
    // Si on a déjà un handle sauvegardé et qu'on ne force pas le changement
    if(dirHandle&&!forceNew){
      setShowDirPicker(true);
      await loadDirFiles(dirHandle);
      return;
    }
    try{
      const handle=await window.showDirectoryPicker({mode:"read",startIn:"pictures"});
      setDirHandle(handle);setDirName(handle.name);
      await idbStore("save",handle);
      setShowDirPicker(true);
      await loadDirFiles(handle);
    }catch(err){
      if(err.name!=="AbortError"){console.error(err);galleryRef.current&&galleryRef.current.click()}
    }
  };

  const toggleDirFile=(name)=>{
    setDirSelected(prev=>{const n=new Set(prev);if(n.has(name))n.delete(name);else n.add(name);return n});
  };

  const selectAllDir=()=>{
    if(dirSelected.size===dirFiles.length){setDirSelected(new Set())}
    else{setDirSelected(new Set(dirFiles.map(f=>f.name)))}
  };

  const importSelectedFromDir=async()=>{
    if(!dirSelected.size)return;
    setDirLoading(true);
    const selected=dirFiles.filter(f=>dirSelected.has(f.name));
    const results=[];
    for(const item of selected){
      try{
        const file=item.file;
        const bmp=await createImageBitmap(file);
        const cv=document.createElement("canvas");
        let w=bmp.width,h=bmp.height;const MAX=1200;
        if(w>MAX||h>MAX){if(w>h){h=Math.round(h*MAX/w);w=MAX}else{w=Math.round(w*MAX/h);h=MAX}}
        cv.width=w;cv.height=h;cv.getContext("2d").drawImage(bmp,0,0,w,h);
        const dataUrl=cv.toDataURL("image/jpeg",0.85);
        results.push({data:dataUrl.split(",")[1],type:"image/jpeg",name:file.name,preview:dataUrl});
        bmp.close();
      }catch(e){console.error("Import error:",item.name,e)}
    }
    setPhotos(prev=>[...prev,...results]);
    setShowDirPicker(false);setDirSelected(new Set());setDirLoading(false);
  };

  const openCamera=async()=>{
    try{
      const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1920},height:{ideal:1080}},audio:false});
      setStream(s);setCameraOpen(true);
      setTimeout(()=>{if(videoRef.current){videoRef.current.srcObject=s;videoRef.current.play()}},100);
    }catch(err){
      console.log("Camera API not available, falling back to file input");
      fileRef.current&&fileRef.current.click();
    }
  };

  const takePhoto=()=>{
    if(!videoRef.current||!canvasRef.current)return;
    const v=videoRef.current,cv=canvasRef.current;
    let w=v.videoWidth,h=v.videoHeight;
    const MAX=1200;
    if(w>MAX||h>MAX){if(w>h){h=Math.round(h*MAX/w);w=MAX}else{w=Math.round(w*MAX/h);h=MAX}}
    cv.width=w;cv.height=h;
    cv.getContext("2d").drawImage(v,0,0,w,h);
    const dataUrl=cv.toDataURL("image/jpeg",0.85);
    const base64=dataUrl.split(",")[1];
    setPhotos(prev=>[...prev,{data:base64,type:"image/jpeg",name:"photo_"+Date.now()+".jpg",preview:dataUrl}]);
  };

  const closeCamera=()=>{
    if(stream){stream.getTracks().forEach(t=>t.stop());setStream(null)}
    setCameraOpen(false);
  };

  const handleCapture=(e)=>{
    const files=Array.from(e.target.files||[]);
    if(!files.length)return;
    const promises=files.map(file=>new Promise((res)=>{
      const r=new FileReader();
      r.onload=()=>{
        const img=new Image();
        img.onload=()=>{
          const cv=document.createElement("canvas");
          let w=img.width,h=img.height;
          const MAX=1200;
          if(w>MAX||h>MAX){if(w>h){h=Math.round(h*MAX/w);w=MAX}else{w=Math.round(w*MAX/h);h=MAX}}
          cv.width=w;cv.height=h;
          cv.getContext("2d").drawImage(img,0,0,w,h);
          const dataUrl=cv.toDataURL("image/jpeg",0.85);
          const base64=dataUrl.split(",")[1];
          res({data:base64,type:"image/jpeg",name:file.name,preview:dataUrl});
        };
        img.onerror=()=>res({data:r.result.split(",")[1],type:"image/jpeg",name:file.name,preview:r.result});
        img.src=r.result;
      };
      r.readAsDataURL(file);
    }));
    Promise.all(promises).then(results=>{setPhotos(prev=>[...prev,...results])});
    e.target.value="";
  };

  const removePhoto=(idx)=>setPhotos(prev=>prev.filter((_,i)=>i!==idx));

  const startAnalysis=()=>{
    if(!photos.length)return;
    if(!apiKey){setShowKeyInput(true);return;}
    setShowKeyInput(false);
    analyzePhotos();
  };

  const saveKey=(k)=>{setApiKey(k);try{localStorage.setItem("rl-anthropic-key",k)}catch(e){}fetch(SB_URL+"/rest/v1/settings",{method:"POST",headers:{...SB_H,"Prefer":"return=representation,resolution=merge-duplicates"},body:JSON.stringify({key:"anthropic_api_key",value:k})}).catch(()=>{})};

  const [annonceHtml,setAnnonceHtml]=useState("");
  const [showAnnonce,setShowAnnonce]=useState(false);

  const analyzePhotos=async()=>{
    if(!photos.length||!apiKey)return;
    setAnalyzing(true);setAnalyzeMsg("Analyse des photos en cours...");
    try{
      const imageContent=photos.map(p=>({type:"image",source:{type:"base64",media_type:"image/jpeg",data:p.data}}));
      const response=await fetch("https://api.anthropic.com/v1/messages",{
        method:"POST",headers:{"Content-Type":"application/json","x-api-key":apiKey,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},
        body:JSON.stringify({
          model:"claude-sonnet-4-20250514",max_tokens:4000,
          messages:[{role:"user",content:[
            ...imageContent,
            {type:"text",text:`Tu es un expert bibliophile spécialisé en livres anciens et rares. Analyse ces photos d'un livre ancien.

RÈGLE ABSOLUE : Si tu ne peux PAS identifier une information avec certitude à partir des photos, laisse le champ VIDE (string vide "", ou 0 pour les nombres, ou false pour les booléens). Ne devine JAMAIS. Il vaut mieux un champ vide qu'une information fausse.

ATTENTION SPÉCIALE SUR LA DATE : La date d'édition est CRITIQUE. Lis-la EXACTEMENT telle qu'elle est imprimée sur la page de titre. Ne la déduis PAS d'une préface, d'un privilège du roi ou d'une autre mention. Si plusieurs dates apparaissent, prends celle de la page de titre. Si la date est en chiffres romains, convertis-la avec soin. Si tu as le moindre doute, laisse le champ vide.

CATÉGORIE : Si les photos montrent un seul livre (un seul titre identifiable), remplis le champ "categorie" avec "Ouvrage".

Réponds UNIQUEMENT en JSON valide, sans texte avant/après, sans backticks markdown :
{
  "titre": "",
  "auteur": "",
  "date": "",
  "editeur": "",
  "lieuEdition": "",
  "categorie": "Ouvrage",
  "theme": "",
  "format": "",
  "eo": "",
  "etat": "",
  "caracSpec": {"frontispice":false,"gravures":false,"exLibris":false,"cartes":false,"illustrations":false},
  "prixConseille": 0,
  "titreEbay": "",
  "annonce": ""
}

CHAMPS :
- titre : le titre EXACT tel qu'il apparaît sur la page de titre. Si illisible, laisser vide.
- auteur : l'auteur tel qu'indiqué. Si absent ou illisible, laisser vide.
- date : l'année d'édition EXACTE visible sur la page de titre (ex: "1785"). ATTENTION : lis chaque chiffre avec soin. Ne confonds pas les caractères. Si absente ou illisible, laisser vide.
- editeur : le nom complet de l'éditeur/libraire si visible sur la page de titre (avec adresse si visible). Sinon vide.
- lieuEdition : la ville d'édition si visible (ex: "Paris", "Lyon"). Sinon vide.
- categorie : "Ouvrage" si un seul livre est identifié, sinon laisser vide.
- theme : UNE valeur parmi : "Art & architecture","Equitation","Histoire","Littérature","Divers","Poésie","Voyages","Religion","Sciences et mathématiques","Philosophie","Médecine","Droit","Nature et Chasse","Géographie","Dictionnaire","Enfants","Art","Voyage". Si impossible à déterminer, laisser vide.
- format : UNE valeur parmi : "In 32","In 18","In 16","In 12","In 8","In 4","In Folio". Déduis de la taille apparente. Si impossible, laisser vide.
- eo : "Oui" si c'est visiblement une édition originale (première édition de l'ouvrage), "Non" si ce n'est clairement pas le cas. Si tu as un doute, laisser vide.
- etat : UNE valeur parmi : "Excellent","Bon","Correct","Mauvais". Évalue l'état apparent du livre sur les photos. Si impossible, laisser vide.
- caracSpec : mettre true UNIQUEMENT si visible sur les photos.
- prixConseille : estimation du prix de vente en euros sur eBay pour un particulier. Prends en compte : le titre, l'auteur, la rareté, l'ancienneté, l'état, le format, le thème. Si c'est une édition originale, augmente significativement l'estimation. Si le champ completion indique que l'ouvrage est complet (ex: "4/4"), estime le prix pour l'ensemble complet même si les photos ne montrent qu'un volume. Si impossible, mettre 0.
- titreEbay : titre d'annonce eBay de 80 caractères MAX. Format : "[Titre court] - [Auteur] - [Éditeur] [Date] [E.O. si applicable]". Ex : "Marysienka Reine de Pologne 1641-1716 - Waliszewski - Plon 1898 E.O."
- annonce : annonce eBay au format HTML "Biblio-eBay" suivant EXACTEMENT ce modèle :

<div style="font-family:Georgia,serif;max-width:800px;margin:0 auto;color:#333;line-height:1.8">

<p style="font-size:12px;color:#888;margin-bottom:2px">Titre de l'annonce :</p>
<p style="font-size:20px;font-weight:bold;color:#333;margin-top:0;margin-bottom:24px">[titreEbay identique au champ titreEbay]</p>

<p style="text-align:center;letter-spacing:3px;color:#888;margin:20px 0">══════════════════════════════════</p>

<p style="margin-bottom:20px"><strong>État :</strong> [Excellent/Bon/Correct/Mauvais]. [Description précise des défauts observés sur les photos : rousseurs, usure du dos, coins frottés, déchirures, taches, etc. Si état excellent, indiquer "Très bel exemplaire, aucun défaut notable."]</p>

<p style="text-align:center;letter-spacing:3px;color:#888;margin:20px 0">══════════════════════════════════</p>

<p style="margin-bottom:14px"><strong>Titre :</strong> [titre complet tel qu'il figure sur la page de titre]</p>

<p style="margin-bottom:14px"><strong>Auteur :</strong> [auteur complet]</p>

<p style="margin-bottom:14px"><strong>Éditeur :</strong> [éditeur complet avec adresse si visible]</p>

<p style="margin-bottom:14px"><strong>Année :</strong> [date]</p>

<p style="margin-bottom:20px"><strong>Format :</strong> [format]. [Nombre de volumes si visible]. [Mentionner portraits, gravures, cartes si présents].</p>

<p style="margin-bottom:16px"><strong>[Description de la reliure — décrire le type de reliure observé sur les photos : plein cuir, demi-chagrin, broché, cartonnage, etc. avec détails sur le dos, les plats, les gardes]</strong></p>

<p style="margin-bottom:16px"><strong>[Si ex-libris visible, le mentionner ici]</strong></p>

<p style="margin-bottom:16px"><strong>[Si illustrations, gravures, cartes présentes, les détailler ici]</strong></p>

<p style="margin-bottom:16px">[Paragraphe de contextualisation du livre : présentation de l'ouvrage, de l'auteur, importance historique ou littéraire. 3-5 phrases savantes et informatives.]</p>

<p style="margin-bottom:20px">[Phrase indiquant à qui ce livre peut intéresser : "Intéressera les amateurs de..., les collectionneurs de..., les passionnés de..."]</p>

<p><strong>Envoi soigné en Colissimo.</strong></p>

</div>

IMPORTANT pour l'annonce :
- Les mots "Titre", "Auteur", "Éditeur", "Année", "Format", "État" doivent être en <strong>gras</strong>.
- La description de la reliure doit être un paragraphe en gras.
- Les caractéristiques spéciales (ex-libris, illustrations, gravures) doivent être en gras.
- Le paragraphe de contextualisation doit être savant et précis, pas générique.
- "Envoi soigné en Colissimo." toujours en gras à la fin.
- Aère bien l'annonce avec des marges entre chaque section.
- Si tu ne peux pas générer une annonce faute d'informations suffisantes, laisse le champ annonce vide.`}
          ]}]
        })
      });
      if(!response.ok){
        const errData=await response.json().catch(()=>({}));
        const errMsg=errData.error?.message||response.statusText||"Erreur inconnue";
        if(response.status===401){setAnalyzeMsg("✗ Clé API invalide. Vérifiez votre clé.");setShowKeyInput(true)}
        else if(response.status===403){setAnalyzeMsg("✗ Accès refusé. Vérifiez les permissions de votre clé.")}
        else if(response.status===429){setAnalyzeMsg("✗ Trop de requêtes. Attendez un instant.")}
        else if(response.status===400){setAnalyzeMsg("✗ Requête invalide: "+errMsg)}
        else{setAnalyzeMsg("✗ Erreur API ("+response.status+"): "+errMsg)}
        setAnalyzing(false);return;
      }
      const data=await response.json();
      if(!data.content||!data.content.length){setAnalyzeMsg("✗ Réponse vide de l'API");setAnalyzing(false);return}
      const text=data.content.map(i=>i.text||"").join("");
      const clean=text.replace(/```json|```/g,"").trim();
      let parsed;
      try{parsed=JSON.parse(clean)}catch(pe){console.error("JSON parse error:",clean);setAnalyzeMsg("✗ Réponse non-JSON. Réessayez.");setAnalyzing(false);return}
      setAnalyzeMsg("✓ Informations extraites !");
      if(parsed.titre)s("titre",parsed.titre);
      if(parsed.auteur)s("auteur",parsed.auteur);
      if(parsed.date)s("date",parsed.date);
      if(parsed.editeur)s("editeur",parsed.editeur);
      if(parsed.lieuEdition)s("lieuEdition",parsed.lieuEdition);
      if(parsed.theme)s("theme",parsed.theme);
      if(parsed.format)s("format",parsed.format);
      if(parsed.eo)s("eo",parsed.eo);
      if(parsed.etat)s("etat",parsed.etat);
      if(parsed.categorie)s("categorie",parsed.categorie);
      if(parsed.caracSpec){
        const cs=parsed.caracSpec;
        setF(p=>({...p,caracSpec:{...(p.caracSpec||{}),
          frontispice:cs.frontispice||false,gravures:cs.gravures||false,
          exLibris:cs.exLibris||false,cartes:cs.cartes||false,illustrations:cs.illustrations||false
        }}));
      }
      if(parsed.prixConseille&&parsed.prixConseille>0)s("prixConseilleIA",parsed.prixConseille);
      if(parsed.annonce)setAnnonceHtml(parsed.annonce);
      setTimeout(()=>setAnalyzeMsg(""),6000);
    }catch(err){
      console.error("Erreur analyse:",err);
      if(err.message&&err.message.includes("Failed to fetch")){setAnalyzeMsg("✗ Connexion impossible. Vérifiez votre connexion internet.")}
      else{setAnalyzeMsg("✗ Erreur: "+err.message)}
    }
    setAnalyzing(false);
  };

  const generateAnnonceFromForm=async()=>{
    if(!f.titre.trim()){setFormErr("Remplissez au moins le titre pour générer l'annonce.");return}
    if(!apiKey){setShowKeyInput(true);setFormErr("Clé API requise pour générer l'annonce.");return}
    setAnalyzing(true);setAnalyzeMsg("Génération de l'annonce...");
    try{
      const cs=f.caracSpec||{};
      const specs=Object.entries({frontispice:"Frontispice",gravures:"Gravures",exLibris:"Ex-libris",cartes:"Cartes",illustrations:"Illustrations"}).filter(([k])=>cs[k]).map(([,v])=>v);
      const prompt=`Tu es un expert bibliophile. Génère une annonce eBay pour ce livre ancien à partir des informations suivantes.

Titre : ${f.titre||"non renseigné"}
Auteur : ${f.auteur||"non renseigné"}
Date : ${f.date||"non renseignée"}
Éditeur : ${f.editeur||"non renseigné"}
Lieu d'édition : ${f.lieuEdition||"non renseigné"}
Format : ${f.format||"non renseigné"}
État : ${f.etat||"non renseigné"}
EO : ${f.eo||"Non"}
Caractéristiques spéciales : ${specs.length?specs.join(", "):"aucune"}

RÈGLE : Ne mentionne dans l'annonce QUE les informations fournies ci-dessus. N'invente aucune information manquante (reliure, nombre de pages, etc.). Si un champ est "non renseigné", ne le mentionne pas du tout dans l'annonce.

Réponds UNIQUEMENT en JSON valide, sans backticks :
{"titreEbay":"","annonce":""}

- titreEbay : 80 caractères MAX. Format : "[Titre court] - [Auteur] - [Éditeur] [Date] [E.O. si applicable]"
- annonce : HTML au format Biblio-eBay suivant exactement ce modèle (n'inclus que les champs renseignés) :

<div style="font-family:Georgia,serif;max-width:800px;margin:0 auto;color:#333;line-height:1.8">
<p style="font-size:12px;color:#888;margin-bottom:2px">Titre de l'annonce :</p>
<p style="font-size:20px;font-weight:bold;color:#333;margin-top:0;margin-bottom:24px">[titreEbay]</p>
<p style="text-align:center;letter-spacing:3px;color:#888;margin:20px 0">══════════════════════════════════</p>
<p style="margin-bottom:20px"><strong>État :</strong> [état si renseigné].</p>
<p style="text-align:center;letter-spacing:3px;color:#888;margin:20px 0">══════════════════════════════════</p>
<p style="margin-bottom:14px"><strong>Titre :</strong> [titre]</p>
<p style="margin-bottom:14px"><strong>Auteur :</strong> [auteur]</p>
<p style="margin-bottom:14px"><strong>Éditeur :</strong> [éditeur, lieu]</p>
<p style="margin-bottom:14px"><strong>Année :</strong> [date]</p>
<p style="margin-bottom:20px"><strong>Format :</strong> [format]</p>
[Si caractéristiques spéciales: <p style="margin-bottom:16px"><strong>[les lister en gras]</strong></p>]
<p style="margin-bottom:16px">[Contextualisation savante du livre, auteur, importance. 3-5 phrases. Basée uniquement sur tes connaissances de l'ouvrage.]</p>
<p style="margin-bottom:20px">[Intéressera les amateurs de...]</p>
<p><strong>Envoi soigné en Colissimo.</strong></p>
</div>`;
      const response=await fetch("https://api.anthropic.com/v1/messages",{
        method:"POST",headers:{"Content-Type":"application/json","x-api-key":apiKey,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},
        body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:3000,messages:[{role:"user",content:prompt}]})
      });
      if(!response.ok){const errData=await response.json().catch(()=>({}));setAnalyzeMsg("✗ Erreur API ("+response.status+"): "+(errData.error?.message||""));setAnalyzing(false);return}
      const data=await response.json();
      const text=data.content.map(i=>i.text||"").join("");
      const clean=text.replace(/```json|```/g,"").trim();
      let parsed;
      try{parsed=JSON.parse(clean)}catch(pe){setAnalyzeMsg("✗ Réponse non-JSON. Réessayez.");setAnalyzing(false);return}
      if(parsed.annonce){setAnnonceHtml(parsed.annonce);setShowAnnonce(true);setAnalyzeMsg("✓ Annonce générée !")}
      else{setAnalyzeMsg("✗ Impossible de générer l'annonce.")}
      setTimeout(()=>setAnalyzeMsg(""),6000);
    }catch(err){setAnalyzeMsg("✗ Erreur: "+err.message)}
    setAnalyzing(false);
  };

  const FORM_TABS=[{key:"carac",label:"Caractéristiques",icon:"📋"},{key:"achat",label:"Achat",icon:"🛒"},{key:"publication",label:"Publication",icon:"📢"},{key:"vente",label:"Vente",icon:"💰"}];

  return(<div style={{display:"flex",flexDirection:"column",gap:0}}>
    {/* Camera Section */}
    <div style={{display:"flex",flexDirection:"column",alignItems:"center",gap:10,marginBottom:16,padding:"16px 0",borderBottom:"1px solid #1e2d4a"}}>
      <div style={{display:"flex",gap:10,alignItems:"center"}}>
      <button onClick={openCamera} title="Prendre une photo" style={{width:56,height:56,borderRadius:12,background:"linear-gradient(135deg,#111d35,#0e1628)",border:"1.5px solid #1e3050",color:"#5a8abf",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",transition:"all .25s"}}
        onMouseEnter={e=>{e.currentTarget.style.borderColor="#4a8af8";e.currentTarget.style.background="linear-gradient(135deg,#152545,#112040)";e.currentTarget.style.color="#8ab4f8"}}
        onMouseLeave={e=>{e.currentTarget.style.borderColor="#1e3050";e.currentTarget.style.background="linear-gradient(135deg,#111d35,#0e1628)";e.currentTarget.style.color="#5a8abf"}}>
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
      </button>
      <button onClick={()=>openFolderPicker(false)} title={dirName?"Ouvrir "+dirName:"Dossier photos (iCloud)"} style={{width:56,height:56,borderRadius:12,background:dirHandle?"linear-gradient(135deg,#1a2535,#152030)":"linear-gradient(135deg,#111d35,#0e1628)",border:dirHandle?"1.5px solid #2a4a6a":"1.5px solid #1e3050",color:dirHandle?"#8ab4f8":"#5a8abf",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:0,transition:"all .25s",position:"relative"}}
        onMouseEnter={e=>{e.currentTarget.style.borderColor="#4a8af8";e.currentTarget.style.background="linear-gradient(135deg,#152545,#112040)";e.currentTarget.style.color="#8ab4f8"}}
        onMouseLeave={e=>{e.currentTarget.style.borderColor=dirHandle?"#2a4a6a":"#1e3050";e.currentTarget.style.background=dirHandle?"linear-gradient(135deg,#1a2535,#152030)":"linear-gradient(135deg,#111d35,#0e1628)";e.currentTarget.style.color=dirHandle?"#8ab4f8":"#5a8abf"}}>
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
        {dirName&&<span style={{fontSize:7,marginTop:1,opacity:.7,fontFamily:"'JetBrains Mono',monospace",maxWidth:52,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{dirName}</span>}
      </button>
      </div>
      <input ref={fileRef} type="file" accept="image/*" capture="environment" multiple style={{display:"none"}} onChange={handleCapture}/>
      <input ref={galleryRef} type="file" accept="image/*" multiple style={{display:"none"}} onChange={handleCapture}/>
      <canvas ref={canvasRef} style={{display:"none"}}/>
      {/* ─── iCloud Dossier Picker Modal ─── */}
      {showDirPicker&&<div onClick={()=>{setShowDirPicker(false);setDirSelected(new Set())}} style={{position:"fixed",inset:0,background:"rgba(0,0,0,.8)",backdropFilter:"blur(10px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:2000,padding:12}}>
        <div onClick={e=>e.stopPropagation()} style={{background:"linear-gradient(180deg,#0f1629,#0a0f1e)",border:"1px solid #1e2d4a",borderRadius:16,padding:20,width:"100%",maxWidth:860,maxHeight:"90vh",display:"flex",flexDirection:"column"}}>
          {/* Header */}
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:14,gap:12}}>
            <div style={{flex:1}}>
              <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:4}}>
                <span style={{fontSize:20}}>☁️</span>
                <h3 style={{margin:0,fontSize:17,color:"#e6f1ff",fontFamily:"'Playfair Display',serif"}}>{dirName||"iCloud Photos"}</h3>
              </div>
              <div style={{fontSize:11,color:"#4a5a7a",fontFamily:"'JetBrains Mono',monospace"}}>
                {dirFiles.length} photo{dirFiles.length>1?"s":""}{dirSelected.size>0&&<span style={{color:"#c9a84c",fontWeight:600}}> · {dirSelected.size} sélectionnée{dirSelected.size>1?"s":""}</span>}
              </div>
            </div>
            <div style={{display:"flex",gap:6,alignItems:"center",flexShrink:0}}>
              {dirFiles.length>0&&<button onClick={selectAllDir} style={{...btnS,padding:"6px 10px",fontSize:10}}>{dirSelected.size===dirFiles.length?"Désélectionner":"Tout"}</button>}
              <button onClick={()=>openFolderPicker(true)} style={{...btnS,padding:"6px 10px",fontSize:10}}>📁 Changer</button>
              <button onClick={()=>{setShowDirPicker(false);setDirSelected(new Set())}} style={{background:"none",border:"none",color:"#5a6a8a",fontSize:22,cursor:"pointer",padding:"0 4px"}}>✕</button>
            </div>
          </div>
          {dirError&&<div style={{padding:"10px 14px",background:"rgba(201,76,76,.1)",border:"1px solid rgba(201,76,76,.3)",borderRadius:8,color:"#c94c4c",fontSize:12,fontFamily:"'JetBrains Mono',monospace",marginBottom:12}}>{dirError}</div>}
          {/* Grid */}
          {dirLoading?<div style={{display:"flex",alignItems:"center",justifyContent:"center",padding:80,gap:12}}>
            <span style={{display:"inline-block",width:20,height:20,border:"2px solid #c9a84c",borderTop:"2px solid transparent",borderRadius:"50%",animation:"spin 1s linear infinite"}}/>
            <span style={{color:"#8892b0",fontSize:13,fontFamily:"'JetBrains Mono',monospace"}}>Chargement...</span>
          </div>
          :<div style={{flex:1,overflowY:"auto",overflowX:"hidden",marginBottom:14}}>
            <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(150px,1fr))",gap:10,padding:2}}>
              {dirFiles.map((item)=>{
                const sel=dirSelected.has(item.name);
                const preview=dirPreviews[item.name];
                const d=new Date(item.lastModified);
                const dateStr=d.toLocaleDateString("fr-FR",{day:"numeric",month:"short"})+" "+d.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"});
                return(<div key={item.name} onClick={()=>toggleDirFile(item.name)} style={{position:"relative",aspectRatio:"1",borderRadius:10,overflow:"hidden",cursor:"pointer",border:sel?"3px solid #c9a84c":"3px solid transparent",boxShadow:sel?"0 0 16px rgba(201,168,76,.25)":"none",transform:sel?"scale(0.97)":"scale(1)",transition:"all .15s ease"}}>
                  {preview?<img src={preview} style={{width:"100%",height:"100%",objectFit:"cover",display:"block"}} alt={item.name}/>
                  :<div style={{width:"100%",height:"100%",background:"linear-gradient(135deg,#1a2540,#0f1a2e)",display:"flex",alignItems:"center",justifyContent:"center"}}>
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#2a3a5a" strokeWidth="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                  </div>}
                  {/* Sélection badge */}
                  {sel&&<div style={{position:"absolute",top:6,right:6,width:26,height:26,borderRadius:7,background:"#c9a84c",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 2px 8px rgba(0,0,0,.5)"}}>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#0a0f1e" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>
                  </div>}
                  {/* Date overlay */}
                  <div style={{position:"absolute",bottom:0,left:0,right:0,background:"linear-gradient(transparent,rgba(0,0,0,.8))",padding:"16px 6px 5px",fontSize:9,color:"rgba(255,255,255,.7)",fontFamily:"'JetBrains Mono',monospace",textAlign:"center"}}>{dateStr}</div>
                </div>);
              })}
              {dirFiles.length===0&&!dirLoading&&<div style={{gridColumn:"1/-1",textAlign:"center",padding:60,color:"#3a4a6a"}}>
                <div style={{fontSize:32,marginBottom:12}}>📂</div>
                <div style={{fontStyle:"italic",fontSize:13}}>Aucune photo dans ce dossier</div>
                <button onClick={()=>openFolderPicker(true)} style={{...btnS,marginTop:16,padding:"8px 16px",fontSize:11}}>Choisir un autre dossier</button>
              </div>}
            </div>
          </div>}
          {/* Footer */}
          {dirFiles.length>0&&!dirLoading&&<div style={{display:"flex",justifyContent:"space-between",alignItems:"center",paddingTop:12,borderTop:"1px solid #1a2540"}}>
            <div style={{fontSize:10,color:"#3a4a6a",fontFamily:"'JetBrains Mono',monospace"}}>
              💡 La 1ère fois, naviguez vers <span style={{color:"#5a7a9a"}}>C:\Users\…\iCloudPhotos</span> — ensuite ça s'en souvient
            </div>
            <button onClick={importSelectedFromDir} disabled={!dirSelected.size} style={{...btnP,padding:"11px 24px",fontSize:13,opacity:dirSelected.size?1:.35,transition:"opacity .2s"}}>
              Importer{dirSelected.size>0&&(" "+dirSelected.size)} photo{dirSelected.size>1?"s":""}
            </button>
          </div>}
        </div>
      </div>}
      {cameraOpen&&<div style={{width:"100%",borderRadius:12,overflow:"hidden",border:"1px solid #1e3050",marginBottom:12,position:"relative",background:"#000"}}>
        <video ref={videoRef} autoPlay playsInline muted style={{width:"100%",maxHeight:300,objectFit:"cover",display:"block"}}/>
        <div style={{position:"absolute",bottom:12,left:0,right:0,display:"flex",justifyContent:"center",gap:16}}>
          <button onClick={takePhoto} style={{width:52,height:52,borderRadius:"50%",background:"#fff",border:"3px solid #ccc",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 2px 12px rgba(0,0,0,.4)"}} title="Prendre la photo"><div style={{width:40,height:40,borderRadius:"50%",background:"#fff",border:"2px solid #ddd"}}/></button>
          <button onClick={closeCamera} style={{width:42,height:42,borderRadius:"50%",background:"rgba(200,60,60,.85)",border:"none",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontSize:18,fontWeight:700}} title="Fermer">✕</button>
        </div>
      </div>}
      {photos.length>0&&<div style={{display:"flex",gap:10,flexWrap:"wrap",justifyContent:"center",marginBottom:10}}>
        {photos.map((p,i)=>(<div key={i} style={{position:"relative",width:72,height:72,borderRadius:8,overflow:"hidden",border:"1px solid #1e2d4a"}}>
          <img src={p.preview} style={{width:"100%",height:"100%",objectFit:"cover"}}/>
          <button onClick={()=>removePhoto(i)} style={{position:"absolute",top:2,right:2,background:"rgba(0,0,0,.75)",border:"none",color:"#c94c4c",fontSize:13,cursor:"pointer",borderRadius:"50%",width:18,height:18,display:"flex",alignItems:"center",justifyContent:"center",padding:0,lineHeight:1}}>✕</button>
        </div>))}
      </div>}
      {photos.length>0&&<div style={{display:"flex",flexDirection:"column",alignItems:"center",gap:8}}>
        <button onClick={startAnalysis} disabled={analyzing} style={{...btnP,padding:"10px 20px",opacity:analyzing?.6:1,display:"flex",alignItems:"center",gap:8,fontSize:12}}>
        {analyzing?<span style={{display:"inline-block",width:14,height:14,border:"2px solid #0a0f1e",borderTop:"2px solid transparent",borderRadius:"50%",animation:"spin 1s linear infinite"}}/>:
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>}
        {analyzing?"Analyse en cours...":"Analyser "+photos.length+" photo"+(photos.length>1?"s":"")}
        </button>
        {showKeyInput&&<div style={{display:"flex",flexDirection:"column",alignItems:"center",gap:6,marginTop:4,width:"100%",maxWidth:400}}>
          <div style={{fontSize:11,color:"#6a8aaa",fontFamily:"'JetBrains Mono',monospace",textAlign:"center"}}>Clé API Anthropic requise :</div>
          <div style={{display:"flex",gap:8,width:"100%"}}>
            <input style={{...inp,flex:1,fontSize:12}} type="password" placeholder="sk-ant-..." value={apiKey} onChange={e=>saveKey(e.target.value)}/>
            <button onClick={()=>{if(apiKey){setShowKeyInput(false);analyzePhotos()}}} style={{...btnP,padding:"8px 16px",fontSize:11,whiteSpace:"nowrap"}}>OK</button>
          </div>
          <div style={{fontSize:10,color:"#3a4a6a",fontFamily:"'JetBrains Mono',monospace",textAlign:"center"}}>Synchronisée sur tous vos appareils. <span style={{cursor:"pointer",color:"#c94c4c"}} onClick={()=>{saveKey("");setShowKeyInput(false)}}>Effacer</span></div>
        </div>}
      </div>}
      {analyzeMsg&&<div style={{fontSize:12,fontFamily:"'JetBrains Mono',monospace",color:analyzeMsg.startsWith("✓")?"#4cc98c":analyzeMsg.startsWith("✗")?"#c94c4c":"#8ab4f8",padding:"6px 0",textAlign:"center"}}>{analyzeMsg}</div>}
    </div>
    <style>{`@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}`}</style>

    {/* Tab bar */}
    <div style={{display:"flex",gap:3,background:"#0a0f1e",borderRadius:10,padding:3,border:"1px solid #1a2540",marginBottom:18}}>
      {FORM_TABS.map(t=>(<button key={t.key} onClick={()=>setFormTab(t.key)} style={{flex:1,padding:"9px 8px",border:"none",borderRadius:8,background:formTab===t.key?"linear-gradient(135deg,#c9a84c22,#c9a84c11)":"transparent",color:formTab===t.key?"#c9a84c":"#4a5a7a",fontSize:11,fontWeight:600,cursor:"pointer",fontFamily:"'JetBrains Mono',monospace",transition:"all .2s"}}><span style={{marginRight:4}}>{t.icon}</span>{t.label}</button>))}
    </div>

    {/* ONGLET CARACTÉRISTIQUES */}
    {formTab==="carac"&&<div style={{display:"flex",flexWrap:"wrap",gap:"0 14px",minHeight:480,alignContent:"flex-start"}}>
    <div style={{width:"100%",textAlign:"center",marginBottom:10}}><span style={{fontSize:13,fontFamily:"'JetBrains Mono',monospace",color:"#c9a84c",fontWeight:600}}>{f.numAchat?("Vente n°"+f.numAchat):"Aucune vente"}</span>{f.dateAchat&&<span style={{fontSize:11,color:"#5a6a8a",fontFamily:"'JetBrains Mono',monospace"}}> — {fmtD(f.dateAchat)}</span>}</div>
    <Field label="Titre ✱" w="1 1 100%"><input style={{...inp,borderColor:formErr&&!f.titre.trim()?"#c94c4c":undefined}} value={f.titre} onChange={e=>{s("titre",e.target.value);setFormErr("")}}/></Field>
    <Field label="Auteur"><input style={inp} value={f.auteur} onChange={e=>s("auteur",e.target.value)}/></Field>
    <Field label="Date d'édition"><input style={inp} value={f.date} onChange={e=>s("date",e.target.value)}/></Field>
    <Field label="Éditeur"><input style={inp} value={f.editeur} onChange={e=>s("editeur",e.target.value)}/></Field>
    <Field label="Lieu d'édition"><input style={inp} value={f.lieuEdition||""} onChange={e=>s("lieuEdition",e.target.value)}/></Field>
    <Field label="Catégorie"><select style={sel} value={f.categorie} onChange={e=>s("categorie",e.target.value)}><option value="">—</option>{CATEGORIES.map(x=><option key={x}>{x}</option>)}</select></Field>
    <Field label="Complétion"><select style={sel} value={f.completion} onChange={e=>s("completion",e.target.value)}><option value="Oui">Oui</option><option value="Non">Non</option></select></Field>
    <Field label="EO"><select style={sel} value={f.eo} onChange={e=>s("eo",e.target.value)}><option value="">—</option>{EO_VALS.map(x=><option key={x}>{x}</option>)}</select></Field>
    <Field label="Thème"><select style={sel} value={f.theme} onChange={e=>s("theme",e.target.value)}><option value="">—</option>{THEMES.map(x=><option key={x}>{x}</option>)}</select></Field>
    <Field label="État"><select style={sel} value={f.etat} onChange={e=>s("etat",e.target.value)}><option value="">—</option>{ETATS.map(x=><option key={x}>{x}</option>)}</select></Field>
    <Field label="Format"><select style={sel} value={f.format} onChange={e=>s("format",e.target.value)}><option value="">—</option>{FORMATS.map(x=><option key={x}>{x}</option>)}</select></Field>
    <Field label="Nb vol"><input style={inp} type="number" value={f.nbVol} onChange={e=>s("nbVol",e.target.value===""?"":+e.target.value)}/></Field>
    <Field label="Nb pages"><input style={inp} type="number" value={f.nbPages||""} onChange={e=>s("nbPages",e.target.value===""?"":+e.target.value)}/></Field>
    <Field label="Poids (Kg)"><input style={inp} type="number" step="0.001" value={f.poids} onChange={e=>s("poids",e.target.value===""?"":+e.target.value)}/></Field>
    <Field label="Stockage"><input style={inp} value={f.stockage} onChange={e=>s("stockage",e.target.value)}/></Field>
    <div style={{width:"100%",marginBottom:14,marginTop:6}}>
      <label style={{display:"block",fontSize:10,textTransform:"uppercase",letterSpacing:1.5,color:"#5a7a9a",marginBottom:10,fontFamily:"'JetBrains Mono',monospace"}}>Caractéristiques spéciales</label>
      <div style={{display:"flex",gap:18,flexWrap:"wrap"}}>
        {[["frontispice","Frontispice"],["gravures","Gravures"],["exLibris","Ex libris"],["cartes","Cartes"],["illustrations","Illustrations"]].map(([k,label])=>(
          <label key={k} style={{display:"flex",alignItems:"center",gap:7,cursor:"pointer",fontSize:13,color:(f.caracSpec||{})[k]?"#c9a84c":"#4a5a7a"}}>
            <div onClick={()=>toggleSpec(k)} style={{width:20,height:20,borderRadius:5,border:(f.caracSpec||{})[k]?"2px solid #c9a84c":"2px solid #2a3a5a",background:(f.caracSpec||{})[k]?"#c9a84c":"transparent",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",transition:"all .2s"}}>
              {(f.caracSpec||{})[k]&&<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#0a0f1e" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>}
            </div>{label}
          </label>
        ))}
      </div>
    </div>
    <Field label="Notes / Divers" w="1 1 100%"><textarea style={{...inp,minHeight:80,resize:"vertical"}} value={f.notes||""} onChange={e=>s("notes",e.target.value)} placeholder="Informations libres, remarques, provenance..."/></Field>
    </div>}

    {/* ONGLET ACHAT */}
    {formTab==="achat"&&<div style={{display:"flex",flexWrap:"wrap",gap:"0 14px",minHeight:480,alignContent:"flex-start"}}>
    <Field label="N° achat ✱"><select style={{...sel,borderColor:formErr&&!f.numAchat?"#c94c4c":undefined}} value={f.numAchat} onChange={e=>selectVente(e.target.value)}><option value="">—</option>{venteNums.map(n=><option key={n} value={n}>Achat n°{n}{venteDates[n]?" — "+venteDates[n]:venteInfo[n]?" — "+fmtD(venteInfo[n].date):""}</option>)}</select></Field>
    <Field label="Date achat"><input style={{...inp,color:"#8892b0"}} type="date" value={f.dateAchat} readOnly/></Field>
    <Field label="Lieu achat"><input style={{...inp,color:"#8892b0"}} value={f.lieuAchat} readOnly/></Field>
    <Field label="Prix achat (€) ↻"><input style={{...inp,color:"#8892b0",fontStyle:"italic"}} type="number" step="0.01" value={f.pxAchat} readOnly title="Calculé automatiquement"/></Field>
    </div>}

    {/* ONGLET PUBLICATION */}
    {formTab==="publication"&&<div style={{display:"flex",flexWrap:"wrap",gap:"0 14px",minHeight:480,alignContent:"flex-start"}}>
    <div style={{display:"flex",justifyContent:"center",gap:14,flexBasis:"100%",marginBottom:20}}>
      <button onClick={()=>{window.open("https://www.abebooks.fr/servlet/SearchResults?tn="+encodeURIComponent(f.titre||""),"_blank")}} style={{...btnS,padding:"6px 12px",fontSize:10,whiteSpace:"nowrap",display:"flex",alignItems:"center",gap:5,background:"#1a1a2e",borderColor:"#c41e1e"}}><span style={{color:"#c41e1e",fontWeight:700}}>Ab</span> Estimer</button>
      <button onClick={()=>{window.open("https://www.ebay.fr/sch/i.html?_nkw="+encodeURIComponent(f.titre||"")+"&LH_Complete=1&LH_Sold=1&_sop=1","_blank")}} style={{...btnS,padding:"6px 12px",fontSize:10,whiteSpace:"nowrap",display:"flex",alignItems:"center",gap:5,background:"#1a1a2e",borderColor:"#e53238"}}><span style={{fontWeight:700}}><span style={{color:"#e53238"}}>e</span><span style={{color:"#0064d2"}}>b</span><span style={{color:"#f5af02"}}>a</span><span style={{color:"#86b817"}}>y</span></span> Estimer</button>
    </div>
    <div style={{flexBasis:"100%",marginBottom:8}}><Field label="Prix conseillé (IA)" w="0 0 auto"><div style={{position:"relative",width:130}}><input style={{...inp,color:"#8892b0",fontStyle:"italic",paddingRight:28,width:"100%"}} value={f.prixConseilleIA||"—"} readOnly/><span style={{position:"absolute",right:10,top:"50%",transform:"translateY(-50%)",color:"#5a6a8a",fontSize:13,fontFamily:"'JetBrains Mono',monospace",pointerEvents:"none"}}>€</span></div></Field></div>
    <div style={{flexBasis:"100%",marginBottom:8}}><Field label="Px mise en vente" w="0 0 auto"><div style={{position:"relative",width:130}}><input style={{...inp,paddingRight:28,width:"100%"}} type="number" step="0.01" value={f.pxMiseEnVente} onChange={e=>s("pxMiseEnVente",e.target.value===""?"":+e.target.value)}/><span style={{position:"absolute",right:10,top:"50%",transform:"translateY(-50%)",color:"#5a6a8a",fontSize:13,fontFamily:"'JetBrains Mono',monospace",pointerEvents:"none"}}>€</span></div></Field></div>
    <div style={{width:"100%",marginBottom:18,marginTop:8}}>
      <label style={{display:"block",fontSize:10,textTransform:"uppercase",letterSpacing:1.5,color:"#5a7a9a",marginBottom:10,fontFamily:"'JetBrains Mono',monospace"}}>Publication de l'annonce</label>
      <div style={{display:"flex",gap:20}}>
        <label style={{display:"flex",alignItems:"center",gap:8,cursor:"pointer",fontSize:13,color:f.publie==="Oui"?"#4cc98c":"#5a6a8a"}}>
          <div onClick={()=>{s("publie","Oui");if(!f.dateMiseEnVente)s("dateMiseEnVente",new Date().toISOString().slice(0,10))}} style={{width:20,height:20,borderRadius:6,border:f.publie==="Oui"?"2px solid #4cc98c":"2px solid #2a3a5a",background:f.publie==="Oui"?"#4cc98c":"transparent",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",transition:"all .2s"}}>
            {f.publie==="Oui"&&<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#0a0f1e" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>}
          </div>Oui
        </label>
        <label style={{display:"flex",alignItems:"center",gap:8,cursor:"pointer",fontSize:13,color:f.publie!=="Oui"?"#c9a84c":"#5a6a8a"}}>
          <div onClick={()=>{s("publie","Non");s("dateMiseEnVente","")}} style={{width:20,height:20,borderRadius:6,border:f.publie!=="Oui"?"2px solid #c9a84c":"2px solid #2a3a5a",background:f.publie!=="Oui"?"#c9a84c":"transparent",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",transition:"all .2s"}}>
            {f.publie!=="Oui"&&<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#0a0f1e" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>}
          </div>Non
        </label>
      </div>
    </div>
    {f.publie==="Oui"&&<div style={{flexBasis:"100%",marginBottom:8}}><Field label="Date mise en vente"><input style={{...inp,cursor:"pointer"}} type="date" value={f.dateMiseEnVente||""} onClick={e=>{try{e.target.showPicker()}catch(ex){}}} onChange={e=>s("dateMiseEnVente",e.target.value)}/></Field></div>}
    <div style={{width:"100%",marginTop:16,display:"flex",justifyContent:"center"}}>
      <button style={{...btnS,padding:"10px 18px",fontSize:12,display:"flex",alignItems:"center",gap:6,opacity:analyzing?.5:1}} disabled={analyzing} onClick={()=>{if(annonceHtml){setShowAnnonce(true)}else{generateAnnonceFromForm()}}}><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg> Afficher l'annonce</button>
    </div>
    </div>}

    {/* ONGLET VENTE */}
    {formTab==="vente"&&<div style={{display:"flex",flexWrap:"wrap",gap:"0 14px",minHeight:480,alignContent:"flex-start"}}>
    <div style={{width:"100%",marginBottom:16}}>
      <label style={{display:"block",fontSize:10,textTransform:"uppercase",letterSpacing:1.5,color:"#5a7a9a",marginBottom:10,fontFamily:"'JetBrains Mono',monospace"}}>Vente du livre</label>
      <div style={{display:"flex",gap:20}}>
        <label style={{display:"flex",alignItems:"center",gap:8,cursor:"pointer",fontSize:13,color:f.vendu==="Oui"?"#4cc98c":"#5a6a8a"}}>
          <div onClick={()=>s("vendu","Oui")} style={{width:20,height:20,borderRadius:6,border:f.vendu==="Oui"?"2px solid #4cc98c":"2px solid #2a3a5a",background:f.vendu==="Oui"?"#4cc98c":"transparent",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",transition:"all .2s"}}>
            {f.vendu==="Oui"&&<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#0a0f1e" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>}
          </div>Oui
        </label>
        <label style={{display:"flex",alignItems:"center",gap:8,cursor:"pointer",fontSize:13,color:f.vendu!=="Oui"?"#c9a84c":"#5a6a8a"}}>
          <div onClick={()=>{s("vendu","Non");s("pxEncaisse","");s("dateVente","");s("dateLivraison","");s("modeLivraison","");s("fraisExpedition","")}} style={{width:20,height:20,borderRadius:6,border:f.vendu!=="Oui"?"2px solid #c9a84c":"2px solid #2a3a5a",background:f.vendu!=="Oui"?"#c9a84c":"transparent",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",transition:"all .2s"}}>
            {f.vendu!=="Oui"&&<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#0a0f1e" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>}
          </div>Non
        </label>
      </div>
    </div>
    {f.vendu==="Oui"&&<>
    <Field label="Date de vente"><input style={{...inp,cursor:"pointer"}} type="date" value={f.dateVente||""} onClick={e=>{try{e.target.showPicker()}catch(ex){}}} onChange={e=>s("dateVente",e.target.value)}/></Field>
    <Field label="Prix de vente (€)"><div style={{position:"relative"}}><input style={{...inp,paddingRight:28}} type="number" step="0.01" value={f.pxEncaisse} onChange={e=>s("pxEncaisse",e.target.value===""?"":+e.target.value)}/><span style={{position:"absolute",right:10,top:"50%",transform:"translateY(-50%)",color:"#5a6a8a",fontSize:13,fontFamily:"'JetBrains Mono',monospace",pointerEvents:"none"}}>€</span></div></Field>
    <Field label="Commissions de vente (€)"><div style={{position:"relative"}}><input style={{...inp,paddingRight:28}} type="number" step="0.01" value={f.commissionVente||""} onChange={e=>s("commissionVente",e.target.value===""?"":+e.target.value)}/><span style={{position:"absolute",right:10,top:"50%",transform:"translateY(-50%)",color:"#5a6a8a",fontSize:13,fontFamily:"'JetBrains Mono',monospace",pointerEvents:"none"}}>€</span></div></Field>
    <Field label="Prix de vente net (€)"><div style={{position:"relative"}}><input style={{...inp,paddingRight:28,color:"#4cc98c",fontWeight:600}} value={((f.pxEncaisse||0)-(f.commissionVente||0)).toFixed(2)} readOnly/><span style={{position:"absolute",right:10,top:"50%",transform:"translateY(-50%)",color:"#5a6a8a",fontSize:13,fontFamily:"'JetBrains Mono',monospace",pointerEvents:"none"}}>€</span></div></Field>
    <Field label="Date de livraison"><input style={{...inp,cursor:"pointer"}} type="date" value={f.dateLivraison||""} onClick={e=>{try{e.target.showPicker()}catch(ex){}}} onChange={e=>s("dateLivraison",e.target.value)}/></Field>
    <Field label="Mode de livraison"><select style={sel} value={f.modeLivraison||""} onChange={e=>s("modeLivraison",e.target.value)}><option value="">—</option><option>Colissimo</option><option>Courrier</option><option>Mondial Relay</option><option>Autre</option></select></Field>
    <Field label="Frais d'envoi du livre (€)" w="0 0 auto"><div style={{position:"relative",width:130}}><input style={{...inp,paddingRight:28,width:"100%"}} type="number" step="0.01" value={f.fraisExpedition} onChange={e=>s("fraisExpedition",e.target.value===""?"":+e.target.value)}/><span style={{position:"absolute",right:10,top:"50%",transform:"translateY(-50%)",color:"#5a6a8a",fontSize:13,fontFamily:"'JetBrains Mono',monospace",pointerEvents:"none"}}>€</span></div></Field>
    </>}
    </div>}

    {/* ERREUR + ACTIONS */}
    {formErr&&<div style={{width:"100%",padding:"10px 14px",background:"rgba(201,76,76,.1)",border:"1px solid rgba(201,76,76,.3)",borderRadius:8,color:"#c94c4c",fontSize:12,fontFamily:"'JetBrains Mono',monospace",marginTop:4}}>{formErr}</div>}
    <div style={{display:"flex",gap:12,width:"100%",justifyContent:"flex-end",alignItems:"center",marginTop:14}}>
      <button style={btnS} onClick={onCancel}>Annuler</button>
      <button style={btnP} onClick={handleSave}>{book?"Modifier":"Ajouter"}</button>
    </div>
    {showAnnonce&&<div onClick={()=>setShowAnnonce(false)} style={{position:"fixed",inset:0,background:"rgba(0,0,0,.75)",backdropFilter:"blur(6px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:2000,padding:16}}>
      <div onClick={e=>e.stopPropagation()} style={{background:"#fff",borderRadius:14,padding:28,width:"100%",maxWidth:820,maxHeight:"90vh",overflowY:"auto",position:"relative"}}>
        <button onClick={()=>setShowAnnonce(false)} style={{position:"absolute",top:12,right:16,background:"none",border:"none",fontSize:22,cursor:"pointer",color:"#666"}}>✕</button>
        <div style={{marginBottom:16,display:"flex",gap:10,justifyContent:"flex-end",paddingTop:4}}>
          <button onClick={()=>{navigator.clipboard.writeText(annonceHtml);setFormErr("");setAnalyzeMsg("✓ HTML copié !")}} style={{...btnS,fontSize:11,padding:"6px 14px",color:"#333",borderColor:"#ccc"}}>📋 Copier HTML</button>
        </div>
        <div dangerouslySetInnerHTML={{__html:annonceHtml}}/>
      </div>
    </div>}
  </div>);
};

function exportCSV(books){const h=["N°","Titre","Auteur","Date","Éditeur","Complétion","Catégorie","Nb vol","Siècle","EO","Thème","État","Format","Poids","Stockage","N° achat","Date achat","Px achat","Total achat","Lieu achat","Publié","Vendu","Date mise en vente","Date vente","Durée vente","Px mise en vente","Px encaissé","Modalités","Livré","Frais expédition","Bénéf attendu","Bénéf réalisé","Différence"];const rows=books.map(b=>[b.id,b.titre,b.auteur,b.date,b.editeur,b.completion,b.categorie,b.nbVol,b.siecle,b.eo,b.theme,b.etat,b.format,b.poids,b.stockage,b.numAchat,b.dateAchat,b.pxAchat,b.totalAchat,b.lieuAchat,b.publie,b.vendu,b.dateMiseEnVente,b.dateVente,b.dureeVente,b.pxMiseEnVente,b.pxEncaisse,b.modalites,b.livre,b.fraisExpedition,b.benefAttendu,b.benefRealise,b.difference]);let csv="\uFEFF"+h.join(";")+"\n"+rows.map(r=>r.map(x=>`"${String(x??"").replace(/"/g,'""')}"`).join(";")).join("\n");const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download=`Livres_CRM_${new Date().toISOString().slice(0,10)}.csv`;a.click();}

// ─── Dashboard ──────────────────────────────────────────────────────
const Dashboard=({books,expenses})=>{
  const s=useMemo(()=>{
    const vendus=books.filter(b=>b.vendu==="Oui"),enVente=books.filter(b=>b.publie==="Oui"&&b.vendu!=="Oui");
    const totalAchat=books.reduce((a,b)=>a+b.pxAchat,0),totalMEV=books.reduce((a,b)=>a+b.pxMiseEnVente,0);
    const totalEnc=vendus.reduce((a,b)=>a+b.pxEncaisse,0),benefAtt=books.reduce((a,b)=>a+b.benefAttendu,0),benefReal=vendus.reduce((a,b)=>a+b.benefRealise,0);
    // allExpenses with eBay subscriptions (same as Depenses tab)
    const now=new Date();const allExp=[...expenses];
    const hasMonth=(y,m)=>allExp.some(e=>e.categorie==="Abonnement Ebay"&&e.date&&e.date.startsWith(y+"-"+(m<10?"0":"")+m));
    const mNames=["","Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
    const start=new Date("2025-10-01");let d=new Date(start);
    while(d<=now||(d.getMonth()<=now.getMonth()&&d.getFullYear()<=now.getFullYear())){const y=d.getFullYear(),m=d.getMonth()+1;if(!hasMonth(y,m)){allExp.push({venteNum:"TOUTES",date:y+"-"+(m<10?"0":"")+m+"-01",categorie:"Abonnement Ebay",vendeur:"eBay",montant:20,description:"Abonnement eBay - "+mNames[m]+" "+y})}d.setMonth(d.getMonth()+1)}
    const totalDep=allExp.reduce((a,b)=>a+b.montant,0);
    const tc={};books.forEach(b=>{if(b.theme)tc[b.theme]=(tc[b.theme]||0)+1});
    const sc={};books.forEach(b=>{if(b.siecle)sc[b.siecle+"ème"]=(sc[b.siecle+"ème"]||0)+1});
    const ec={};books.forEach(b=>{if(b.etat)ec[b.etat]=(ec[b.etat]||0)+1});
    const lc={};books.forEach(b=>{if(b.lieuAchat)lc[b.lieuAchat]=(lc[b.lieuAchat]||0)+1});
    return{vendus,enVente,totalAchat,totalMEV,totalEnc,benefAtt,benefReal,totalDep,
      dureeVenteMoy:(()=>{const ds=vendus.filter(b=>b.dateMiseEnVente&&b.dateVente).map(b=>Math.round((new Date(b.dateVente)-new Date(b.dateMiseEnVente))/(86400000)));return ds.length?Math.round(ds.reduce((a,b)=>a+b,0)/ds.length):null})(),
      dureeStockMoy:(()=>{const now=new Date();const ds=enVente.filter(b=>b.dateMiseEnVente).map(b=>Math.round((now-new Date(b.dateMiseEnVente))/(86400000)));return ds.length?Math.round(ds.reduce((a,b)=>a+b,0)/ds.length):null})(),
      topThemes:Object.entries(tc).sort((a,b)=>b[1]-a[1]).slice(0,8),topSiecles:Object.entries(sc).sort((a,b)=>b[1]-a[1]),etatCounts:Object.entries(ec),topSources:Object.entries(lc).sort((a,b)=>b[1]-a[1])};
  },[books,expenses]);
  const nOuvrages=books.filter(b=>b.categorie==="Ouvrage").length;
  const nLots=books.filter(b=>b.categorie==="Lot").length;
  const eC={"Bon":"#4c8cc9","Correct":"#c9a84c","Mauvais":"#c94c4c"};
  return(<div>
    <div style={{display:"flex",flexWrap:"wrap",gap:14,marginBottom:28}}>
      <Stat label="Inventaire" value={nOuvrages+" ouvrage"+(nOuvrages>1?"s":"")} sub={nLots+" lot"+(nLots>1?"s":"")}/>
      <Stat label="Vendus" value={s.vendus.length} accent="#4cc9a8"/>
      <Stat label="Total dépenses" value={fmt(s.totalDep)} accent="#a84cc9"/>
      <Stat label="Valeur stock" value={fmt(s.totalMEV)} accent="#4c8cc9"/>
      <Stat label="CA encaissé" value={fmt(s.totalEnc)} accent="#4cc98c"/>
      <Stat label="Bénéf. attendu" value={fmt(s.benefAtt)} accent="#c9a84c"/>
      <Stat label="Résultat net" value={fmt(s.totalEnc-s.totalDep)} accent={(s.totalEnc-s.totalDep)>=0?"#4cc98c":"#c94c4c"}/>
    </div>
    <div style={{display:"flex",flexWrap:"wrap",gap:14,marginBottom:28}}>
      <Stat label="Durée moy. de vente" value={s.dureeVenteMoy!==null?s.dureeVenteMoy+" j":"—"} accent="#c9a84c"/>
      <Stat label="Durée moy. du stock" value={s.dureeStockMoy!==null?s.dureeStockMoy+" j":"—"} accent="#4a8ac9"/>
      <Stat label="Multiple théorique" value={(()=>{const avecPrix=books.filter(b=>b.pxMiseEnVente>0);const pxMEVmoy=avecPrix.length?avecPrix.reduce((a,b)=>a+b.pxMiseEnVente,0)/avecPrix.length:0;const pxAchatMoy=books.length?books.reduce((a,b)=>a+b.pxAchat,0)/books.length:0;return pxAchatMoy>0?(pxMEVmoy/pxAchatMoy).toFixed(1)+"x":"—"})()}  accent="#a84cc9"/>
      <Stat label="Multiple réel" value={(()=>{const v=books.filter(b=>b.vendu==="Oui"&&b.pxAchat>0);if(!v.length)return "—";const totalNet=v.reduce((a,b)=>a+(b.pxEncaisse||0)-(b.commissionVente||0)-(b.fraisExpedition||0),0);const totalAchat=v.reduce((a,b)=>a+b.pxAchat,0);return totalAchat>0?(totalNet/totalAchat).toFixed(1)+"x":"—"})()}  accent="#4cc98c"/>
    </div>
    <div style={{display:"flex",flexWrap:"wrap",gap:20}}>
      <div style={{...c,flex:"1 1 300px"}}><h3 style={{margin:"0 0 16px",fontSize:13,textTransform:"uppercase",letterSpacing:2,color:"#6a7a9a",fontFamily:"'JetBrains Mono',monospace"}}>Par thème</h3>
        {s.topThemes.map(([t,n])=>(<div key={t} style={{display:"flex",justifyContent:"space-between",padding:"7px 0",borderBottom:"1px solid #111827"}}><span style={{color:"#8892b0",fontSize:13}}>{t}</span><div style={{display:"flex",alignItems:"center",gap:8}}><div style={{width:n*12,maxWidth:120,height:6,background:"linear-gradient(90deg,#c9a84c,#6a5a28)",borderRadius:3}}/><span style={{color:"#c9a84c",fontWeight:700,fontSize:13,fontFamily:"'JetBrains Mono',monospace"}}>{n}</span></div></div>))}</div>
      <div style={{...c,flex:"1 1 200px"}}><h3 style={{margin:"0 0 16px",fontSize:13,textTransform:"uppercase",letterSpacing:2,color:"#6a7a9a",fontFamily:"'JetBrains Mono',monospace"}}>Par siècle</h3>
        {s.topSiecles.map(([t,n])=>(<div key={t} style={{display:"flex",justifyContent:"space-between",padding:"8px 0",borderBottom:"1px solid #111827"}}><span style={{color:"#8892b0"}}>{t}</span><span style={{color:"#4c8cc9",fontWeight:700,fontFamily:"'JetBrains Mono',monospace"}}>{n}</span></div>))}</div>
      <div style={{...c,flex:"1 1 200px"}}><h3 style={{margin:"0 0 16px",fontSize:13,textTransform:"uppercase",letterSpacing:2,color:"#6a7a9a",fontFamily:"'JetBrains Mono',monospace"}}>Par état</h3>
        {s.etatCounts.map(([t,n])=>(<div key={t} style={{display:"flex",justifyContent:"space-between",padding:"8px 0",borderBottom:"1px solid #111827"}}><span style={{color:eC[t]||"#8892b0"}}>{t}</span><span style={{color:eC[t]||"#c9a84c",fontWeight:700,fontFamily:"'JetBrains Mono',monospace"}}>{n}</span></div>))}</div>
      <div style={{...c,flex:"1 1 220px"}}><h3 style={{margin:"0 0 16px",fontSize:13,textTransform:"uppercase",letterSpacing:2,color:"#6a7a9a",fontFamily:"'JetBrains Mono',monospace"}}>Par source</h3>
        {s.topSources.map(([t,n])=>(<div key={t} style={{display:"flex",justifyContent:"space-between",padding:"8px 0",borderBottom:"1px solid #111827"}}><span style={{color:"#8892b0",fontSize:13}}>{t}</span><span style={{color:"#4cc9a8",fontWeight:700,fontFamily:"'JetBrains Mono',monospace"}}>{n}</span></div>))}</div>
    </div>
  </div>);
};

// ─── Inventaire ─────────────────────────────────────────────────────
const Inventaire=({books,onAdd,onEdit,onDelete,expenses,onSyncExpense})=>{
  const [q,setQ]=useState("");const [fT,setFT]=useState("all");const [fE,setFE]=useState("all");const [fV,setFV]=useState("all");const [fS,setFS]=useState("all");const [fC,setFC]=useState("all");const [fA,setFA]=useState("all");
  const [sk,setSk]=useState("id");const [sd,setSd]=useState(-1);const [mo,setMo]=useState(false);const [ed,setEd]=useState(null);const [vi,setVi]=useState(null);
  // ─── Publish split-screen ───
  const [pubBook,setPubBook]=useState(null);
  const [pubHtml,setPubHtml]=useState("");
  const [pubEtatHtml,setPubEtatHtml]=useState("");
  const [pubDescHtml,setPubDescHtml]=useState("");
  const [pubLoading,setPubLoading]=useState(false);
  const [pubApiKey,setPubApiKey]=useState("");
  useEffect(()=>{(async()=>{try{const r=await fetch(SB_URL+"/rest/v1/settings?key=eq.anthropic_api_key&select=value",{headers:{"apikey":SB_KEY,"Authorization":"Bearer "+SB_KEY}});if(r.ok){const d=await r.json();if(d.length&&d[0].value){setPubApiKey(d[0].value);return}}}catch(e){}try{const v=localStorage.getItem("rl-anthropic-key");if(v)setPubApiKey(v)}catch(e){}})()},[]);

  const buildPubHtml=(b)=>{
    const cs=b.caracSpec||{};
    const isEO=b.eo==="EO"||b.eo==="Oui";
    const specsList=Object.entries({frontispice:"Frontispice",gravures:"Gravures",exLibris:"Ex-libris",cartes:"Cartes",illustrations:"Illustrations"}).filter(([k])=>cs[k]).map(([,v])=>v);
    if(isEO)specsList.unshift("Édition originale");
    const sep='<p style="text-align:center;letter-spacing:3px;color:#888;margin:20px 0">══════════════════════════════════</p>';
    const secTitle=(t)=>'<p style="font-size:12px;color:#c0392b;margin-bottom:2px">'+t+'</p>';
    // Titre eBay: "titre - auteur - année (E.O.)" + éventuellement "- X/X vols", max 80 chars
    const _t=b.titre&&b.titre!=="-"?b.titre:"";
    const _a=b.auteur&&b.auteur!=="-"?b.auteur:"";
    const _an=b.date&&b.date!=="-"?(b.date+(isEO?" (E.O.)":"")):"";
    const _vo=b.nbVol&&b.nbVol>1?(b.completion||b.nbVol+"/"+b.nbVol)+" vols":"";
    const _full=[_t,_a,_an,_vo].filter(Boolean).join(" - ");
    let titreEbay;
    if(_full.length<=80){titreEbay=_full}
    else{const _noV=[_t,_a,_an].filter(Boolean).join(" - ");
      if(_noV.length<=80){titreEbay=_noV}
      else{const _rest=[_a,_an].filter(Boolean).join(" - ");const _mx=80-_rest.length-5;
        titreEbay=_mx>5?_t.substring(0,_mx)+"... - "+_rest:_noV.substring(0,77)+"..."}}
    const toRoman=(n)=>({16:"XVIe",17:"XVIIe",18:"XVIIIe",19:"XIXe"}[n]||"");
    const epoque=(b.date&&b.date!=="-"?b.date:"")+(b.siecle?" ("+toRoman(b.siecle)+" siècle)":"");
    const v=(val)=>(!val||val==="-"||val==="0"||val===0)?"-":String(val);

    let html='<div style="font-family:Georgia,serif;max-width:800px;margin:0 auto;color:#333;line-height:1.8">';
    html+=secTitle("Titre de l\'annonce :");
    html+='<p style="font-size:20px;font-weight:bold;color:#333;margin-top:0;margin-bottom:24px">'+titreEbay+'</p>';
    html+=sep;
    html+=secTitle("Caractéristiques de l\'objet :");
    const row=(label,val)=>'<p style="margin-bottom:6px"><strong>'+label+' :</strong> '+v(val)+'</p>';
    html+=row("Sujet",b.theme);
    html+=row("Auteur",b.auteur);
    html+=row("Caractéristiques spéciales",specsList.length?specsList.join(", "):"");
    html+=row("Époque",epoque||"");
    html+=row("Nom",b.titre);
    html+=row("Type",b.format);
    html+=row("Lieu de publication",b.lieuEdition);
    html+=row("Nom de publication",b.editeur);
    html+=row("Date de publication",b.date);
    html+=row("Poids",b.poids?b.poids+" kg":"");
    html+=row("Nombre de pages",b.nbPages?String(b.nbPages):"");
    html+=sep;
    html+='</div>';
    return{html,titreEbay,specs:specsList};
  };

  const startPublish=async(b)=>{
    const sw=window.screen.availWidth,sh=window.screen.availHeight;
    window.open("https://www.ebay.fr/sl/prelist/suggest?sr=shstart","_blank","width="+Math.round(sw/2)+",height="+sh+",left="+Math.round(sw/2)+",top=0,menubar=no,toolbar=yes,location=yes,status=no,scrollbars=yes");
    try{window.resizeTo(Math.round(sw/2),sh);window.moveTo(0,0)}catch(e){}
    const{html,specs}=buildPubHtml(b);
    setPubBook(b);setPubHtml(html);setPubEtatHtml("");setPubDescHtml("");setPubLoading(true);
    if(pubApiKey){
      try{
        const prompt=`Tu es un expert bibliophile spécialisé en livres anciens des XVIe au XIXe siècles. À partir des informations ci-dessous, génère deux sections pour une annonce eBay.

Titre : ${b.titre||"?"}
Auteur : ${b.auteur||"?"}
Date : ${b.date||"?"}
Éditeur : ${b.editeur||"?"}
Lieu d'édition : ${b.lieuEdition||"?"}
Format : ${b.format||"?"}
État général : ${b.etat||"?"}
Thème : ${b.theme||"?"}
EO : ${b.eo||"Non"}
Caractéristiques spéciales : ${specs.length?specs.join(", "):"aucune"}

Réponds UNIQUEMENT en JSON valide, sans backticks :
{"etat":"","reliure":"","description":""}

RÈGLES ABSOLUES :
- N'invente RIEN. Ne décris que ce que tu sais être certain ou très probable pour un livre de cette époque, ce format et cet éditeur.
- Si tu n'es pas sûr d'un détail, ne le mentionne pas.

- "etat" : un court paragraphe HTML décrivant l'état physique du livre, cohérent avec "${b.etat||"?"}". Utilise <p style="margin-bottom:14px">...</p>. Si "Bon" : bon état général, défauts mineurs d'usage typiques de l'époque. Si "Correct" : défauts visibles mais non rédhibitoires. Si "Mauvais" : défauts importants.

- "reliure" : UNE phrase en HTML décrivant la reliure probable du livre compte tenu de l'époque (${b.date||"?"}), du format (${b.format||"?"}), de l'éditeur (${b.editeur||"?"}) et du type d'ouvrage. Utilise <p style="margin-bottom:14px"><strong>...</strong></p>. Exemple de style : "Reliure pleine percaline rouge d'éditeur, dos lisse orné de filets dorés, titre doré." ${specs.length?"Mentionne aussi : "+specs.join(", ")+".":""}. Ne mentionne QUE ce qui est quasi certain pour ce type de livre.

- "description" : un court texte HTML (2-4 phrases savantes sur l'ouvrage, l'auteur, son contexte historique et son importance) suivi d'une phrase "Intéressera les amateurs de...". Utilise <p style="margin-bottom:14px">...</p>. Termine par <p><strong>Envoi soigné en Colissimo.</strong></p>. Ne répète PAS les informations de la fiche technique ni de la reliure.`;
        const response=await fetch("https://api.anthropic.com/v1/messages",{
          method:"POST",headers:{"Content-Type":"application/json","x-api-key":pubApiKey,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},
          body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:2000,messages:[{role:"user",content:prompt}]})
        });
        if(response.ok){
          const data=await response.json();
          const text=data.content.map(i=>i.text||"").join("").replace(/```json|```/g,"").trim();
          try{
            const parsed=JSON.parse(text);
            if(parsed.etat)setPubEtatHtml(parsed.etat);
            const vv=(val)=>(!val||val==="-")?"-":val;
            let descBlock='<p style="margin-bottom:6px"><strong>Titre :</strong> '+vv(b.titre)+'</p>';
            descBlock+='<p style="margin-bottom:6px"><strong>Auteur :</strong> '+vv(b.auteur)+'</p>';
            descBlock+='<p style="margin-bottom:6px"><strong>Éditeur :</strong> '+vv(b.editeur)+'</p>';
            descBlock+='<p style="margin-bottom:6px"><strong>Année :</strong> '+vv(b.date)+'</p>';
            descBlock+='<p style="margin-bottom:14px"><strong>Format :</strong> '+vv(b.format)+'</p>';
            if(parsed.reliure)descBlock+=parsed.reliure;
            if(parsed.description)descBlock+=parsed.description;
            setPubDescHtml(descBlock);
          }catch(e){console.error("Parse error",e)}
        }
      }catch(err){console.error(err)}
    }
    setPubLoading(false);
  };
  const list=useMemo(()=>{let l=[...books];if(q){const s=q.toLowerCase();l=l.filter(b=>b.titre.toLowerCase().includes(s)||b.auteur.toLowerCase().includes(s)||b.theme.toLowerCase().includes(s))}
    if(fT!=="all")l=l.filter(b=>b.theme===fT);if(fE!=="all")l=l.filter(b=>b.etat===fE);
    if(fV==="apublier")l=l.filter(b=>b.publie!=="Oui");else if(fV==="envente")l=l.filter(b=>b.publie==="Oui"&&b.vendu!=="Oui");else if(fV==="vendu")l=l.filter(b=>b.vendu==="Oui");
    if(fS!=="all")l=l.filter(b=>String(b.siecle)===fS);
    if(fC==="Ouvrage")l=l.filter(b=>b.categorie==="Ouvrage");else if(fC==="Lot")l=l.filter(b=>b.categorie==="Lot");
    if(fA!=="all")l=l.filter(b=>b.numAchat===fA);
    l.sort((a,b)=>{let va=a[sk],vb=b[sk];if(sk==="id")return((parseInt(va)||0)-(parseInt(vb)||0))*sd;if(sk==="eo"){const ea=(va==="EO"||va==="Oui")?1:(va==="Non")?0:-1;const eb=(vb==="EO"||vb==="Oui")?1:(vb==="Non")?0:-1;return(ea-eb)*sd}if(typeof va==="number"&&typeof vb==="number")return(va-vb)*sd;const sa=String(va||""),sb=String(vb||"");if(sa===""&&sb!=="")return sd;if(sb===""&&sa!=="")return-sd;const na=parseFloat(sa),nb=parseFloat(sb);if(sa!==""&&sb!==""&&!isNaN(na)&&!isNaN(nb))return(na-nb)*sd;return sa.localeCompare(sb,"fr")*sd});return l;
  },[books,q,fT,fE,fV,fS,fC,fA,sk,sd]);
  const ds=k=>{if(sk===k)setSd(d=>-d);else{setSk(k);setSd(1)}};
  const SH=({k,children,w})=><th onClick={()=>ds(k)} style={{padding:"10px 12px",textAlign:"left",fontSize:10,textTransform:"uppercase",letterSpacing:1.5,color:"#4a5a7a",cursor:"pointer",userSelect:"none",width:w,fontFamily:"'JetBrains Mono',monospace",borderBottom:"1px solid #1e2d4a",whiteSpace:"nowrap",position:"sticky",top:0,background:"#111827",zIndex:1}}>{children}{sk===k?(sd===1?" ▲":" ▼"):""}</th>;
  return(<div>
    <div style={{display:"flex",flexWrap:"wrap",gap:10,marginBottom:16,alignItems:"center"}}>
      <input style={{...inp,flex:"1 1 220px",maxWidth:320}} placeholder="🔍 Rechercher..." value={q} onChange={e=>setQ(e.target.value)}/>
      <select style={{...sel,width:130}} value={fT} onChange={e=>setFT(e.target.value)}><option value="all">Tous thèmes</option>{THEMES.map(t=><option key={t}>{t}</option>)}</select>
      <select style={{...sel,width:110}} value={fE} onChange={e=>setFE(e.target.value)}><option value="all">Tous états</option>{ETATS.map(t=><option key={t}>{t}</option>)}</select>
      <select style={{...sel,width:110}} value={fV} onChange={e=>setFV(e.target.value)}><option value="all">Tous statuts</option><option value="apublier">A publier</option><option value="envente">En vente</option><option value="vendu">Vendu</option></select>
      <select style={{...sel,width:110}} value={fC} onChange={e=>setFC(e.target.value)}><option value="all">Catégorie</option><option value="Ouvrage">Ouvrages</option><option value="Lot">Lots</option></select>
      <select style={{...sel,width:100}} value={fS} onChange={e=>setFS(e.target.value)}><option value="all">Siècle</option>{SIECLES.map(s=><option key={s} value={s}>{s}ème</option>)}</select>
      <select style={{...sel,width:120}} value={fA} onChange={e=>setFA(e.target.value)}><option value="all">Tous achats</option>{[...new Set(books.map(b=>b.numAchat).filter(Boolean))].sort((a,b)=>Number(a)-Number(b)).map(n=><option key={n} value={n}>Achat n°{n}</option>)}</select>
      <div style={{flex:1}}/><button style={btnP} onClick={()=>{setEd(null);setMo(true)}}>+ Ajouter</button>
    </div>
    <div style={{overflowX:"auto",borderRadius:12,border:"1px solid #1e2d4a",maxHeight:"65vh",overflowY:"auto"}}>
      <table style={{width:"100%",borderCollapse:"collapse",background:"#111827",minWidth:1000}}>
        <thead><tr><SH k="id" w="40px">N°</SH><SH k="titre">Titre</SH><SH k="auteur">Auteur</SH><SH k="date" w="60px">Date</SH><SH k="siecle" w="50px">S.</SH><SH k="eo" w="40px">EO</SH><SH k="theme">Thème</SH><SH k="etat" w="70px">État</SH><SH k="pxAchat" w="75px">Achat</SH><SH k="pxMiseEnVente" w="80px">Estimation</SH><SH k="publie" w="65px">Publié</SH><SH k="vendu" w="55px">Vendu</SH><SH k="benefRealise" w="70px">Benef</SH><th style={{padding:"10px 8px",width:80,borderBottom:"1px solid #1e2d4a",position:"sticky",top:0,background:"#111827"}}/></tr></thead>
        <tbody>{list.length===0?<tr><td colSpan={14} style={{padding:40,textAlign:"center",color:"#3a4a6a",fontStyle:"italic"}}>Aucun résultat</td></tr>
        :list.map(b=>(<tr key={b.id} style={{borderBottom:"1px solid #0d1525",cursor:"pointer"}} onClick={()=>setVi(b)} onMouseEnter={e=>e.currentTarget.style.background="#141e33"} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
          <td style={{padding:"10px 12px",color:"#4a5a7a",fontSize:12,fontFamily:"'JetBrains Mono',monospace"}}>{b.id}</td>
          <td style={{padding:"10px 12px",color:"#e6f1ff",fontWeight:600,fontSize:13,fontFamily:"'Playfair Display',serif",maxWidth:260,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{b.titre}</td>
          <td style={{padding:"10px 12px",color:"#8892b0",fontSize:12}}>{b.auteur}</td>
          <td style={{padding:"10px 12px",color:"#5a6a8a",fontSize:12,fontFamily:"'JetBrains Mono',monospace"}}>{b.date}</td>
          <td style={{padding:"10px 12px",color:"#5a6a8a",fontSize:11,fontFamily:"'JetBrains Mono',monospace"}}>{b.siecle||""}</td>
          <td style={{padding:"10px 12px",color:b.eo==="EO"||b.eo==="Oui"?"#c9a84c":"#2a3a5a",fontSize:11,fontWeight:700}}>{b.eo==="EO"||b.eo==="Oui"?"EO":"·"}</td>
          <td style={{padding:"10px 12px",color:"#6a8aaa",fontSize:12}}>{b.theme}</td>
          <td style={{padding:"10px 12px"}}><span style={{fontSize:11,color:({"Bon":"#4c8cc9","Correct":"#c9a84c","Mauvais":"#c94c4c"})[b.etat]||"#5a6a8a"}}>{b.etat}</span></td>
          <td style={{padding:"10px 12px",color:"#a84cc9",fontSize:12,fontFamily:"'JetBrains Mono',monospace"}}>{fmt(b.pxAchat)}</td>
          <td style={{padding:"10px 12px",color:"#4c8cc9",fontSize:12,fontFamily:"'JetBrains Mono',monospace"}}>{fmt(b.pxMiseEnVente)}</td>
          <td style={{padding:"10px 12px"}} onClick={e=>e.stopPropagation()}>{b.publie==="Oui"?<span style={{color:"#4cc98c",fontWeight:700,fontSize:11}}>✓</span>:<button onClick={()=>startPublish(b)} style={{background:"none",border:"1px solid #1e3050",borderRadius:5,color:"#4c8cc9",cursor:"pointer",padding:"3px 8px",fontSize:10,fontFamily:"'JetBrains Mono',monospace",whiteSpace:"nowrap"}}>Publier</button>}</td>
          <td style={{padding:"10px 12px",color:b.vendu==="Oui"?"#4cc98c":"#4a5a7a",fontSize:11,fontWeight:700}}>{b.vendu==="Oui"?"✓":"·"}</td>
          <td style={{padding:"10px 12px",color:b.vendu==="Oui"&&b.benefRealise?"#4cc98c":"#2a3a5a",fontSize:12,fontFamily:"'JetBrains Mono',monospace",fontWeight:600}}>{b.vendu==="Oui"&&b.benefRealise?fmt(b.benefRealise):"·"}</td>
          <td style={{padding:"10px 8px"}} onClick={e=>e.stopPropagation()}><div style={{display:"flex",gap:4}}>
            <button onClick={()=>{setEd(b);setMo(true)}} style={{background:"none",border:"1px solid #1e2d4a",borderRadius:5,color:"#5a7a9a",cursor:"pointer",padding:"4px 7px",fontSize:12}}>✎</button>
            <button onClick={()=>{if(confirm("Supprimer ?"))onDelete(b.id)}} style={{background:"none",border:"1px solid #2a1520",borderRadius:5,color:"#c94c4c",cursor:"pointer",padding:"4px 7px",fontSize:12}}>✕</button>
          </div></td>
        </tr>))}</tbody>
      </table>
    </div>
    <div style={{marginTop:10,fontSize:11,color:"#3a4a6a",fontFamily:"'JetBrains Mono',monospace"}}>{list.length} livre{list.length>1?"s":""}</div>
    <Modal open={mo} onClose={()=>setMo(false)} title={ed?"Modifier":"Ajouter"} wide noClickOutside confirmClose><BookForm book={ed} books={books} expenses={expenses} onSyncExpense={onSyncExpense} onCancel={()=>{if(window.confirm("Êtes-vous sûr de vouloir fermer ? Les modifications non enregistrées seront perdues."))setMo(false)}} onSave={b=>{ed?onEdit(b):onAdd(b);setMo(false)}}/></Modal>
    <Modal open={!!vi} onClose={()=>setVi(null)} title="" narrow><BookDetail book={vi}/></Modal>
    {/* ─── Publish Annonce Overlay ─── */}
    {pubBook&&<div style={{position:"fixed",inset:0,background:"rgba(0,0,0,.8)",backdropFilter:"blur(8px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000,padding:16}}>
      <div style={{background:"#fff",borderRadius:14,width:"100%",maxWidth:820,maxHeight:"92vh",overflowY:"auto",boxShadow:"0 20px 60px rgba(0,0,0,.5)",padding:"28px 24px",fontFamily:"Georgia,serif",color:"#333",lineHeight:1.8}}>
        {/* Top close button */}
        <div style={{display:"flex",justifyContent:"flex-end",marginBottom:20}}>
          <button onClick={()=>setPubBook(null)} style={{padding:"7px 14px",background:"#c0392b",border:"none",borderRadius:7,color:"#fff",fontSize:11,fontWeight:600,cursor:"pointer",fontFamily:"system-ui"}}>✕ Fermer</button>
        </div>

        {/* Section 1 : Titre + Section 2 : Caractéristiques */}
        <div dangerouslySetInnerHTML={{__html:pubHtml}}/>

        {/* Section 3 : État (REQ-ETAT) */}
        <p style={{fontSize:12,color:"#c0392b",marginBottom:2}}>État :</p>
        {pubLoading&&!pubEtatHtml?<div style={{display:"flex",alignItems:"center",gap:10,padding:"16px 0"}}>
          <span style={{display:"inline-block",width:16,height:16,border:"2px solid #c9a84c",borderTop:"2px solid transparent",borderRadius:"50%",animation:"spin 1s linear infinite"}}/>
          <span style={{color:"#888",fontSize:13}}>Génération...</span>
        </div>
        :pubEtatHtml?<div dangerouslySetInnerHTML={{__html:pubEtatHtml}}/>
        :<p style={{color:"#bbb",fontStyle:"italic",fontSize:13}}>Clé API requise pour générer cette section.</p>}
        <p style={{textAlign:"center",letterSpacing:3,color:"#888",margin:"20px 0"}}>══════════════════════════════════</p>

        {/* Section 4 : Description (REQ-SYNTHESE) */}
        <p style={{fontSize:12,color:"#c0392b",marginBottom:2}}>Description :</p>
        {pubLoading&&!pubDescHtml?<div style={{display:"flex",alignItems:"center",gap:10,padding:"16px 0"}}>
          <span style={{display:"inline-block",width:16,height:16,border:"2px solid #c9a84c",borderTop:"2px solid transparent",borderRadius:"50%",animation:"spin 1s linear infinite"}}/>
          <span style={{color:"#888",fontSize:13}}>Génération...</span>
        </div>
        :pubDescHtml?<div dangerouslySetInnerHTML={{__html:pubDescHtml}}/>
        :<p style={{color:"#bbb",fontStyle:"italic",fontSize:13}}>Clé API requise pour générer cette section.</p>}
        {/* Copy description button - red, centered */}
        <div style={{display:"flex",justifyContent:"center",margin:"16px 0"}}>
          <button onClick={async()=>{if(pubDescHtml){try{const blob=new Blob([pubDescHtml],{type:"text/html"});const plainBlob=new Blob([new DOMParser().parseFromString(pubDescHtml,"text/html").body.textContent||""],{type:"text/plain"});await navigator.clipboard.write([new ClipboardItem({"text/html":blob,"text/plain":plainBlob})])}catch(e){try{await navigator.clipboard.writeText(pubDescHtml)}catch(e2){const ta=document.createElement("textarea");ta.value=pubDescHtml;ta.style.position="fixed";ta.style.left="-9999px";document.body.appendChild(ta);ta.select();document.execCommand("copy");document.body.removeChild(ta)}}}}} disabled={!pubDescHtml} style={{padding:"8px 20px",background:pubDescHtml?"#0654fe":"#ccc",border:"none",borderRadius:7,color:"#fff",fontSize:12,fontWeight:600,cursor:pubDescHtml?"pointer":"default",fontFamily:"system-ui",opacity:pubDescHtml?1:.4}}>📋 Copier la description</button>
        </div>
        <p style={{textAlign:"center",letterSpacing:3,color:"#888",margin:"20px 0"}}>══════════════════════════════════</p>

        {/* Section 5 : Prix */}
        <p style={{fontSize:12,color:"#c0392b",marginBottom:2}}>Prix :</p>
        <p style={{fontSize:18,fontWeight:"bold",marginBottom:14}}>{pubBook.pxMiseEnVente?pubBook.pxMiseEnVente+" €":"-"}</p>

        {/* Bottom close button */}
        <div style={{display:"flex",justifyContent:"center",marginTop:28}}>
          <button onClick={()=>setPubBook(null)} style={{padding:"10px 28px",background:"#c0392b",border:"none",borderRadius:8,color:"#fff",fontSize:13,fontWeight:600,cursor:"pointer",fontFamily:"system-ui"}}>✕ Fermer</button>
        </div>
      </div>
    </div>}
  </div>);
};

// ─── Ventes ─────────────────────────────────────────────────────────
const Ventes=({books,expenses})=>{
  const vendus=useMemo(()=>books.filter(b=>b.vendu==="Oui").sort((a,b)=>(b.dateVente||"").localeCompare(a.dateVente||"")),[books]);
  const enVente=useMemo(()=>books.filter(b=>b.publie==="Oui"&&b.vendu!=="Oui").sort((a,b)=>b.pxMiseEnVente-a.pxMiseEnVente),[books]);
  const totalDep=useMemo(()=>{
    const now=new Date();const allExp=[...expenses];
    const hasMonth=(y,m)=>allExp.some(e=>e.categorie==="Abonnement Ebay"&&e.date&&e.date.startsWith(y+"-"+(m<10?"0":"")+m));
    const start=new Date("2025-10-01");let d=new Date(start);
    while(d<=now||(d.getMonth()<=now.getMonth()&&d.getFullYear()<=now.getFullYear())){const y=d.getFullYear(),m=d.getMonth()+1;if(!hasMonth(y,m)){allExp.push({montant:20})}d.setMonth(d.getMonth()+1)}
    return allExp.reduce((a,b)=>a+(b.montant||0),0);
  },[expenses]);
  const totalEnc=vendus.reduce((a,b)=>a+b.pxEncaisse,0);
  const benefRealise=(b)=>(b.pxEncaisse||0)-(b.commissionVente||0)-(b.fraisExpedition||0)-(b.pxAchat||0);
  return(<div>
    <div style={{display:"flex",flexWrap:"wrap",gap:14,marginBottom:28}}>
      <Stat label="Vendus" value={vendus.length} accent="#4cc9a8"/><Stat label="CA encaissé" value={fmt(totalEnc)} accent="#4cc98c"/>
      <Stat label="Résultat net" value={fmt(totalEnc-totalDep)} accent={(totalEnc-totalDep)>=0?"#4cc98c":"#c94c4c"}/><Stat label="En vente" value={enVente.length} sub={"Bénéf att: "+fmt(enVente.reduce((a,b)=>a+(b.pxMiseEnVente?(b.pxMiseEnVente-(b.pxAchat||0)-(b.pxMiseEnVente*0.1)-10):0),0))} accent="#c9a84c"/>
    </div>
    <div style={{display:"flex",flexWrap:"wrap",gap:20}}>
      <div style={{...c,flex:"1 1 450px"}}><h3 style={{margin:"0 0 16px",fontSize:13,textTransform:"uppercase",letterSpacing:2,color:"#6a7a9a",fontFamily:"'JetBrains Mono',monospace"}}>Ventes réalisées</h3>
        {vendus.length===0?<div style={{color:"#3a4a6a",textAlign:"center",padding:30,fontStyle:"italic"}}>Aucune vente</div>:vendus.map(b=>{const br=benefRealise(b);return(<div key={b.id} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"12px 0",borderBottom:"1px solid #111827",flexWrap:"wrap",gap:6}}>
          <div><div style={{color:"#e6f1ff",fontWeight:600,fontSize:13,fontFamily:"'Playfair Display',serif"}}>{b.titre}</div><div style={{color:"#4a5a7a",fontSize:11,marginTop:2}}>{b.auteur} · {fmtD(b.dateVente)}</div></div>
          <div style={{textAlign:"right"}}><div style={{color:"#4cc9a8",fontWeight:700,fontFamily:"'JetBrains Mono',monospace",fontSize:14}}>{fmt(b.pxEncaisse)}</div><div style={{color:br>=0?"#4cc98c":"#c94c4c",fontSize:11,fontFamily:"'JetBrains Mono',monospace"}}>Bénéf: {fmt(br)}</div></div>
        </div>)})}</div>
      <div style={{...c,flex:"1 1 400px"}}><h3 style={{margin:"0 0 16px",fontSize:13,textTransform:"uppercase",letterSpacing:2,color:"#6a7a9a",fontFamily:"'JetBrains Mono',monospace"}}>En vente ({enVente.length})</h3>
        {enVente.slice(0,20).map(b=>(<div key={b.id} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 0",borderBottom:"1px solid #111827",gap:6}}>
          <div><div style={{color:"#ccd6f6",fontSize:13,fontFamily:"'Playfair Display',serif"}}>{b.titre}</div><div style={{color:"#3a4a6a",fontSize:10,marginTop:2}}>{b.dureeVente}</div></div>
          <div style={{color:"#c9a84c",fontWeight:700,fontFamily:"'JetBrains Mono',monospace",fontSize:13,whiteSpace:"nowrap"}}>{fmt(b.pxMiseEnVente)}</div>
        </div>))}</div>
    </div>
  </div>);
};

// ─── Sourcing ───────────────────────────────────────────────────────
const Sourcing=({books,expenses})=>{
  const venteNames=VENTE_NAMES_INIT;
  const ventes=useMemo(()=>{const m={};books.forEach(b=>{const k=b.numAchat||"?";if(!m[k])m[k]={count:0,spent:0,sold:0,revenue:0,ba:0,br:0,lieu:""};m[k].count++;m[k].spent+=b.pxAchat;m[k].ba+=b.benefAttendu;m[k].br+=b.benefRealise||0;if(!m[k].lieu&&b.lieuAchat)m[k].lieu=b.lieuAchat;if(b.vendu==="Oui"){m[k].sold++;m[k].revenue+=b.pxEncaisse}});return Object.entries(m).map(([n,d])=>({num:n,name:venteNames[n]||("Vente "+n+(d.lieu?" — "+d.lieu:"")),...d})).sort((a,b)=>Number(a.num)-Number(b.num))},[books]);
  const recent=useMemo(()=>[...books].sort((a,b)=>(b.dateAchat||"").localeCompare(a.dateAchat||"")).slice(0,15),[books]);
  const livresAvecPrix=books.filter(b=>b.pxMiseEnVente>0);
  return(<div>
    <div style={{display:"flex",flexWrap:"wrap",gap:14,marginBottom:28}}>
      <Stat label="Ventes" value={ventes.length} accent="#c9a84c"/><Stat label="Total investi" value={fmt(books.reduce((a,b)=>a+b.pxAchat,0))} accent="#a84cc9"/>
      <Stat label="Px achat moyen" value={books.length?fmt(books.reduce((a,b)=>a+b.pxAchat,0)/books.length):"—"} accent="#4c8cc9"/><Stat label="Prix de vente moyen" value={livresAvecPrix.length?fmt(livresAvecPrix.reduce((a,b)=>a+b.pxMiseEnVente,0)/livresAvecPrix.length):"—"} accent="#c9a84c"/>
    </div>
    <div style={{display:"flex",flexWrap:"wrap",gap:20}}>
      <div style={{...c,flex:"1 1 450px"}}><h3 style={{margin:"0 0 16px",fontSize:13,textTransform:"uppercase",letterSpacing:2,color:"#6a7a9a",fontFamily:"'JetBrains Mono',monospace"}}>Performance par vente</h3>
        {ventes.map(s=>(<div key={s.num} style={{padding:"14px 0",borderBottom:"1px solid #111827"}}>
          <div style={{display:"flex",justifyContent:"space-between",marginBottom:6}}><span style={{color:"#e6f1ff",fontWeight:600,fontSize:14}}>{s.name}</span><span style={{color:"#4a5a7a",fontSize:12,fontFamily:"'JetBrains Mono',monospace"}}>{s.count} livre{s.count>1?"s":""}</span></div>
          <div style={{display:"flex",gap:14,fontSize:11,fontFamily:"'JetBrains Mono',monospace",flexWrap:"wrap"}}><span style={{color:"#a84cc9"}}>Investi: {fmt(s.spent)}</span><span style={{color:"#4cc9a8"}}>Vendu: {s.sold}/{s.count}</span><span style={{color:"#4c8cc9"}}>CA: {fmt(s.revenue)}</span><span style={{color:"#c9a84c"}}>Bénéf att: {fmt(s.ba)}{s.spent>0&&<span style={{color:"#8892b0"}}> (x {(s.ba/s.spent).toFixed(1)})</span>}</span></div>
          {s.ba>0&&(()=>{const pct=Math.min(100,Math.round((s.br/s.ba)*100));return(<div style={{marginTop:8}}>
            <div style={{display:"flex",justifyContent:"space-between",fontSize:10,fontFamily:"'JetBrains Mono',monospace",marginBottom:3}}><span style={{color:"#8892b0"}}>Bénéf réalisé: {fmt(s.br)} / {fmt(s.ba)}</span><span style={{color:pct>=100?"#4cc98c":pct>=50?"#c9a84c":"#8892b0",fontWeight:600}}>{pct}%</span></div>
            <div style={{height:6,background:"#0d1525",borderRadius:3,overflow:"hidden"}}><div style={{height:"100%",width:pct+"%",background:pct>=100?"linear-gradient(90deg,#4cc98c,#2ecc71)":pct>=50?"linear-gradient(90deg,#c9a84c,#e6c44c)":"linear-gradient(90deg,#4c8cc9,#6aa8e6)",borderRadius:3,transition:"width .5s ease"}}/></div>
          </div>)})()}
        </div>))}</div>
      <div style={{...c,flex:"1 1 350px"}}><h3 style={{margin:"0 0 16px",fontSize:13,textTransform:"uppercase",letterSpacing:2,color:"#6a7a9a",fontFamily:"'JetBrains Mono',monospace"}}>Derniers achats</h3>
        {recent.map(b=>(<div key={b.id} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"9px 0",borderBottom:"1px solid #111827"}}>
          <div><div style={{color:"#e6f1ff",fontSize:12,fontWeight:600,fontFamily:"'Playfair Display',serif"}}>{b.titre.length>45?b.titre.slice(0,45)+"…":b.titre}</div><div style={{color:"#3a4a6a",fontSize:10,marginTop:2}}>{fmtD(b.dateAchat)} · {b.lieuAchat}</div></div>
          <div style={{color:"#a84cc9",fontWeight:700,fontFamily:"'JetBrains Mono',monospace",fontSize:12,whiteSpace:"nowrap"}}>{fmt(b.pxAchat)}</div>
        </div>))}</div>
    </div>
  </div>);
};

// ─── Achats / Frais ──────────────────────────────────────────────────
const VENTE_NAMES_INIT={"0":"Achat 0 — Achat Gratuit (01/01/2025)","1":"Achat 1 — Inter Ville CP (24/09/2025)","2":"Achat 2 — Passerelle des Enchères (11/10/2025)","3":"Achat 3 — Deloys (22/10/2025)"};
const Depenses=({expenses,onAdd,onDelete,books})=>{
  const [vue,setVue]=useState("par_achat");
  const [moAchat,setMoAchat]=useState(false);
  const [moDep,setMoDep]=useState(false);
  const [editExp,setEditExp]=useState(null);
  const [open,setOpen]=useState({});
  const [venteNames,setVenteNames]=useState(VENTE_NAMES_INIT);
  const [fa,setFa]=useState({vendeur:"",date:new Date().toISOString().slice(0,10),montant:0,notes:""});
  const defaultFrais={categorie:"Frais de livraison",venteNum:"TOUTES",date:new Date().toISOString().slice(0,10),vendeur:"",montant:0,description:"",recurrence:"ponctuel",frequence:"mensuel",affectation:"toutes",dateDe:"",dateA:""};
  const [f,setF]=useState({...defaultFrais});
  const sf=(k,v)=>setF(p=>({...p,[k]:v}));

  const nextAchatNum=useMemo(()=>{
    const nums=Object.keys(venteNames).filter(k=>!isNaN(k)).map(Number);
    return nums.length?Math.max(...nums)+1:4;
  },[venteNames]);

  const allExpenses=useMemo(()=>{
    const now=new Date();const existing=expenses.map((e,i)=>({...e,_origIdx:i}));
    const hasMonth=(y,m)=>existing.some(e=>e.categorie==="Abonnement Ebay"&&e.date&&e.date.startsWith(y+"-"+(m<10?"0":"")+m));
    const mNames=["","Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
    const start=new Date("2025-10-01");let d=new Date(start);
    while(d<=now||(d.getMonth()<=now.getMonth()&&d.getFullYear()<=now.getFullYear())){
      const y=d.getFullYear(),m=d.getMonth()+1;
      if(!hasMonth(y,m)){existing.push({venteNum:"TOUTES",date:y+"-"+(m<10?"0":"")+m+"-01",categorie:"Abonnement Ebay",vendeur:"eBay",montant:20,description:"Abonnement eBay - "+mNames[m]+" "+y,_auto:true})}
      d.setMonth(d.getMonth()+1);
    }
    return existing;
  },[expenses]);

  const total=allExpenses.reduce((a,b)=>a+b.montant,0);
  const grouped=useMemo(()=>{
    const m={};allExpenses.forEach(e=>{const k=(e.venteNum==="G"||e.venteNum==="TOUTES")?"TOUTES":e.venteNum||"TOUTES";if(!m[k])m[k]=[];m[k].push(e)});
    const allKeys=new Set([...Object.keys(venteNames),...Object.keys(m)]);
    const nameFor=(k)=>k==="TOUTES"?"Frais Généraux":k==="CUSTOM"?"Personnalisé":venteNames[k]||"Achat "+k;
    return [...allKeys].map(k=>({key:k,name:nameFor(k),items:(m[k]||[]).sort((a,b)=>(b.date||"").localeCompare(a.date||"")),total:(m[k]||[]).reduce((a,b)=>a+b.montant,0)})).sort((a,b)=>{if(a.key==="TOUTES")return 1;if(b.key==="TOUTES")return -1;if(a.key==="CUSTOM")return 1;if(b.key==="CUSTOM")return -1;return Number(b.key)-Number(a.key)});
  },[allExpenses,venteNames]);
  const chrono=useMemo(()=>[...allExpenses].sort((a,b)=>(b.date||"").localeCompare(a.date||"")),[allExpenses]);
  const toggle=(k)=>setOpen(p=>({...p,[k]:!p[k]}));
  const [moEditAchat,setMoEditAchat]=useState(false);
  const [editAchatData,setEditAchatData]=useState(null);
  const openEditExp=(e)=>{
    if(e.categorie==="Achat de livres"){
      setEditAchatData(e);
      setFa({vendeur:e.vendeur||"",date:e.date||"",montant:e.montant||0,notes:e.description||""});
      setMoEditAchat(true);
    } else {
      setEditExp(e);setF({categorie:e.categorie||"Frais de livraison",venteNum:e.venteNum||"TOUTES",date:e.date||"",vendeur:e.vendeur||"",montant:e.montant||0,description:e.description||"",recurrence:"ponctuel",frequence:"mensuel",affectation:(e.venteNum==="TOUTES"||e.venteNum==="G")?"toutes":e.venteNum==="CUSTOM"?"personnalise":"vente",dateDe:"",dateA:""});setMoDep(true);
    }
  };

  const handleCreateAchat=()=>{
    const num=String(nextAchatNum);
    const label="Achat "+num+" — "+fa.vendeur+" ("+fmtD(fa.date)+")";
    setVenteNames(p=>({...p,[num]:label}));
    if(fa.montant>0)onAdd({venteNum:num,date:fa.date,categorie:"Achat de livres",vendeur:fa.vendeur,montant:fa.montant,description:"Achat "+fa.vendeur+" du "+fmtD(fa.date)+(fa.notes?" — "+fa.notes:"")});
    setMoAchat(false);setFa({vendeur:"",date:new Date().toISOString().slice(0,10),montant:0,notes:""});
  };

  const handleAddFrais=()=>{
    const aff=f.affectation==="toutes"?"TOUTES":f.affectation==="personnalise"?"CUSTOM":f.venteNum;
    const desc=f.description+(f.affectation==="personnalise"&&f.dateDe&&f.dateA?" ["+fmtD(f.dateDe)+" → "+fmtD(f.dateA)+"]":"")+(f.recurrence==="recurrent"?" (récurrent: "+f.frequence+")":"");
    onAdd({venteNum:aff,date:f.date,categorie:f.categorie,vendeur:f.vendeur,montant:f.montant,description:desc});
    setMoDep(false);setEditExp(null);setF({...defaultFrais});
  };

  const handleEditAchat=()=>{
    if(!editAchatData)return;
    const idx=editAchatData._origIdx;
    if(idx!==undefined&&onDelete){
      onDelete(idx);
      const num=editAchatData.venteNum||"0";
      const label="Achat "+num+" — "+fa.vendeur+" ("+fmtD(fa.date)+")";
      setVenteNames(p=>({...p,[num]:label}));
      onAdd({venteNum:num,date:fa.date,categorie:"Achat de livres",vendeur:fa.vendeur,montant:fa.montant,description:fa.notes||("Achat "+fa.vendeur+" du "+fmtD(fa.date))});
    }
    setMoEditAchat(false);setEditAchatData(null);
  };

  const handleDeleteAchat=(e)=>{
    if(e._origIdx!==undefined&&onDelete){
      if(window.confirm("Supprimer cet achat ?"))onDelete(e._origIdx);
    }
  };

  const renderTable=(items)=><table style={{width:"100%",borderCollapse:"collapse"}}>
    <thead><tr>{["Date","Catégorie","Vendeur","Montant","Description",""].map(h=><th key={h} style={{padding:"10px 14px",textAlign:"left",fontSize:10,textTransform:"uppercase",letterSpacing:1.5,color:"#4a5a7a",fontFamily:"'JetBrains Mono',monospace",borderBottom:"1px solid #111827"}}>{h}</th>)}</tr></thead>
    <tbody>{items.map((e,i)=>(<tr key={i} style={{borderBottom:"1px solid #0d1525"}}>
      <td style={{padding:"10px 14px",color:"#8892b0",fontSize:12}}>{fmtD(e.date)}</td>
      <td style={{padding:"10px 14px",color:"#6a8aaa",fontSize:12}}>{e.categorie}</td>
      <td style={{padding:"10px 14px",color:"#8892b0",fontSize:12}}>{e.vendeur}</td>
      <td style={{padding:"10px 14px",color:"#c94c8c",fontWeight:700,fontSize:13,fontFamily:"'JetBrains Mono',monospace"}}>{fmt(e.montant)}</td>
      <td style={{padding:"10px 14px",color:"#5a6a8a",fontSize:12,maxWidth:300,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{e.description}</td>
      <td style={{padding:"10px 14px",whiteSpace:"nowrap"}}>{e.categorie!=="Frais d'envoi"&&e.categorie!=="Frais d'envoi (Colissimo)"&&<><button onClick={()=>openEditExp(e)} style={{background:"none",border:"1px solid #2a3a5a",borderRadius:6,color:"#8892b0",fontSize:10,padding:"4px 10px",cursor:"pointer",fontFamily:"'JetBrains Mono',monospace",marginRight:4}}>✎</button>{!e._auto&&e._origIdx!==undefined&&onDelete&&<button onClick={()=>{if(window.confirm("Supprimer cette écriture ?"))onDelete(e._origIdx)}} style={{background:"none",border:"1px solid #4a2a2a",borderRadius:6,color:"#c94c4c",fontSize:10,padding:"4px 10px",cursor:"pointer",fontFamily:"'JetBrains Mono',monospace"}}>✕</button>}</>}{(e.categorie==="Frais d'envoi"||e.categorie==="Frais d'envoi (Colissimo)")&&<span style={{color:"#4a5a7a",fontSize:9,fontFamily:"'JetBrains Mono',monospace",fontStyle:"italic"}}>via fiche livre</span>}</td>
    </tr>))}</tbody>
  </table>;

  return(<div>
    <div style={{display:"flex",flexWrap:"wrap",gap:14,marginBottom:28}}>
      <Stat label="Total dépenses" value={fmt(total)} accent="#c94c8c"/>
      <Stat label="Écritures" value={allExpenses.length} accent="#4c8cc9"/>
      <Stat label="Nb de ventes aux enchères" value={Object.keys(venteNames).filter(k=>!isNaN(k)&&Number(k)>=1).length} accent="#c9a84c"/>
    </div>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:12,marginBottom:16}}>
      <div style={{display:"flex",gap:6}}>
        {[["par_achat","Par achat"],["chronologique","Chronologique"]].map(([k,l])=><button key={k} onClick={()=>setVue(k)} style={{padding:"7px 14px",border:"1px solid "+(vue===k?"#c9a84c33":"#1a2540"),borderRadius:8,background:vue===k?"linear-gradient(135deg,#c9a84c22,#c9a84c11)":"#0a0f1e",color:vue===k?"#c9a84c":"#4a5a7a",fontSize:11,fontWeight:600,cursor:"pointer",fontFamily:"'JetBrains Mono',monospace"}}>{l}</button>)}
      </div>
      <div style={{display:"flex",gap:10}}>
        <button style={btnP} onClick={()=>{setFa({vendeur:"",date:new Date().toISOString().slice(0,10),montant:0,notes:""});setMoAchat(true)}}>+ Nouvel achat</button>
        <button style={{...btnP,background:"linear-gradient(135deg,#ffffff,#e0e0e0)",color:"#1a1a2e"}} onClick={()=>{setEditExp(null);setF({...defaultFrais});setMoDep(true)}}>Saisir des frais</button>
      </div>
    </div>

    {vue==="par_achat"&&<div style={{display:"flex",flexDirection:"column",gap:14}}>
      {grouped.map(g=>(<div key={g.key} style={{...c,padding:0,overflow:"hidden"}}>
        <div onClick={()=>toggle(g.key)} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"16px 22px",cursor:"pointer",background:open[g.key]?"linear-gradient(135deg,#1a1a2e,#16213e)":"transparent",transition:"background .2s"}}>
          <div style={{display:"flex",alignItems:"center",gap:12}}>
            <span style={{color:"#4a5a7a",fontSize:14,transition:"transform .2s",transform:open[g.key]?"rotate(90deg)":"rotate(0)",display:"inline-block"}}>▶</span>
            <div>
              <div style={{color:"#e6f1ff",fontWeight:600,fontSize:14,fontFamily:"'Playfair Display',serif"}}>{g.name}</div>
              <div style={{color:"#4a5a7a",fontSize:10,fontFamily:"'JetBrains Mono',monospace",marginTop:2}}>{g.items.length} écriture{g.items.length>1?"s":""}</div>
            </div>
          </div>
          <div style={{color:"#c94c8c",fontWeight:700,fontSize:15,fontFamily:"'JetBrains Mono',monospace"}}>{fmt(g.total)}</div>
        </div>
        {open[g.key]&&<div style={{borderTop:"1px solid #1e2d4a"}}>
          {renderTable(g.items)}
          <div style={{padding:"12px 14px",textAlign:"right"}}><span style={{color:"#6a7a9a",fontWeight:700,fontSize:11,fontFamily:"'JetBrains Mono',monospace",marginRight:14}}>SOUS-TOTAL</span><span style={{color:"#c94c8c",fontWeight:700,fontSize:13,fontFamily:"'JetBrains Mono',monospace"}}>{fmt(g.total)}</span></div>
        </div>}
      </div>))}
    </div>}

    {vue==="chronologique"&&<div style={{...c,padding:0,overflow:"hidden"}}>
      {renderTable(chrono)}
      <div style={{padding:"14px 14px",textAlign:"right",borderTop:"1px solid #1e2d4a"}}><span style={{color:"#6a7a9a",fontWeight:700,fontSize:11,fontFamily:"'JetBrains Mono',monospace",marginRight:14}}>TOTAL</span><span style={{color:"#c94c8c",fontWeight:700,fontSize:15,fontFamily:"'JetBrains Mono',monospace"}}>{fmt(total)}</span></div>
    </div>}

    {/* Modal: Nouvel achat — noClickOutside */}
    <Modal open={moAchat} onClose={()=>setMoAchat(false)} title={"Nouvel achat — N°"+nextAchatNum} noClickOutside>
      <div style={{display:"flex",flexWrap:"wrap",gap:"0 14px"}}>
        <Field label="Nom du vendeur"><input style={inp} placeholder="ex: Drouot, Deloys..." value={fa.vendeur} onChange={e=>setFa(p=>({...p,vendeur:e.target.value}))}/></Field>
        <Field label="Date d'achat"><input style={{...inp,cursor:"pointer"}} type="date" value={fa.date} onClick={e=>{try{e.target.showPicker()}catch(ex){}}} onChange={e=>setFa(p=>({...p,date:e.target.value}))}/></Field>
        <Field label="Montant total €"><input style={inp} type="number" step="0.01" value={fa.montant} onChange={e=>setFa(p=>({...p,montant:+e.target.value}))}/></Field>
        <Field label="Notes" w="1 1 100%"><textarea style={{...inp,minHeight:60,resize:"vertical"}} value={fa.notes} onChange={e=>setFa(p=>({...p,notes:e.target.value}))}/></Field>
        <div style={{display:"flex",gap:12,width:"100%",justifyContent:"flex-end",marginTop:10}}>
          <button style={btnS} onClick={()=>setMoAchat(false)}>Annuler</button>
          <button style={btnP} disabled={!fa.vendeur} onClick={handleCreateAchat}>Créer l'achat</button>
        </div>
      </div>
    </Modal>

    {/* Modal: Modifier l'achat */}
    <Modal open={moEditAchat} onClose={()=>{setMoEditAchat(false);setEditAchatData(null)}} title={"Modifier l'achat"+(editAchatData?" — N°"+editAchatData.venteNum:"")} noClickOutside>
      <div style={{display:"flex",flexWrap:"wrap",gap:"0 14px"}}>
        <Field label="Nom du vendeur"><input style={inp} value={fa.vendeur} onChange={e=>setFa(p=>({...p,vendeur:e.target.value}))}/></Field>
        <Field label="Date d'achat"><input style={{...inp,cursor:"pointer"}} type="date" value={fa.date} onClick={e=>{try{e.target.showPicker()}catch(ex){}}} onChange={e=>setFa(p=>({...p,date:e.target.value}))}/></Field>
        <Field label="Montant total €"><input style={inp} type="number" step="0.01" value={fa.montant} onChange={e=>setFa(p=>({...p,montant:+e.target.value}))}/></Field>
        <Field label="Notes" w="1 1 100%"><textarea style={{...inp,minHeight:60,resize:"vertical"}} value={fa.notes} onChange={e=>setFa(p=>({...p,notes:e.target.value}))}/></Field>
        <div style={{display:"flex",gap:12,width:"100%",justifyContent:"flex-end",marginTop:10}}>
          <button style={btnS} onClick={()=>{setMoEditAchat(false);setEditAchatData(null)}}>Annuler</button>
          <button style={btnP} onClick={handleEditAchat}>Enregistrer</button>
        </div>
      </div>
    </Modal>

    {/* Modal: Saisir des frais */}
    <Modal open={moDep} onClose={()=>{setMoDep(false);setEditExp(null)}} title={editExp?"Modifier le frais":"Saisir des frais"} noClickOutside>
      <div style={{display:"flex",flexWrap:"wrap",gap:"0 14px"}}>
        <Field label="Catégorie"><select style={sel} value={f.categorie} onChange={e=>sf("categorie",e.target.value)}>{["Frais de livraison","Matériel","Autres"].map(x=><option key={x}>{x}</option>)}</select></Field>
        <Field label="Date"><input style={{...inp,cursor:"pointer"}} type="date" value={f.date} onClick={e=>{try{e.target.showPicker()}catch(ex){}}} onChange={e=>sf("date",e.target.value)}/></Field>
        <Field label="Type"><select style={sel} value={f.recurrence} onChange={e=>sf("recurrence",e.target.value)}><option value="ponctuel">Ponctuel</option><option value="recurrent">Récurrent</option></select></Field>
        {f.recurrence==="recurrent"&&<Field label="Fréquence"><select style={sel} value={f.frequence} onChange={e=>sf("frequence",e.target.value)}><option value="mensuel">Mensuel</option><option value="trimestriel">Trimestriel</option><option value="annuel">Annuel</option></select></Field>}
        <Field label="Affecté à"><select style={sel} value={f.affectation==="toutes"?"TOUTES":f.affectation==="personnalise"?"CUSTOM":f.venteNum} onChange={e=>{const v=e.target.value;if(v==="TOUTES")sf("affectation","toutes");else if(v==="CUSTOM")sf("affectation","personnalise");else{sf("affectation","vente");sf("venteNum",v)}}}>{Object.entries(venteNames).map(([k,v])=><option key={k} value={k}>{v}</option>)}<option value="TOUTES">— Toutes les ventes —</option><option value="CUSTOM">— Personnalisé (période) —</option></select></Field>
        {f.affectation==="personnalise"&&<>
          <Field label="Du"><input style={{...inp,cursor:"pointer"}} type="date" value={f.dateDe} onClick={e=>{try{e.target.showPicker()}catch(ex){}}} onChange={e=>sf("dateDe",e.target.value)}/></Field>
          <Field label="Au"><input style={{...inp,cursor:"pointer"}} type="date" value={f.dateA} onClick={e=>{try{e.target.showPicker()}catch(ex){}}} onChange={e=>sf("dateA",e.target.value)}/></Field>
        </>}
        <Field label="Vendeur / Fournisseur"><input style={inp} value={f.vendeur} onChange={e=>sf("vendeur",e.target.value)}/></Field>
        <Field label="Montant €"><input style={inp} type="number" step="0.01" value={f.montant} onChange={e=>sf("montant",+e.target.value)}/></Field>
        <Field label="Description" w="1 1 100%"><input style={inp} value={f.description} onChange={e=>sf("description",e.target.value)}/></Field>
        <div style={{display:"flex",gap:12,width:"100%",justifyContent:"flex-end",marginTop:10}}>
          <button style={btnS} onClick={()=>{setMoDep(false);setEditExp(null)}}>Annuler</button>
          <button style={btnP} onClick={handleAddFrais}>{editExp?"Enregistrer":"Ajouter"}</button>
        </div>
      </div>
    </Modal>
  </div>);
};

// ─── Enchères ──────────────────────────────────────────────────────
const Encheres=()=>{
  const [ventes,setVentes]=useState([
    {id:1,titre:"Livres anciens & Manuscrits",maison:"Hôtel Drouot",date:"2026-03-05",heure:"14:00",lieu:"Paris",lots:"~120 lots",statut:"À venir",url:"https://www.interencheres.com/"},
    {id:2,titre:"Bibliothèque d'un amateur - Livres du XVIIIe",maison:"Millon",date:"2026-03-12",heure:"10:30",lieu:"Paris",lots:"~85 lots",statut:"À venir",url:"https://www.interencheres.com/"},
    {id:3,titre:"Voyages, Atlas & Géographie",maison:"Ader Nordmann",date:"2026-02-28",heure:"14:00",lieu:"Paris",lots:"~60 lots",statut:"En cours",url:"https://www.interencheres.com/"}
  ]);
  const [filtre,setFiltre]=useState("tous");
  const filtrees=filtre==="tous"?ventes:ventes.filter(v=>v.statut===filtre);
  return(<div>
    <div style={{display:"flex",flexWrap:"wrap",gap:14,marginBottom:28}}>
      <Stat label="Ventes suivies" value={ventes.length} accent="#c9a84c"/>
      <Stat label="En cours" value={ventes.filter(v=>v.statut==="En cours").length} accent="#e6524c"/>
      <Stat label="À venir" value={ventes.filter(v=>v.statut==="À venir").length} accent="#4c8cc9"/>
    </div>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:12,marginBottom:20}}>
      <div style={{display:"flex",gap:6}}>
        {["tous","En cours","À venir"].map(f=>(<button key={f} onClick={()=>setFiltre(f)} style={{padding:"7px 14px",border:"none",borderRadius:8,background:filtre===f?"linear-gradient(135deg,#c9a84c22,#c9a84c11)":"#0a0f1e",color:filtre===f?"#c9a84c":"#4a5a7a",fontSize:11,fontWeight:600,cursor:"pointer",fontFamily:"'JetBrains Mono',monospace",border:"1px solid "+(filtre===f?"#c9a84c33":"#1a2540")}}>{f==="tous"?"Toutes":f}</button>))}
      </div>
      <button onClick={()=>{window.open("https://www.interencheres.com/recherche/lots?search_text=livres+anciens&categorySlugs%5B%5D=livres-manuscrits-et-autographes","_blank")}} style={{...btnP,padding:"9px 16px",fontSize:11,display:"flex",alignItems:"center",gap:6}}>🔍 Chercher sur Interenchères</button>
    </div>
    <div style={{...c}}>
      <h3 style={{margin:"0 0 16px",fontSize:13,textTransform:"uppercase",letterSpacing:2,color:"#6a7a9a",fontFamily:"'JetBrains Mono',monospace"}}>Ventes aux enchères</h3>
      {filtrees.length===0&&<div style={{color:"#4a5a7a",fontSize:13,textAlign:"center",padding:40}}>Aucune vente pour ce filtre</div>}
      {filtrees.map(v=>(<div key={v.id} style={{padding:"16px 0",borderBottom:"1px solid #111827"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:12,flexWrap:"wrap"}}>
          <div style={{flex:1}}>
            <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:6}}>
              <span style={{padding:"3px 8px",borderRadius:4,fontSize:9,fontWeight:700,fontFamily:"'JetBrains Mono',monospace",background:v.statut==="En cours"?"#e6524c22":"#4c8cc922",color:v.statut==="En cours"?"#e6524c":"#4c8cc9",border:"1px solid "+(v.statut==="En cours"?"#e6524c44":"#4c8cc944")}}>{v.statut}</span>
              <span style={{color:"#e6f1ff",fontWeight:600,fontSize:14,fontFamily:"'Playfair Display',serif"}}>{v.titre}</span>
            </div>
            <div style={{display:"flex",gap:16,fontSize:11,fontFamily:"'JetBrains Mono',monospace",flexWrap:"wrap",color:"#6a7a9a"}}>
              <span>🏛 {v.maison}</span>
              <span>📅 {fmtD(v.date)} à {v.heure}</span>
              <span>📍 {v.lieu}</span>
              <span>📦 {v.lots}</span>
            </div>
          </div>
          <button onClick={()=>{window.open(v.url,"_blank")}} style={{...btnS,padding:"7px 14px",fontSize:10,whiteSpace:"nowrap"}}>Voir le catalogue →</button>
        </div>
      </div>))}
    </div>
    <div style={{...c,marginTop:20}}>
      <h3 style={{margin:"0 0 12px",fontSize:13,textTransform:"uppercase",letterSpacing:2,color:"#6a7a9a",fontFamily:"'JetBrains Mono',monospace"}}>💡 À développer</h3>
      <div style={{fontSize:12,color:"#4a5a7a",lineHeight:1.8,fontFamily:"'JetBrains Mono',monospace"}}>
        • Recherche automatique sur Interenchères (livres anciens, manuscrits)<br/>
        • Alertes sur les ventes à venir par catégorie / thème<br/>
        • Suivi des lots favoris avec estimation de prix<br/>
        • Historique des enchères passées et résultats<br/>
        • Notes et annotations par vente
      </div>
    </div>
  </div>);
};

// ─── App ────────────────────────────────────────────────────────────
function App(){
  const [books,setBooks]=useState([]);
  const [expenses,setExpenses]=useState([]);
  const [tab,setTab]=useState("dashboard");
  const [loading,setLoading]=useState(true);
  const [syncMsg,setSyncMsg]=useState("");

  const [recalcTrigger,setRecalcTrigger]=useState(0);

  // Auto-recompute pxAchat whenever expenses change or recalc is triggered
  useEffect(()=>{
    if(!books.length)return;
    const pxMap=computePxAchat(books,expenses);
    let changed=false;
    const updated=books.map(b=>{
      const newPx=pxMap[b.id]!==undefined?pxMap[b.id]:b.pxAchat;
      if(Math.abs(newPx-(b.pxAchat||0))>0.005){changed=true;return{...b,pxAchat:newPx}}
      return b;
    });
    if(changed)setBooks(updated);
  },[expenses,recalcTrigger]);

  useEffect(()=>{(async()=>{try{
    const bRes=await fetch(SB_URL+"/rest/v1/livres?select=*&order=id.asc",{headers:{"apikey":SB_KEY,"Authorization":"Bearer "+SB_KEY}});
    const bData=bRes.ok?await bRes.json():[];
    const eRes=await fetch(SB_URL+"/rest/v1/depenses?select=*&order=id.asc",{headers:{"apikey":SB_KEY,"Authorization":"Bearer "+SB_KEY}});
    const eData=eRes.ok?await eRes.json():[];
    if(bData.length===0){
      setSyncMsg("Initialisation...");
      for(let i=0;i<IMPORTED_BOOKS.length;i+=10){await fetch(SB_URL+"/rest/v1/livres",{method:"POST",headers:SB_H,body:JSON.stringify(IMPORTED_BOOKS.slice(i,i+10).map(bookToDb))})}
      for(let i=0;i<IMPORTED_EXPENSES.length;i+=10){await fetch(SB_URL+"/rest/v1/depenses",{method:"POST",headers:SB_H,body:JSON.stringify(IMPORTED_EXPENSES.slice(i,i+10).map(expToDb))})}
      setBooks(IMPORTED_BOOKS);setExpenses(IMPORTED_EXPENSES);setSyncMsg("✓ Base initialisée");
    }else{setBooks(bData.map(dbToBook));
      const exps=eData.map(dbToExp);
      // Migrate G -> TOUTES
      exps.forEach(e=>{if(e.venteNum==="G"){e.venteNum="TOUTES";if(e.id){try{fetch(SB_URL+"/rest/v1/depenses?id=eq."+e.id,{method:"PATCH",headers:SB_H,body:JSON.stringify({vente_num:"TOUTES"})})}catch(ex){}}}});
      // Migrate Achat 0 if still old format
      const a0=exps.find(e=>e.venteNum==="0"&&(e.categorie==="Divers"||e.vendeur==="-"));
      if(a0){a0.categorie="Achat de livres";a0.vendeur="Gratuit";a0.date="2025-01-01";a0.description="Livres obtenus gratuitement";a0.montant=0;
        if(a0.id){try{fetch(SB_URL+"/rest/v1/depenses?id=eq."+a0.id,{method:"PATCH",headers:SB_H,body:JSON.stringify({categorie:"Achat de livres",vendeur:"Gratuit",date:"2025-01-01",description:"Livres obtenus gratuitement",montant:0})})}catch(e){}}
      }
      // Ensure Achat 0 exists — if no entry with venteNum "0" and categorie "Achat de livres", inject one
      if(!exps.some(e=>e.venteNum==="0"&&e.categorie==="Achat de livres")){
        const newA0={venteNum:"0",date:"2025-01-01",categorie:"Achat de livres",vendeur:"Gratuit",montant:0,description:"Livres obtenus gratuitement"};
        exps.unshift(newA0);
        try{fetch(SB_URL+"/rest/v1/depenses",{method:"POST",headers:SB_H,body:JSON.stringify(expToDb(newA0))})}catch(ex){}
      }
      // Purge Commission eBay entries (no longer tracked as expenses)
      const commIds=exps.filter(e=>e.categorie==="Commission eBay").map(e=>e.id).filter(Boolean);
      commIds.forEach(id=>{try{fetch(SB_URL+"/rest/v1/depenses?id=eq."+id,{method:"DELETE",headers:{"apikey":SB_KEY,"Authorization":"Bearer "+SB_KEY}})}catch(e){}});
      const cleaned=exps.filter(e=>e.categorie!=="Commission eBay");
      // Rename Frais d'envoi (Colissimo) -> Frais d'envoi
      cleaned.forEach(e=>{if(e.categorie==="Frais d'envoi (Colissimo)"){e.categorie="Frais d'envoi";if(e.id){try{fetch(SB_URL+"/rest/v1/depenses?id=eq."+e.id,{method:"PATCH",headers:SB_H,body:JSON.stringify({categorie:"Frais d'envoi"})})}catch(ex){}}}});
      setExpenses(cleaned);setSyncMsg("✓ "+bData.length+" livres")}
  }catch(err){setBooks(IMPORTED_BOOKS);setExpenses(IMPORTED_EXPENSES);setSyncMsg("✗ Mode hors-ligne")}
  setLoading(false);setTimeout(()=>setSyncMsg(""),4000)})()},[]);

  const addBook=async(b)=>{setBooks(p=>[...p,b]);setRecalcTrigger(t=>t+1);try{await fetch(SB_URL+"/rest/v1/livres",{method:"POST",headers:SB_H,body:JSON.stringify(bookToDb(b))})}catch(e){}};
  const editBook=async(b)=>{setBooks(p=>p.map(x=>x.id===b.id?b:x));setRecalcTrigger(t=>t+1);try{await fetch(SB_URL+"/rest/v1/livres?id=eq."+encodeURIComponent(b.id),{method:"PATCH",headers:SB_H,body:JSON.stringify(bookToDb(b))})}catch(e){}};
  const deleteBook=async(id)=>{setBooks(p=>p.filter(x=>x.id!==id));try{await fetch(SB_URL+"/rest/v1/livres?id=eq."+encodeURIComponent(id),{method:"DELETE",headers:{"apikey":SB_KEY,"Authorization":"Bearer "+SB_KEY}})}catch(e){}};
  const addExpense=async(e)=>{setExpenses(p=>[...p,e]);try{await fetch(SB_URL+"/rest/v1/depenses",{method:"POST",headers:SB_H,body:JSON.stringify(expToDb(e))})}catch(e2){}};
  const deleteExpense=async(idx)=>{const exp=expenses[idx];setExpenses(p=>p.filter((_,i)=>i!==idx));if(exp&&exp.id){try{await fetch(SB_URL+"/rest/v1/depenses?id=eq."+exp.id,{method:"DELETE",headers:{"apikey":SB_KEY,"Authorization":"Bearer "+SB_KEY}})}catch(e){}}};
  const syncBookExpense=(bookId,categorie,data)=>{
    // data={venteNum,date,vendeur,montant,description} or null to delete
    const tag="livre #"+bookId;
    setExpenses(prev=>{
      const idx=prev.findIndex(e=>(e.categorie===categorie||e.categorie==="Frais d'envoi (Colissimo)"&&categorie==="Frais d'envoi")&&e.description&&e.description.toLowerCase().includes(tag.toLowerCase()));
      if(!data||!data.montant||data.montant<=0){
        // Delete if exists
        if(idx>=0){const exp=prev[idx];if(exp.id){try{fetch(SB_URL+"/rest/v1/depenses?id=eq."+exp.id,{method:"DELETE",headers:{"apikey":SB_KEY,"Authorization":"Bearer "+SB_KEY}})}catch(e){}}return prev.filter((_,i)=>i!==idx)}
        return prev;
      }
      if(idx>=0){
        // Update existing
        const updated=[...prev];const old=updated[idx];updated[idx]={...old,...data,categorie};
        if(old.id){try{fetch(SB_URL+"/rest/v1/depenses?id=eq."+old.id,{method:"PATCH",headers:SB_H,body:JSON.stringify(expToDb({...data,categorie}))})}catch(e){}}
        return updated;
      } else {
        // Create new
        const newExp={...data,categorie};
        try{fetch(SB_URL+"/rest/v1/depenses",{method:"POST",headers:SB_H,body:JSON.stringify(expToDb(newExp))})}catch(e){}
        return [...prev,newExp];
      }
    });
  };
  if(loading)return(<div style={{minHeight:"100vh",background:"#080c18",display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:16}}>
    <div style={{fontSize:28,color:"#c9a84c"}}>📚</div>
    <div style={{color:"#8892b0",fontFamily:"'JetBrains Mono',monospace",fontSize:13}}>Chargement...</div>
  </div>);

  return(<div style={{minHeight:"100vh",background:"#080c18",color:"#ccd6f6",fontFamily:"'Georgia','Times New Roman',serif"}}>
    <header style={{background:"linear-gradient(135deg,#0d1525,#111827,#0d1525)",borderBottom:"1px solid #1a2540",padding:"16px 28px",display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:12}}>
      <div style={{display:"flex",alignItems:"center",gap:14}}>
        <div style={{fontSize:28,fontFamily:"'Playfair Display',serif",color:"#c9a84c"}}>📚</div>
        <div><h1 style={{margin:0,fontSize:20,fontWeight:700,color:"#e6f1ff",fontFamily:"'Playfair Display',serif",letterSpacing:1}}>Livres & Reliures</h1>
        <div style={{fontSize:10,color:"#3a4a6a",fontFamily:"'JetBrains Mono',monospace",letterSpacing:2,textTransform:"uppercase"}}>CRM · {books.length} ouvrages</div></div>
      </div>
      <div style={{display:"flex",gap:3,background:"#0a0f1e",borderRadius:10,padding:3,border:"1px solid #1a2540",flexWrap:"wrap"}}>
        {TABS.map(t=>(<button key={t.key} onClick={()=>setTab(t.key)} style={{padding:"9px 14px",border:"none",borderRadius:8,background:tab===t.key?"linear-gradient(135deg,#c9a84c22,#c9a84c11)":"transparent",color:tab===t.key?"#c9a84c":"#4a5a7a",fontSize:12,fontWeight:600,cursor:"pointer",fontFamily:"'JetBrains Mono',monospace",transition:"all .2s"}}><span style={{marginRight:5}}>{t.icon}</span>{t.label}</button>))}
      </div>
      <div style={{display:"flex",alignItems:"center",gap:12}}>
        {syncMsg&&<div style={{fontSize:10,fontFamily:"'JetBrains Mono',monospace",color:syncMsg.startsWith("✓")?"#4cc98c":syncMsg.startsWith("✗")?"#c94c4c":"#8ab4f8"}}>{syncMsg}</div>}
        <button onClick={()=>exportCSV(books)} style={{...btnS,padding:"9px 16px",fontSize:11}}>⬇ Export CSV</button>
      </div>
    </header>
    <main style={{padding:"24px 28px",maxWidth:1440,margin:"0 auto"}}>
      {tab==="dashboard"&&<Dashboard books={books} expenses={expenses}/>}
      {tab==="inventaire"&&<Inventaire books={books} expenses={expenses} onAdd={addBook} onEdit={editBook} onDelete={deleteBook} onSyncExpense={syncBookExpense}/>}
      {tab==="ventes"&&<Ventes books={books} expenses={expenses}/>}
      {tab==="sourcing"&&<Sourcing books={books} expenses={expenses}/>}
      {tab==="depenses"&&<Depenses expenses={expenses} onAdd={addExpense} onDelete={deleteExpense} books={books}/>}
      {tab==="encheres"&&<Encheres/>}
    </main>
  </div>);
}

ReactDOM.render(<App/>,document.getElementById("root"));
</script>
</body>
</html>
