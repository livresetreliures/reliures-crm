<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reliures & Livres — CRM</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#080c18;color:#ccd6f6;font-family:'Georgia','Times New Roman',serif}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:#0a0f1e}
::-webkit-scrollbar-thumb{background:#1e2d4a;border-radius:3px}
input:focus,select:focus,textarea:focus{border-color:#c9a84c!important;outline:none}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useMemo,useCallback} = React;

// ─── Supabase Config ─────────────────────────────────────────────
const SB_URL="https://eruxkubcprvmrqiwycvl.supabase.co";
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVydXhrdWJjcHJ2bXJxaXd5Y3ZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MzAzOTksImV4cCI6MjA4NzAwNjM5OX0.oSwLDUODs_CcmTyrMGyMbxcDH1wJ4o9l-7cxxAk2Zi0";
const SB_H={"apikey":SB_KEY,"Authorization":"Bearer "+SB_KEY,"Content-Type":"application/json","Prefer":"return=representation"};
const bookToDb=(b)=>({id:b.id,titre:b.titre||"",auteur:b.auteur||"",date:b.date||"",editeur:b.editeur||"",lieu_edition:b.lieuEdition||"",completion:b.completion||"",categorie:b.categorie||"",nb_vol:b.nbVol||0,siecle:b.siecle||0,eo:b.eo||"",theme:b.theme||"",etat:b.etat||"",format:b.format||"",nb_pages:b.nbPages||0,poids:b.poids||0,stockage:b.stockage||"",num_achat:b.numAchat||"",date_achat:b.dateAchat||"",px_achat:b.pxAchat||0,total_achat:b.totalAchat||0,lieu_achat:b.lieuAchat||"",publie:b.publie||"Non",vendu:b.vendu||"Non",date_mise_en_vente:b.dateMiseEnVente||"",date_vente:b.dateVente||"",duree_vente:b.dureeVente||"",px_mise_en_vente:b.pxMiseEnVente||0,px_encaisse:b.pxEncaisse||0,modalites:b.modalites||"",livre:b.livre||"",frais_expedition:b.fraisExpedition||0,benef_attendu:b.benefAttendu||0,benef_realise:b.benefRealise||0,difference:b.difference||0,prix_conseille_ia:b.prixConseilleIA||0,carac_spec:b.caracSpec||{frontispice:false,gravures:false,exLibris:false,cartes:false,illustrations:false},annonce_html:b.annonceHtml||"",updated_at:new Date().toISOString()});
const dbToBook=(r)=>({id:r.id,titre:r.titre||"",auteur:r.auteur||"",date:r.date||"",editeur:r.editeur||"",lieuEdition:r.lieu_edition||"",completion:r.completion||"",categorie:r.categorie||"",nbVol:r.nb_vol||0,siecle:r.siecle||0,eo:r.eo||"",theme:r.theme||"",etat:r.etat||"",format:r.format||"",nbPages:r.nb_pages||0,poids:r.poids||0,stockage:r.stockage||"",numAchat:r.num_achat||"",dateAchat:r.date_achat||"",pxAchat:r.px_achat||0,totalAchat:r.total_achat||0,lieuAchat:r.lieu_achat||"",publie:r.publie||"Non",vendu:r.vendu||"Non",dateMiseEnVente:r.date_mise_en_vente||"",dateVente:r.date_vente||"",dureeVente:r.duree_vente||"",pxMiseEnVente:r.px_mise_en_vente||0,pxEncaisse:r.px_encaisse||0,modalites:r.modalites||"",livre:r.livre||"",fraisExpedition:r.frais_expedition||0,benefAttendu:r.benef_attendu||0,benefRealise:r.benef_realise||0,difference:r.difference||0,prixConseilleIA:r.prix_conseille_ia||0,caracSpec:r.carac_spec||{},annonceHtml:r.annonce_html||""});
const expToDb=(e)=>({vente_num:e.venteNum||"",date:e.date||"",categorie:e.categorie||"",vendeur:e.vendeur||"",description:e.description||"",montant:e.montant||0});
const dbToExp=(r)=>({id:r.id,venteNum:r.vente_num||"",date:r.date||"",categorie:r.categorie||"",vendeur:r.vendeur||"",description:r.description||"",montant:r.montant||0});

// ─── Data ───────────────────────────────────────────────────────────
const IMPORTED_BOOKS = [{"id":"1","titre":"Histoire des Révolutions de Corse","auteur":"Abbé de Germanes","date":"1771","editeur":"","completion":"2/2","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"EO","theme":"Histoire","etat":"Bon","format":"In 12","poids":0.715,"stockage":"1","numAchat":"1","dateAchat":"2025-09-24","pxAchat":63.56,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Oui","dateMiseEnVente":"2025-10-14","dateVente":"2025-10-16","dureeVente":"2 jours","pxMiseEnVente":500,"pxEncaisse":400,"modalites":"Ebay","livre":"OK","fraisExpedition":10,"benefAttendu":426.44,"benefRealise":326.44,"difference":-100},{"id":"2","titre":"Mélange critique de littérature","auteur":"La Morlière","date":"1701","editeur":"Pierre Brunel","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"Non","theme":"Littérature","etat":"Bon","format":"In 12","poids":0.326,"stockage":"1","numAchat":"1","dateAchat":"2025-09-24","pxAchat":12.71,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-10-19","dateVente":"","dureeVente":"121 jours","pxMiseEnVente":100,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":87.29,"benefRealise":0,"difference":0},{"id":"3","titre":"L'esprit de Montaigne","auteur":"Montaigne","date":"1783","editeur":"","completion":"2/2","categorie":"Ouvrage","nbVol":2,"siecle":18,"eo":"Non","theme":"Philosophie","etat":"Bon","format":"In 18","poids":0.318,"stockage":"1","numAchat":"1","dateAchat":"2025-09-24","pxAchat":15.25,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-10-19","dateVente":"","dureeVente":"121 jours","pxMiseEnVente":120,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":104.75,"benefRealise":0,"difference":0},{"id":"4","titre":"Récit des temps Mérovingiens","auteur":"A. Thierry","date":"1846","editeur":"Furne & Cie","completion":"2/2","categorie":"Ouvrage","nbVol":2,"siecle":19,"eo":"Non","theme":"Histoire","etat":"Excellent","format":"In 12","poids":0.868,"stockage":"3","numAchat":"1","dateAchat":"2025-09-29","pxAchat":6.36,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-09","dateVente":"","dureeVente":"100 jours","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":43.64,"benefRealise":0,"difference":0},{"id":"5","titre":"Formulaire de prières à l'usage des Ursulines de Metz","auteur":"-","date":"1717","editeur":"Brice Antoine","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"Non","theme":"Religion","etat":"Bon","format":"In 12","poids":0.386,"stockage":"1","numAchat":"1","dateAchat":"2025-09-29","pxAchat":12.71,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-12","dateVente":"","dureeVente":"97 jours","pxMiseEnVente":100,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":87.29,"benefRealise":0,"difference":0},{"id":"6","titre":"L'esprit de Saint François de Sales","auteur":"Mgr Camus","date":"1740","editeur":"","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"Non","theme":"Religion","etat":"Bon","format":"In 12","poids":0.495,"stockage":"1","numAchat":"1","dateAchat":"2025-09-29","pxAchat":12.71,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-13","dateVente":"","dureeVente":"96 jours","pxMiseEnVente":100,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":87.29,"benefRealise":0,"difference":0},{"id":"7","titre":"Bucoliques","auteur":"Virgile","date":"1812","editeur":"Delaunay","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Poésie","etat":"Bon","format":"In 12","poids":0.263,"stockage":"3","numAchat":"1","dateAchat":"2025-09-29","pxAchat":7.63,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-09","dateVente":"","dureeVente":"100 jours","pxMiseEnVente":60,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":52.37,"benefRealise":0,"difference":0},{"id":"8","titre":"La Satyre de Petrone","auteur":"-","date":"1694","editeur":"Pierre Marteau","completion":"1/2","categorie":"Ouvrage","nbVol":1,"siecle":17,"eo":"EO","theme":"Littérature","etat":"Moyen","format":"In 12","poids":0.235,"stockage":"1","numAchat":"1","dateAchat":"2025-09-29","pxAchat":12.71,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-14","dateVente":"","dureeVente":"95 jours","pxMiseEnVente":100,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":87.29,"benefRealise":0,"difference":0},{"id":"9","titre":"Le devoir des pasteurs","auteur":"-","date":"1699","editeur":"François Godard","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":17,"eo":"EO","theme":"Religion","etat":"Bon","format":"In 12","poids":0.265,"stockage":"1","numAchat":"1","dateAchat":"2025-09-29","pxAchat":25.42,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-15","dateVente":"","dureeVente":"94 jours","pxMiseEnVente":200,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":174.58,"benefRealise":0,"difference":0},{"id":"10","titre":"Recueil de pièces sur la religion","auteur":"-","date":"1755","editeur":"Veuve Bordelet","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"EO","theme":"Religion","etat":"Bon","format":"In 12","poids":0.46,"stockage":"1","numAchat":"1","dateAchat":"2025-09-29","pxAchat":19.07,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-16","dateVente":"","dureeVente":"93 jours","pxMiseEnVente":150,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":130.93,"benefRealise":0,"difference":0},{"id":"11","titre":"Office de l'Eglise","auteur":"-","date":"1821","editeur":"Mégard","completion":"4/4","categorie":"Ouvrage","nbVol":4,"siecle":19,"eo":"EO","theme":"Religion","etat":"Bon","format":"In 12","poids":2.483,"stockage":"3","numAchat":"1","dateAchat":"2025-09-29","pxAchat":12.71,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-09","dateVente":"","dureeVente":"100 jours","pxMiseEnVente":100,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":87.29,"benefRealise":0,"difference":0},{"id":"12","titre":"Salammbô","auteur":"Gustave Flaubert","date":"1864","editeur":"Michel Levy frères","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Littérature","etat":"Moyen","format":"In 12","poids":0.4,"stockage":"3","numAchat":"1","dateAchat":"2025-09-29","pxAchat":6.36,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-09","dateVente":"","dureeVente":"100 jours","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":43.64,"benefRealise":0,"difference":0},{"id":"13","titre":"Lot de 25 volumes du 18ème (comprenant 18 volumes de l'Histoire de France de M. Garnier)","auteur":"-","date":"-","editeur":"-","completion":"","categorie":"Lot","nbVol":25,"siecle":18,"eo":"Non","theme":"","etat":"","format":"","poids":0,"stockage":"1","numAchat":"1","dateAchat":"2025-09-29","pxAchat":75,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"","vendu":"","dateMiseEnVente":"","dateVente":"","dureeVente":"","pxMiseEnVente":250,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":175,"benefRealise":0,"difference":0},{"id":"14","titre":"Théâtre complet - A. de Vigny","auteur":"A. de Vigny","date":"1841","editeur":"Charpentier","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"EO","theme":"Littérature","etat":"Bon","format":"In 12","poids":0.354,"stockage":"3","numAchat":"1","dateAchat":"2025-09-29","pxAchat":6.36,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-09","dateVente":"","dureeVente":"100 jours","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":43.64,"benefRealise":0,"difference":0},{"id":"15","titre":"Profils et Grimaces","auteur":"Auguste Vacquerie","date":"1856","editeur":"Michel Levy Frères","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"EO","theme":"Littérature","etat":"Moyen","format":"In 12","poids":0.357,"stockage":"3","numAchat":"1","dateAchat":"2025-09-29","pxAchat":3.81,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-09","dateVente":"","dureeVente":"100 jours","pxMiseEnVente":30,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":26.19,"benefRealise":0,"difference":0},{"id":"16","titre":"Lot de 9 ouvrages du 19ème","auteur":"-","date":"-","editeur":"-","completion":"-","categorie":"Lot","nbVol":9,"siecle":19,"eo":"Non","theme":"Divers","etat":"Bon","format":"","poids":0,"stockage":"0","numAchat":"1","dateAchat":"2025-09-29","pxAchat":18,"totalAchat":310.38,"lieuAchat":"Inter Ville CP","publie":"","vendu":"","dateMiseEnVente":"","dateVente":"","dureeVente":"","pxMiseEnVente":45,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":27,"benefRealise":0,"difference":0},{"id":"17","titre":"Paul et Virginie","auteur":"Bernadin de Saint Pierre","date":"1868","editeur":"Alphonse Lemerre","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Littérature","etat":"Bon","format":"In Folio","poids":2.655,"stockage":"4","numAchat":"3","dateAchat":"2025-10-22","pxAchat":8.81,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-08","dateVente":"","dureeVente":"101 jours","pxMiseEnVente":100,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":91.19,"benefRealise":0,"difference":0},{"id":"18","titre":"Beautés de l'histoire de Russie","auteur":"PJB Nougaret","date":"1814","editeur":"Le Prieur","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"EO","theme":"Histoire","etat":"Bon","format":"In 12","poids":0.349,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":10.49,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-16","dateVente":"","dureeVente":"1 jours","pxMiseEnVente":119,"pxEncaisse":90,"modalites":"Ebay","livre":"Non","fraisExpedition":0,"benefAttendu":108.51,"benefRealise":0,"difference":0},{"id":"19","titre":"L'abeille littéraire","auteur":"-","date":"1779","editeur":"-","completion":"4/4","categorie":"Ouvrage","nbVol":4,"siecle":18,"eo":"EO","theme":"Littérature","etat":"Bon","format":"In 8","poids":1.9,"stockage":"1","numAchat":"3","dateAchat":"2025-10-22","pxAchat":21.59,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-13","dateVente":"","dureeVente":"4 jours","pxMiseEnVente":245,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":223.41,"benefRealise":0,"difference":0},{"id":"20","titre":"The last of the Mortimers","auteur":"Margaret Oliphant","date":"1862","editeur":"B. Tauchnitz","completion":"2/2","categorie":"Ouvrage","nbVol":2,"siecle":19,"eo":"Oui","theme":"Littérature","etat":"Bon","format":"In 16","poids":0.5,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":8.52,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-23","dateVente":"","dureeVente":"","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":41.48,"benefRealise":0,"difference":0},{"id":"21","titre":"Œuvres poétiques (seconde partie)","auteur":"Gresset","date":"1741","editeur":"Pelissart","completion":"1/2","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"EO","theme":"Poésie","etat":"Moyen","format":"In 12","poids":0.274,"stockage":"1","numAchat":"3","dateAchat":"2025-10-22","pxAchat":4.41,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-14","dateVente":"","dureeVente":"3 jours","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":45.59,"benefRealise":0,"difference":0},{"id":"22","titre":"Ordonnance de Louis XIV","auteur":"-","date":"1720","editeur":"-","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"Non","theme":"Droit","etat":"Bon","format":"In 12","poids":0.22,"stockage":"1","numAchat":"3","dateAchat":"2025-10-22","pxAchat":10.49,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-12","dateVente":"","dureeVente":"5 jours","pxMiseEnVente":119,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":108.51,"benefRealise":0,"difference":0},{"id":"23","titre":"Hermès ou recherches philosophiques sur la grammaire universelle","auteur":"Jacques Harris","date":"1796","editeur":"-","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"EO","theme":"Philosophie","etat":"Moyen","format":"In 8","poids":0.59,"stockage":"1","numAchat":"3","dateAchat":"2025-10-22","pxAchat":8.37,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-15","dateVente":"","dureeVente":"2 jours","pxMiseEnVente":95,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":86.63,"benefRealise":0,"difference":0},{"id":"24","titre":"Réflexions et menus-propos d'un peintre genevois","auteur":"R. Topffer","date":"1878","editeur":"Hachette","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Art & architecture","etat":"Excellent","format":"In 12","poids":0.6,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":1.76,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-17","dateVente":"","dureeVente":"0 jours","pxMiseEnVente":20,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":18.24,"benefRealise":0,"difference":0},{"id":"25","titre":"Barthèle ou encore une victime de la jalousie","auteur":"M. Duronceray","date":"1808","editeur":"Chaumerot","completion":"2/2","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"EO","theme":"Littérature","etat":"Moyen","format":"In 12","poids":0.23,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":5.2,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-18","dateVente":"","dureeVente":"","pxMiseEnVente":59,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":53.8,"benefRealise":0,"difference":0},{"id":"26","titre":"Dictionnaire raisonné universel d'histoire naturelle","auteur":"Valmont de Bomare","date":"1768","editeur":"Lacombe","completion":"6/6","categorie":"Ouvrage","nbVol":6,"siecle":18,"eo":"Non","theme":"Sciences et mathématiques","etat":"Bon","format":"In 8","poids":2.9,"stockage":"1","numAchat":"3","dateAchat":"2025-10-22","pxAchat":22.03,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-11","dateVente":"","dureeVente":"6 jours","pxMiseEnVente":250,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":227.97,"benefRealise":0,"difference":0},{"id":"27","titre":"Fables","auteur":"John Gay","date":"1813","editeur":"Didot","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Poésie","etat":"Excellent","format":"In 12","poids":0.12,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":4.32,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-19","dateVente":"","dureeVente":"","pxMiseEnVente":49,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":44.68,"benefRealise":0,"difference":0},{"id":"28","titre":"Manuel complet des poids et mesures","auteur":"M. Tarbé","date":"1840","editeur":"Roret","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Sciences et mathématiques","etat":"Bon","format":"In 12","poids":0.27,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":3.08,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-20","dateVente":"","dureeVente":"","pxMiseEnVente":35,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":31.92,"benefRealise":0,"difference":0},{"id":"29","titre":"Chinese tales - Mandarin Fum-Hoam","auteur":"M. Gueulett","date":"1798","editeur":"Cooke","completion":"2/2","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"Non","theme":"Littérature","etat":"Bon","format":"In 12","poids":0.181,"stockage":"1","numAchat":"3","dateAchat":"2025-10-22","pxAchat":7.93,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-10","dateVente":"","dureeVente":"7 jours","pxMiseEnVente":90,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":82.07,"benefRealise":0,"difference":0},{"id":"30","titre":"Oeuvres illustrées","auteur":"Balzac","date":"1867","editeur":"Michel Levy Frères","completion":"5/5","categorie":"Ouvrage","nbVol":5,"siecle":19,"eo":"Non","theme":"Littérature","etat":"Bon","format":"In 4","poids":6.4,"stockage":"4","numAchat":"3","dateAchat":"2025-10-22","pxAchat":13.13,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-15","dateVente":"","dureeVente":"2 jours","pxMiseEnVente":149,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":135.87,"benefRealise":0,"difference":0},{"id":"31","titre":"Oeuvres complètes de Boileau","auteur":"Boileau","date":"1856","editeur":"Hachette","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Littérature","etat":"Bon","format":"In 8","poids":0.602,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":2.2,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-28","dateVente":"","dureeVente":"","pxMiseEnVente":25,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":22.8,"benefRealise":0,"difference":0},{"id":"32","titre":"Les cinq codes","auteur":"M. Pailliet","date":"1813","editeur":"Alphonse Garnery","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Droit","etat":"Mauvais","format":"In 12","poids":0.644,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":3.53,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-27","dateVente":"","dureeVente":"","pxMiseEnVente":40,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":36.47,"benefRealise":0,"difference":0},{"id":"33","titre":"Letters of Lady Mary Wortley Montague","auteur":"Mary W. Montague","date":"1793","editeur":"H.DD Symonds","completion":"2/2","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"Non","theme":"Voyages","etat":"Moyen","format":"In 12","poids":0.223,"stockage":"1","numAchat":"3","dateAchat":"2025-10-22","pxAchat":4.32,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-10","dateVente":"","dureeVente":"7 jours","pxMiseEnVente":49,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":44.68,"benefRealise":0,"difference":0},{"id":"34","titre":"Opuscules sur les sciences physiques","auteur":"AN Desvaux","date":"1831","editeur":"","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"EO","theme":"Sciences et mathématiques","etat":"Excellent","format":"In 8","poids":0.48,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":10.49,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-21","dateVente":"","dureeVente":"","pxMiseEnVente":119,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":108.51,"benefRealise":0,"difference":0},{"id":"35","titre":"Le Danube Allemand et l'Allemagne du Sud","auteur":"Hippolyte Durand","date":"1863","editeur":"A. Mame","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"EO","theme":"Voyages","etat":"Excellent","format":"In 4","poids":1.373,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":4.23,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-26","dateVente":"","dureeVente":"","pxMiseEnVente":48,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":43.77,"benefRealise":0,"difference":0},{"id":"36","titre":"Les lois rurales de la France","auteur":"M. Fournel","date":"1820","editeur":"Bossange","completion":"3/3","categorie":"Ouvrage","nbVol":3,"siecle":19,"eo":"Non","theme":"Droit","etat":"Bon","format":"In 8","poids":1.895,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":6.08,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-23","dateVente":"","dureeVente":"","pxMiseEnVente":69,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":62.92,"benefRealise":0,"difference":0},{"id":"37","titre":"Lord Oakburn's Daughters","auteur":"Mrs. Henry Wood","date":"1864","editeur":"Tauchnitz","completion":"2/2","categorie":"Ouvrage","nbVol":2,"siecle":19,"eo":"EO","theme":"Littérature","etat":"Bon","format":"In 12","poids":0.643,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":5.2,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-25","dateVente":"","dureeVente":"","pxMiseEnVente":59,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":53.8,"benefRealise":0,"difference":0},{"id":"38","titre":"Histoire d'Alger","auteur":"Stéphen d'Estry","date":"1841","editeur":"Ad Mame","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Oui","theme":"Histoire","etat":"Correct","format":"In 12","poids":0.55,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":13.63,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-24","dateVente":"","dureeVente":"","pxMiseEnVente":80,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":66.37,"benefRealise":0,"difference":0},{"id":"39","titre":"Les trois Marie","auteur":"Michel Masson","date":"1840","editeur":"Librairie de Dumont","completion":"2/2","categorie":"Ouvrage","nbVol":2,"siecle":19,"eo":"EO","theme":"Littérature","etat":"Bon","format":"In 8","poids":0.903,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":4.32,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-12","dateVente":"","dureeVente":"5 jours","pxMiseEnVente":49,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":44.68,"benefRealise":0,"difference":0},{"id":"40","titre":"Les écorcheurs ou l'usurpation et la peste","auteur":"Vicomte d'Arlincourt","date":"1833","editeur":"Eugène Renduel","completion":"2/2","categorie":"Ouvrage","nbVol":2,"siecle":19,"eo":"Non","theme":"Littérature","etat":"Bon","format":"In 8","poids":0.914,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":5.29,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-24","dateVente":"","dureeVente":"","pxMiseEnVente":60,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":54.71,"benefRealise":0,"difference":0},{"id":"41","titre":"Mémoires d'un prisonnier d'Etat au Spielberg","auteur":"A. Andryane","date":"1838","editeur":"Ladvocat","completion":"3/3","categorie":"Ouvrage","nbVol":3,"siecle":19,"eo":"Non","theme":"Histoire","etat":"Bon","format":"In 8","poids":1.403,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":13.22,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Non","vendu":"","dateMiseEnVente":"","dateVente":"","dureeVente":"","pxMiseEnVente":150,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":136.78,"benefRealise":0,"difference":0},{"id":"42","titre":"Mes loisirs","auteur":"Baronne de Montaran","date":"1846","editeur":"Librairie d'Amyot","completion":"2/2","categorie":"Ouvrage","nbVol":2,"siecle":19,"eo":"EO","theme":"Littérature","etat":"Bon","format":"In 8","poids":1.153,"stockage":"3","numAchat":"3","dateAchat":"2025-10-22","pxAchat":7.05,"totalAchat":187.55,"lieuAchat":"Deloys","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-22","dateVente":"","dureeVente":"","pxMiseEnVente":80,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":72.95,"benefRealise":0,"difference":0},{"id":"43","titre":"Sermons de M. Massillon","auteur":"M. Massillon","date":"1776","editeur":"La Veuve Estienne","completion":"","categorie":"Ouvrage","nbVol":4,"siecle":18,"eo":"Non","theme":"Religion","etat":"Bon","format":"In 12","poids":1.08,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":15.17,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-23","dateVente":"","dureeVente":"86 jours","pxMiseEnVente":89,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":73.83,"benefRealise":0,"difference":0},{"id":"44","titre":"Biblia sacra vulgatoe editionis","auteur":"-","date":"1741","editeur":"Frères Deville","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"Non","theme":"Religion","etat":"Bon","format":"In 12","poids":0.78,"stockage":"2","numAchat":"2","dateAchat":"2025-10-11","pxAchat":51.13,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2025-11-23","dateVente":"","dureeVente":"86 jours","pxMiseEnVente":300,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":248.87,"benefRealise":0,"difference":0},{"id":"45","titre":"Œuvres complètes - Flaubert","auteur":"Gustave Flaubert","date":"1885","editeur":"A. Quantin","completion":"8/8","categorie":"Ouvrage","nbVol":8,"siecle":19,"eo":"Oui","theme":"Littérature","etat":"Excellent","format":"In 8","poids":10,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":127.83,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-03-01","dateVente":"","dureeVente":"","pxMiseEnVente":750,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":622.17,"benefRealise":0,"difference":0},{"id":"46","titre":"Les convulsions de Paris","auteur":"Maxime du Camp","date":"1878","editeur":"Hachette","completion":"4/4","categorie":"Ouvrage","nbVol":4,"siecle":19,"eo":"Non","theme":"Histoire","etat":"Bon","format":"In 8","poids":3.6,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":14.49,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-03-02","dateVente":"","dureeVente":"","pxMiseEnVente":85,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":70.51,"benefRealise":0,"difference":0},{"id":"47","titre":"Mes souvenirs","auteur":"Général du Barail","date":"1894","editeur":"Plon","completion":"3/3","categorie":"Ouvrage","nbVol":3,"siecle":19,"eo":"Non","theme":"Histoire","etat":"Excellent","format":"In 8","poids":2.7,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":8.52,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-03-03","dateVente":"","dureeVente":"","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":41.48,"benefRealise":0,"difference":0},{"id":"48","titre":"René d'Anjou","auteur":"Cordellier-Delanoue","date":"1855","editeur":"Ad Mame","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Histoire","etat":"Bon","format":"In 12","poids":0.3,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":6.82,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-03-04","dateVente":"","dureeVente":"","pxMiseEnVente":40,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":33.18,"benefRealise":0,"difference":0},{"id":"49","titre":"Mémoires du Général Baron Thiébault","auteur":"Claire Thibéault","date":"1896","editeur":"Plon","completion":"5/5","categorie":"Ouvrage","nbVol":5,"siecle":19,"eo":"Non","theme":"Histoire","etat":"Excellent","format":"In 8","poids":5,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":51.13,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-03-05","dateVente":"","dureeVente":"","pxMiseEnVente":300,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":248.87,"benefRealise":0,"difference":0},{"id":"50","titre":"Histoire de Princes de Condé","auteur":"M. le duc d'Aumale","date":"1863","editeur":"Michel Levy Frères","completion":"5/5","categorie":"Ouvrage","nbVol":5,"siecle":19,"eo":"Oui","theme":"Histoire","etat":"Excellent","format":"In 8","poids":5,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":15.34,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-03-06","dateVente":"","dureeVente":"","pxMiseEnVente":90,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":74.66,"benefRealise":0,"difference":0},{"id":"51","titre":"Dictionnaire de Diplomatique Chrétienne","auteur":"Quantin","date":"1846","editeur":"J.-P. Migne","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Oui","theme":"Religion","etat":"Bon","format":"In 8","poids":1.3,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":8.52,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-03-07","dateVente":"","dureeVente":"","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":41.48,"benefRealise":0,"difference":0},{"id":"52","titre":"Marysienka — Reine de Pologne","auteur":"K. Waliszewski","date":"1898","editeur":"Plon","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Oui","theme":"Histoire","etat":"Excellent","format":"In 8","poids":0.95,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":6.82,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-03-07","dateVente":"","dureeVente":"","pxMiseEnVente":40,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":33.18,"benefRealise":0,"difference":0},{"id":"53","titre":"Liste générale des postes de France","auteur":"Sr. Jaillot","date":"1757","editeur":"Chez le Sr. Jaillot","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"Non","theme":"Géographie","etat":"Moyen","format":"In 12","poids":0.15,"stockage":"2","numAchat":"2","dateAchat":"2025-10-11","pxAchat":20.45,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-03-06","dateVente":"","dureeVente":"","pxMiseEnVente":120,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":99.55,"benefRealise":0,"difference":0},{"id":"54","titre":"Abrégé de l'histoire universelle","auteur":"Claude de l'Isle","date":"1731","editeur":"Didot","completion":"7/7","categorie":"Ouvrage","nbVol":7,"siecle":18,"eo":"Oui","theme":"Histoire","etat":"Bon","format":"In 12","poids":2.5,"stockage":"2","numAchat":"2","dateAchat":"2025-10-11","pxAchat":153.39,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-16","dateVente":"","dureeVente":"1 jours","pxMiseEnVente":900,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":746.61,"benefRealise":0,"difference":0},{"id":"55","titre":"Abrégé des trois siècles de la littérature française","auteur":"Abbé Sabattier","date":"1821","editeur":"C. Painparré","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Littérature","etat":"Bon","format":"In 12","poids":0.28,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":8.52,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-17","dateVente":"","dureeVente":"0 jours","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":41.48,"benefRealise":0,"difference":0},{"id":"56","titre":"La France à Jérusalem","auteur":"Adrien Peladan","date":"1855","editeur":"Gaume Frères","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Oui","theme":"Histoire","etat":"Correct","format":"In 12","poids":0.25,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":8.52,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-18","dateVente":"","dureeVente":"","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":41.48,"benefRealise":0,"difference":0},{"id":"57","titre":"Voyage en Angleterre et en Russe (Vol 2)","auteur":"Edouard de Montule","date":"1825","editeur":"Arthus Bertrand","completion":"1/2","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Oui","theme":"Voyages","etat":"Bon","format":"In 8","poids":0.5,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":17.04,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-19","dateVente":"","dureeVente":"","pxMiseEnVente":100,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":82.96,"benefRealise":0,"difference":0},{"id":"58","titre":"Traité de peinture (Vol 1)","auteur":"Dandré Bardon","date":"1765","editeur":"Desaint","completion":"1/2","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"Oui","theme":"Art","etat":"Bon","format":"In 12","poids":0.3,"stockage":"2","numAchat":"2","dateAchat":"2025-10-11","pxAchat":8.52,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-03-08","dateVente":"","dureeVente":"","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":41.48,"benefRealise":0,"difference":0},{"id":"59","titre":"Le Buffon du jeune age","auteur":"Elisabeth Müller","date":"-","editeur":"Amédée Bédelet","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Enfants","etat":"Bon","format":"In 8","poids":0.45,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":8.52,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-03-09","dateVente":"","dureeVente":"","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":41.48,"benefRealise":0,"difference":0},{"id":"60","titre":"Essai sur le beau","auteur":"Père André","date":"1810","editeur":"Ferra","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":19,"eo":"Non","theme":"Philosophie","etat":"Excellent","format":"In 12","poids":0.35,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":8.52,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-21","dateVente":"","dureeVente":"","pxMiseEnVente":50,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":41.48,"benefRealise":0,"difference":0},{"id":"61","titre":"Nouveau Voyage de France","auteur":"MLR","date":"1778","editeur":"Libraires Associés","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":18,"eo":"Non","theme":"Voyage","etat":"Moyen","format":"In 12","poids":0.4,"stockage":"2","numAchat":"2","dateAchat":"2025-10-11","pxAchat":27.27,"totalAchat":588.68,"lieuAchat":"Passerelle des enchères","publie":"Oui","vendu":"Non","dateMiseEnVente":"2026-02-22","dateVente":"","dureeVente":"","pxMiseEnVente":160,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":132.73,"benefRealise":0,"difference":0},{"id":"62","titre":"Vocabulaire ou dictionnaire portatif","auteur":"MM. R et L","date":"1812","editeur":"Amable Leroy","completion":"1/1","categorie":"Ouvrage","nbVol":1,"siecle":0,"eo":"Non","theme":"Dictionnaire","etat":"Moyen","format":"In 12","poids":0.77,"stockage":"4","numAchat":"2","dateAchat":"2025-10-11","pxAchat":0,"totalAchat":0,"lieuAchat":"Passerelle des enchères","publie":"","vendu":"","dateMiseEnVente":"","dateVente":"","dureeVente":"","pxMiseEnVente":0,"pxEncaisse":0,"modalites":"","livre":"","fraisExpedition":0,"benefAttendu":0,"benefRealise":0,"difference":0}];

const IMPORTED_EXPENSES = [{"venteNum":"1","date":"2025-09-26","categorie":"Frais de livraison","vendeur":"Cocolis","montant":57,"description":"Livraison de la vente du 24/09/2025"},{"venteNum":"1","date":"2025-09-29","categorie":"Achat de livres","vendeur":"Inter Ville CP","montant":253.38,"description":"Achat vente du 24/09/25 (lots 12 et 14)"},{"venteNum":"2","date":"2025-10-11","categorie":"Achat de livres","vendeur":"La passerelle des Enchères","montant":488.68,"description":"Lot 715 (vente du 11/10/2025)"},{"venteNum":"3","date":"2025-10-22","categorie":"Achat de livres","vendeur":"Deloys","montant":187.55,"description":"Lot 144 (vente du 22/10/2025)"},{"venteNum":"2","date":"2025-11-12","categorie":"Frais de livraison","vendeur":"Pacaud transports","montant":100,"description":"Livraison de la vente du 11/10/2025"}];

const THEMES=["Art & architecture","Equitation","Histoire","Littérature","Divers","Poésie","Voyages","Religion","Sciences et mathématiques","Philosophie","Médecine","Droit","Nature et Chasse","Géographie","Dictionnaire","Enfants","Art","Voyage"];
const ETATS=["Excellent","Bon","Correct","Moyen","Mauvais"];
const FORMATS=["In 32","In 18","In 16","In 12","In 8","In 4","In Folio"];
const CATEGORIES=["Lot","Ouvrage"];
const EO_VALS=["EO","Non","Oui"];
const SIECLES=[16,17,18,19];
const EXPENSE_CATS=["Achat de livres","Frais de livraison","Abonnement Ebay","Chronopost","Divers"];

const fmt=(n)=>n?new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(n):"—";
const fmtD=(d)=>d?new Date(d+"T00:00:00").toLocaleDateString("fr-FR"):"—";
const TABS=[{key:"dashboard",label:"Tableau de bord",icon:"◈"},{key:"inventaire",label:"Inventaire",icon:"◉"},{key:"ventes",label:"Ventes",icon:"◆"},{key:"sourcing",label:"Sourcing",icon:"◇"},{key:"depenses",label:"Dépenses",icon:"▣"}];

const c={background:"linear-gradient(135deg,#1a1a2e,#16213e)",border:"1px solid #1e2d4a",borderRadius:12,padding:24};
const inp={width:"100%",padding:"9px 12px",background:"#0d1525",border:"1px solid #1e2d4a",borderRadius:8,color:"#e6f1ff",fontSize:13,fontFamily:"'JetBrains Mono',monospace",outline:"none",boxSizing:"border-box"};
const sel={...inp,cursor:"pointer"};
const btnP={padding:"10px 24px",background:"linear-gradient(135deg,#c9a84c,#a07c30)",border:"none",borderRadius:8,color:"#0a0f1e",fontSize:13,fontWeight:700,cursor:"pointer",fontFamily:"'JetBrains Mono',monospace"};
const btnS={...btnP,background:"transparent",border:"1px solid #2a3a5a",color:"#8892b0"};

const Stat=({label,value,sub,accent="#c9a84c"})=>(
  <div style={{...c,flex:"1 1 180px",minWidth:170,padding:"18px 22px"}}>
    <div style={{fontSize:11,textTransform:"uppercase",letterSpacing:2,color:"#6a7a9a",marginBottom:6,fontFamily:"'JetBrains Mono',monospace"}}>{label}</div>
    <div style={{fontSize:24,fontWeight:700,color:accent,fontFamily:"'Playfair Display',serif"}}>{value}</div>
    {sub&&<div style={{fontSize:11,color:"#4a5a7a",marginTop:4,fontFamily:"'JetBrains Mono',monospace"}}>{sub}</div>}
  </div>
);

const Modal=({open,onClose,title,children,wide,narrow})=>{if(!open)return null;return(
  <div onClick={onClose} style={{position:"fixed",inset:0,background:"rgba(0,0,0,.7)",backdropFilter:"blur(8px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000,padding:16}}>
    <div onClick={e=>e.stopPropagation()} style={{background:"linear-gradient(180deg,#0f1629,#0a0f1e)",border:"1px solid #1e2d4a",borderRadius:16,padding:28,width:"100%",maxWidth:narrow?460:wide?820:640,maxHeight:"88vh",overflowY:"auto"}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}>
        <h2 style={{margin:0,fontSize:18,color:"#e6f1ff",fontFamily:"'Playfair Display',serif"}}>{title}</h2>
        <button onClick={onClose} style={{background:"none",border:"none",color:"#5a6a8a",fontSize:22,cursor:"pointer"}}>✕</button>
      </div>{children}
    </div>
  </div>
);};

const Field=({label,children,w})=>(
  <div style={{flex:w||"1 1 48%",minWidth:180,marginBottom:14}}>
    <label style={{display:"block",fontSize:10,textTransform:"uppercase",letterSpacing:1.5,color:"#5a7a9a",marginBottom:5,fontFamily:"'JetBrains Mono',monospace"}}>{label}</label>{children}
  </div>
);

const BookDetail=({book})=>{if(!book)return null;
  const isVendu=book.vendu==="Oui";
  const Sec=({title,children})=>(<div style={{marginBottom:22}}><div style={{fontSize:11,textTransform:"uppercase",letterSpacing:2,color:"#c9a84c",marginBottom:12,fontFamily:"'JetBrains Mono',monospace",borderBottom:"1px solid #1a2540",paddingBottom:6}}>{title}</div><div>{children}</div></div>);
  const I=({l,v})=>(<div style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 0",borderBottom:"1px solid #0d1525"}}><span style={{fontSize:11,color:"#4a5a7a",textTransform:"uppercase",letterSpacing:1,fontFamily:"'JetBrains Mono',monospace"}}>{l}</span><span style={{fontSize:13,color:"#ccd6f6",fontWeight:500,textAlign:"right",maxWidth:"60%"}}>{v||"—"}</span></div>);
  return(<div>
    <h2 style={{textAlign:"center",fontSize:26,fontWeight:700,color:"#e6f1ff",fontFamily:"'Playfair Display',serif",margin:"0 0 16px",lineHeight:1.3,textTransform:"uppercase",letterSpacing:1}}>{book.titre}</h2>
    <div style={{textAlign:"center",marginBottom:24}}><span style={{display:"inline-block",padding:"4px 14px",borderRadius:20,fontSize:11,fontWeight:700,fontFamily:"'JetBrains Mono',monospace",letterSpacing:1,background:isVendu?"rgba(76,201,140,.12)":"rgba(201,168,76,.12)",color:isVendu?"#4cc98c":"#c9a84c",border:isVendu?"1px solid rgba(76,201,140,.25)":"1px solid rgba(201,168,76,.25)"}}>{isVendu?"VENDU":"EN VENTE"}</span></div>
    <Sec title="Caractéristiques"><I l="Auteur" v={book.auteur}/><I l="Date" v={book.date}/><I l="Éditeur" v={book.editeur}/><I l="Complétion" v={book.completion}/><I l="Catégorie" v={book.categorie}/><I l="Nb volumes" v={book.nbVol}/><I l="Siècle" v={book.siecle?book.siecle+"ème":""}/><I l="Édition originale" v={book.eo}/><I l="Thème" v={book.theme}/><I l="État" v={book.etat}/><I l="Format" v={book.format}/><I l="Poids" v={book.poids?book.poids+" g":""}/><I l="Stockage" v={book.stockage}/></Sec>
    <Sec title="Achat"><I l="N° achat" v={book.numAchat}/><I l="Date d'achat" v={fmtD(book.dateAchat)}/><I l="Prix d'achat" v={fmt(book.pxAchat)}/><I l="Total achat" v={fmt(book.totalAchat)}/><I l="Lieu d'achat" v={book.lieuAchat}/></Sec>
    <Sec title="Vente"><I l="Publié" v={book.publie}/><I l="Vendu" v={book.vendu}/><I l="Date mise en vente" v={fmtD(book.dateMiseEnVente)}/><I l="Date de vente" v={fmtD(book.dateVente)}/><I l="Durée de vente" v={book.dureeVente}/><I l="Prix mise en vente" v={fmt(book.pxMiseEnVente)}/><I l="Prix encaissé" v={fmt(book.pxEncaisse)}/><I l="Modalités" v={book.modalites}/></Sec>
    <Sec title="Expédition & Bénéfice"><I l="Livré" v={book.livre}/><I l="Frais d'expédition" v={fmt(book.fraisExpedition)}/><I l="Bénéfice attendu" v={fmt(book.benefAttendu)}/><I l="Bénéfice réalisé" v={fmt(book.benefRealise)}/><I l="Différence" v={fmt(book.difference)}/></Sec>
  </div>);
};

const BookForm=({book,onSave,onCancel,expenses=[]})=>{
  const [f,setF]=useState(book||{titre:"",auteur:"",date:"",editeur:"",lieuEdition:"",completion:"",categorie:"",nbVol:"",eo:"",theme:"",etat:"",format:"",nbPages:"",poids:"",stockage:"",numAchat:"",dateAchat:"",pxAchat:"",totalAchat:"",lieuAchat:"",publie:"Non",vendu:"Non",dateMiseEnVente:"",dateVente:"",dureeVente:"",pxMiseEnVente:"",pxEncaisse:"",modalites:"",livre:"",fraisExpedition:"",benefAttendu:"",benefRealise:"",difference:"",prixConseilleIA:"",caracSpec:{frontispice:false,gravures:false,exLibris:false,cartes:false}});
  const s=(k,v)=>setF(p=>({...p,[k]:v}));
  const toggleSpec=(k)=>setF(p=>({...p,caracSpec:{...(p.caracSpec||{}), [k]:!(p.caracSpec||{})[k]}}));
  const [formErr,setFormErr]=useState("");
  const venteNums=useMemo(()=>[...new Set(expenses.map(e=>e.venteNum).filter(Boolean))].sort(),[expenses]);
  const venteInfo=useMemo(()=>{const m={};expenses.filter(e=>e.categorie==="Achat de livres").forEach(e=>{m[e.venteNum]={date:e.date,lieu:e.vendeur}});return m},[expenses]);
  const selectVente=(num)=>{
    s("numAchat",num);setFormErr("");
    if(num&&venteInfo[num]){s("dateAchat",venteInfo[num].date);s("lieuAchat",venteInfo[num].lieu)}
    else{s("dateAchat","");s("lieuAchat","")}
  };
  const handleSave=()=>{
    if(!f.titre.trim()){setFormErr("Le titre est obligatoire.");return}
    if(!f.numAchat){setFormErr("Le N° achat est obligatoire.");return}
    setFormErr("");
    onSave({...f,id:f.id||String(Date.now())});
  };
  const [photos,setPhotos]=useState([]);
  const [analyzing,setAnalyzing]=useState(false);
  const [analyzeMsg,setAnalyzeMsg]=useState("");
  const [apiKey,setApiKey]=useState("");
  const [showKeyInput,setShowKeyInput]=useState(false);
  useEffect(()=>{(async()=>{try{const r=await fetch(SB_URL+"/rest/v1/settings?key=eq.anthropic_api_key&select=value",{headers:{"apikey":SB_KEY,"Authorization":"Bearer "+SB_KEY}});if(r.ok){const d=await r.json();if(d.length&&d[0].value){setApiKey(d[0].value);return}}}catch(e){}try{const v=localStorage.getItem("rl-anthropic-key");if(v)setApiKey(v)}catch(e){}})()},[]);
  const fileRef=React.useRef(null);
  const galleryRef=React.useRef(null);

  const videoRef=React.useRef(null);
  const canvasRef=React.useRef(null);
  const [cameraOpen,setCameraOpen]=useState(false);
  const [stream,setStream]=useState(null);

  const openCamera=async()=>{
    try{
      const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1920},height:{ideal:1080}},audio:false});
      setStream(s);setCameraOpen(true);
      setTimeout(()=>{if(videoRef.current){videoRef.current.srcObject=s;videoRef.current.play()}},100);
    }catch(err){
      console.log("Camera API not available, falling back to file input");
      fileRef.current&&fileRef.current.click();
    }
  };

  const takePhoto=()=>{
    if(!videoRef.current||!canvasRef.current)return;
    const v=videoRef.current,cv=canvasRef.current;
    let w=v.videoWidth,h=v.videoHeight;
    const MAX=1200;
    if(w>MAX||h>MAX){if(w>h){h=Math.round(h*MAX/w);w=MAX}else{w=Math.round(w*MAX/h);h=MAX}}
    cv.width=w;cv.height=h;
    cv.getContext("2d").drawImage(v,0,0,w,h);
    const dataUrl=cv.toDataURL("image/jpeg",0.85);
    const base64=dataUrl.split(",")[1];
    setPhotos(prev=>[...prev,{data:base64,type:"image/jpeg",name:"photo_"+Date.now()+".jpg",preview:dataUrl}]);
  };

  const closeCamera=()=>{
    if(stream){stream.getTracks().forEach(t=>t.stop());setStream(null)}
    setCameraOpen(false);
  };

  const handleCapture=(e)=>{
    const files=Array.from(e.target.files||[]);
    if(!files.length)return;
    const promises=files.map(file=>new Promise((res)=>{
      const r=new FileReader();
      r.onload=()=>{
        const img=new Image();
        img.onload=()=>{
          const cv=document.createElement("canvas");
          let w=img.width,h=img.height;
          const MAX=1200;
          if(w>MAX||h>MAX){if(w>h){h=Math.round(h*MAX/w);w=MAX}else{w=Math.round(w*MAX/h);h=MAX}}
          cv.width=w;cv.height=h;
          cv.getContext("2d").drawImage(img,0,0,w,h);
          const dataUrl=cv.toDataURL("image/jpeg",0.85);
          const base64=dataUrl.split(",")[1];
          res({data:base64,type:"image/jpeg",name:file.name,preview:dataUrl});
        };
        img.onerror=()=>res({data:r.result.split(",")[1],type:"image/jpeg",name:file.name,preview:r.result});
        img.src=r.result;
      };
      r.readAsDataURL(file);
    }));
    Promise.all(promises).then(results=>{setPhotos(prev=>[...prev,...results])});
    e.target.value="";
  };

  const removePhoto=(idx)=>setPhotos(prev=>prev.filter((_,i)=>i!==idx));

  const startAnalysis=()=>{
    if(!photos.length)return;
    if(!apiKey){setShowKeyInput(true);return;}
    setShowKeyInput(false);
    analyzePhotos();
  };

  const saveKey=(k)=>{setApiKey(k);try{localStorage.setItem("rl-anthropic-key",k)}catch(e){}fetch(SB_URL+"/rest/v1/settings",{method:"POST",headers:{...SB_H,"Prefer":"return=representation,resolution=merge-duplicates"},body:JSON.stringify({key:"anthropic_api_key",value:k})}).catch(()=>{})};

  const [annonceHtml,setAnnonceHtml]=useState("");
  const [showAnnonce,setShowAnnonce]=useState(false);

  const analyzePhotos=async()=>{
    if(!photos.length||!apiKey)return;
    setAnalyzing(true);setAnalyzeMsg("Analyse des photos en cours...");
    try{
      const imageContent=photos.map(p=>({type:"image",source:{type:"base64",media_type:"image/jpeg",data:p.data}}));
      const response=await fetch("https://api.anthropic.com/v1/messages",{
        method:"POST",headers:{"Content-Type":"application/json","x-api-key":apiKey,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},
        body:JSON.stringify({
          model:"claude-sonnet-4-20250514",max_tokens:4000,
          messages:[{role:"user",content:[
            ...imageContent,
            {type:"text",text:`Tu es un expert bibliophile spécialisé en livres anciens et rares. Analyse ces photos d'un livre ancien.

RÈGLE ABSOLUE : Si tu ne peux PAS identifier une information avec certitude à partir des photos, laisse le champ VIDE (string vide "", ou 0 pour les nombres, ou false pour les booléens). Ne devine JAMAIS. Il vaut mieux un champ vide qu'une information fausse.

ATTENTION SPÉCIALE SUR LA DATE : La date d'édition est CRITIQUE. Lis-la EXACTEMENT telle qu'elle est imprimée sur la page de titre. Ne la déduis PAS d'une préface, d'un privilège du roi ou d'une autre mention. Si plusieurs dates apparaissent, prends celle de la page de titre. Si la date est en chiffres romains, convertis-la avec soin. Si tu as le moindre doute, laisse le champ vide.

CATÉGORIE : Si les photos montrent un seul livre (un seul titre identifiable), remplis le champ "categorie" avec "Ouvrage".

Réponds UNIQUEMENT en JSON valide, sans texte avant/après, sans backticks markdown :
{
  "titre": "",
  "auteur": "",
  "date": "",
  "editeur": "",
  "lieuEdition": "",
  "categorie": "Ouvrage",
  "theme": "",
  "format": "",
  "eo": "",
  "etat": "",
  "caracSpec": {"frontispice":false,"gravures":false,"exLibris":false,"cartes":false,"illustrations":false},
  "prixConseille": 0,
  "titreEbay": "",
  "annonce": ""
}

CHAMPS :
- titre : le titre EXACT tel qu'il apparaît sur la page de titre. Si illisible, laisser vide.
- auteur : l'auteur tel qu'indiqué. Si absent ou illisible, laisser vide.
- date : l'année d'édition EXACTE visible sur la page de titre (ex: "1785"). ATTENTION : lis chaque chiffre avec soin. Ne confonds pas les caractères. Si absente ou illisible, laisser vide.
- editeur : le nom complet de l'éditeur/libraire si visible sur la page de titre (avec adresse si visible). Sinon vide.
- lieuEdition : la ville d'édition si visible (ex: "Paris", "Lyon"). Sinon vide.
- categorie : "Ouvrage" si un seul livre est identifié, sinon laisser vide.
- theme : UNE valeur parmi : "Art & architecture","Equitation","Histoire","Littérature","Divers","Poésie","Voyages","Religion","Sciences et mathématiques","Philosophie","Médecine","Droit","Nature et Chasse","Géographie","Dictionnaire","Enfants","Art","Voyage". Si impossible à déterminer, laisser vide.
- format : UNE valeur parmi : "In 32","In 18","In 16","In 12","In 8","In 4","In Folio". Déduis de la taille apparente. Si impossible, laisser vide.
- eo : "EO" si c'est visiblement une édition originale, sinon laisser vide.
- etat : UNE valeur parmi : "Excellent","Bon","Correct","Mauvais". Évalue l'état apparent du livre sur les photos. Si impossible, laisser vide.
- caracSpec : mettre true UNIQUEMENT si visible sur les photos.
- prixConseille : estimation du prix de vente en euros sur eBay. Si impossible, mettre 0.
- titreEbay : titre d'annonce eBay de 80 caractères MAX. Format : "[Titre court] - [Auteur] - [Éditeur] [Date] [E.O. si applicable]". Ex : "Marysienka Reine de Pologne 1641-1716 - Waliszewski - Plon 1898 E.O."
- annonce : annonce eBay au format HTML "Biblio-eBay" suivant EXACTEMENT ce modèle :

<div style="font-family:Georgia,serif;max-width:800px;margin:0 auto;color:#333;line-height:1.8">

<p style="font-size:12px;color:#888;margin-bottom:2px">Titre de l'annonce :</p>
<p style="font-size:20px;font-weight:bold;color:#333;margin-top:0;margin-bottom:24px">[titreEbay identique au champ titreEbay]</p>

<p style="text-align:center;letter-spacing:3px;color:#888;margin:20px 0">══════════════════════════════════</p>

<p style="margin-bottom:20px"><strong>État :</strong> [Excellent/Bon/Correct/Mauvais]. [Description précise des défauts observés sur les photos : rousseurs, usure du dos, coins frottés, déchirures, taches, etc. Si état excellent, indiquer "Très bel exemplaire, aucun défaut notable."]</p>

<p style="text-align:center;letter-spacing:3px;color:#888;margin:20px 0">══════════════════════════════════</p>

<p style="margin-bottom:14px"><strong>Titre :</strong> [titre complet tel qu'il figure sur la page de titre]</p>

<p style="margin-bottom:14px"><strong>Auteur :</strong> [auteur complet]</p>

<p style="margin-bottom:14px"><strong>Éditeur :</strong> [éditeur complet avec adresse si visible]</p>

<p style="margin-bottom:14px"><strong>Année :</strong> [date]</p>

<p style="margin-bottom:20px"><strong>Format :</strong> [format]. [Nombre de volumes si visible]. [Mentionner portraits, gravures, cartes si présents].</p>

<p style="margin-bottom:16px"><strong>[Description de la reliure — décrire le type de reliure observé sur les photos : plein cuir, demi-chagrin, broché, cartonnage, etc. avec détails sur le dos, les plats, les gardes]</strong></p>

<p style="margin-bottom:16px"><strong>[Si ex-libris visible, le mentionner ici]</strong></p>

<p style="margin-bottom:16px"><strong>[Si illustrations, gravures, cartes présentes, les détailler ici]</strong></p>

<p style="margin-bottom:16px">[Paragraphe de contextualisation du livre : présentation de l'ouvrage, de l'auteur, importance historique ou littéraire. 3-5 phrases savantes et informatives.]</p>

<p style="margin-bottom:20px">[Phrase indiquant à qui ce livre peut intéresser : "Intéressera les amateurs de..., les collectionneurs de..., les passionnés de..."]</p>

<p><strong>Envoi soigné en Colissimo.</strong></p>

</div>

IMPORTANT pour l'annonce :
- Les mots "Titre", "Auteur", "Éditeur", "Année", "Format", "État" doivent être en <strong>gras</strong>.
- La description de la reliure doit être un paragraphe en gras.
- Les caractéristiques spéciales (ex-libris, illustrations, gravures) doivent être en gras.
- Le paragraphe de contextualisation doit être savant et précis, pas générique.
- "Envoi soigné en Colissimo." toujours en gras à la fin.
- Aère bien l'annonce avec des marges entre chaque section.
- Si tu ne peux pas générer une annonce faute d'informations suffisantes, laisse le champ annonce vide.`}
          ]}]
        })
      });
      if(!response.ok){
        const errData=await response.json().catch(()=>({}));
        const errMsg=errData.error?.message||response.statusText||"Erreur inconnue";
        if(response.status===401){setAnalyzeMsg("✗ Clé API invalide. Vérifiez votre clé.");setShowKeyInput(true)}
        else if(response.status===403){setAnalyzeMsg("✗ Accès refusé. Vérifiez les permissions de votre clé.")}
        else if(response.status===429){setAnalyzeMsg("✗ Trop de requêtes. Attendez un instant.")}
        else if(response.status===400){setAnalyzeMsg("✗ Requête invalide: "+errMsg)}
        else{setAnalyzeMsg("✗ Erreur API ("+response.status+"): "+errMsg)}
        setAnalyzing(false);return;
      }
      const data=await response.json();
      if(!data.content||!data.content.length){setAnalyzeMsg("✗ Réponse vide de l'API");setAnalyzing(false);return}
      const text=data.content.map(i=>i.text||"").join("");
      const clean=text.replace(/```json|```/g,"").trim();
      let parsed;
      try{parsed=JSON.parse(clean)}catch(pe){console.error("JSON parse error:",clean);setAnalyzeMsg("✗ Réponse non-JSON. Réessayez.");setAnalyzing(false);return}
      setAnalyzeMsg("✓ Informations extraites !");
      if(parsed.titre)s("titre",parsed.titre);
      if(parsed.auteur)s("auteur",parsed.auteur);
      if(parsed.date)s("date",parsed.date);
      if(parsed.editeur)s("editeur",parsed.editeur);
      if(parsed.lieuEdition)s("lieuEdition",parsed.lieuEdition);
      if(parsed.theme)s("theme",parsed.theme);
      if(parsed.format)s("format",parsed.format);
      if(parsed.eo)s("eo",parsed.eo);
      if(parsed.etat)s("etat",parsed.etat);
      if(parsed.categorie)s("categorie",parsed.categorie);
      if(parsed.caracSpec){
        const cs=parsed.caracSpec;
        setF(p=>({...p,caracSpec:{...(p.caracSpec||{}),
          frontispice:cs.frontispice||false,gravures:cs.gravures||false,
          exLibris:cs.exLibris||false,cartes:cs.cartes||false,illustrations:cs.illustrations||false
        }}));
      }
      if(parsed.prixConseille&&parsed.prixConseille>0)s("prixConseilleIA",parsed.prixConseille);
      if(parsed.annonce)setAnnonceHtml(parsed.annonce);
      setTimeout(()=>setAnalyzeMsg(""),6000);
    }catch(err){
      console.error("Erreur analyse:",err);
      if(err.message&&err.message.includes("Failed to fetch")){setAnalyzeMsg("✗ Connexion impossible. Vérifiez votre connexion internet.")}
      else{setAnalyzeMsg("✗ Erreur: "+err.message)}
    }
    setAnalyzing(false);
  };

  const generateAnnonceFromForm=async()=>{
    if(!f.titre.trim()){setFormErr("Remplissez au moins le titre pour générer l'annonce.");return}
    if(!apiKey){setShowKeyInput(true);setFormErr("Clé API requise pour générer l'annonce.");return}
    setAnalyzing(true);setAnalyzeMsg("Génération de l'annonce...");
    try{
      const cs=f.caracSpec||{};
      const specs=Object.entries({frontispice:"Frontispice",gravures:"Gravures",exLibris:"Ex-libris",cartes:"Cartes",illustrations:"Illustrations"}).filter(([k])=>cs[k]).map(([,v])=>v);
      const prompt=`Tu es un expert bibliophile. Génère une annonce eBay pour ce livre ancien à partir des informations suivantes.

Titre : ${f.titre||"non renseigné"}
Auteur : ${f.auteur||"non renseigné"}
Date : ${f.date||"non renseignée"}
Éditeur : ${f.editeur||"non renseigné"}
Lieu d'édition : ${f.lieuEdition||"non renseigné"}
Format : ${f.format||"non renseigné"}
État : ${f.etat||"non renseigné"}
EO : ${f.eo||"Non"}
Caractéristiques spéciales : ${specs.length?specs.join(", "):"aucune"}

RÈGLE : Ne mentionne dans l'annonce QUE les informations fournies ci-dessus. N'invente aucune information manquante (reliure, nombre de pages, etc.). Si un champ est "non renseigné", ne le mentionne pas du tout dans l'annonce.

Réponds UNIQUEMENT en JSON valide, sans backticks :
{"titreEbay":"","annonce":""}

- titreEbay : 80 caractères MAX. Format : "[Titre court] - [Auteur] - [Éditeur] [Date] [E.O. si applicable]"
- annonce : HTML au format Biblio-eBay suivant exactement ce modèle (n'inclus que les champs renseignés) :

<div style="font-family:Georgia,serif;max-width:800px;margin:0 auto;color:#333;line-height:1.8">
<p style="font-size:12px;color:#888;margin-bottom:2px">Titre de l'annonce :</p>
<p style="font-size:20px;font-weight:bold;color:#333;margin-top:0;margin-bottom:24px">[titreEbay]</p>
<p style="text-align:center;letter-spacing:3px;color:#888;margin:20px 0">══════════════════════════════════</p>
<p style="margin-bottom:20px"><strong>État :</strong> [état si renseigné].</p>
<p style="text-align:center;letter-spacing:3px;color:#888;margin:20px 0">══════════════════════════════════</p>
<p style="margin-bottom:14px"><strong>Titre :</strong> [titre]</p>
<p style="margin-bottom:14px"><strong>Auteur :</strong> [auteur]</p>
<p style="margin-bottom:14px"><strong>Éditeur :</strong> [éditeur, lieu]</p>
<p style="margin-bottom:14px"><strong>Année :</strong> [date]</p>
<p style="margin-bottom:20px"><strong>Format :</strong> [format]</p>
[Si caractéristiques spéciales: <p style="margin-bottom:16px"><strong>[les lister en gras]</strong></p>]
<p style="margin-bottom:16px">[Contextualisation savante du livre, auteur, importance. 3-5 phrases. Basée uniquement sur tes connaissances de l'ouvrage.]</p>
<p style="margin-bottom:20px">[Intéressera les amateurs de...]</p>
<p><strong>Envoi soigné en Colissimo.</strong></p>
</div>`;
      const response=await fetch("https://api.anthropic.com/v1/messages",{
        method:"POST",headers:{"Content-Type":"application/json","x-api-key":apiKey,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},
        body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:3000,messages:[{role:"user",content:prompt}]})
      });
      if(!response.ok){const errData=await response.json().catch(()=>({}));setAnalyzeMsg("✗ Erreur API ("+response.status+"): "+(errData.error?.message||""));setAnalyzing(false);return}
      const data=await response.json();
      const text=data.content.map(i=>i.text||"").join("");
      const clean=text.replace(/```json|```/g,"").trim();
      let parsed;
      try{parsed=JSON.parse(clean)}catch(pe){setAnalyzeMsg("✗ Réponse non-JSON. Réessayez.");setAnalyzing(false);return}
      if(parsed.annonce){setAnnonceHtml(parsed.annonce);setShowAnnonce(true);setAnalyzeMsg("✓ Annonce générée !")}
      else{setAnalyzeMsg("✗ Impossible de générer l'annonce.")}
      setTimeout(()=>setAnalyzeMsg(""),6000);
    }catch(err){setAnalyzeMsg("✗ Erreur: "+err.message)}
    setAnalyzing(false);
  };

  return(<div style={{display:"flex",flexWrap:"wrap",gap:"0 14px"}}>
    {/* Camera Section */}
    <div style={{width:"100%",display:"flex",flexDirection:"column",alignItems:"center",marginBottom:18}}>
      {/* Centered camera + gallery buttons */}
      <div style={{display:"flex",gap:14,justifyContent:"center",marginBottom:10}}>
      <button onClick={openCamera} title="Photographier le livre" style={{width:56,height:56,borderRadius:12,background:"linear-gradient(135deg,#111d35,#0e1628)",border:"1.5px solid #1e3050",color:"#5a8abf",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",transition:"all .25s"}}
        onMouseEnter={e=>{e.currentTarget.style.borderColor="#4a8af8";e.currentTarget.style.background="linear-gradient(135deg,#152545,#112040)";e.currentTarget.style.color="#8ab4f8"}}
        onMouseLeave={e=>{e.currentTarget.style.borderColor="#1e3050";e.currentTarget.style.background="linear-gradient(135deg,#111d35,#0e1628)";e.currentTarget.style.color="#5a8abf"}}>
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
      </button>
      <button onClick={()=>galleryRef.current&&galleryRef.current.click()} title="Charger depuis le dossier / la galerie" style={{width:56,height:56,borderRadius:12,background:"linear-gradient(135deg,#111d35,#0e1628)",border:"1.5px solid #1e3050",color:"#5a8abf",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",transition:"all .25s"}}
        onMouseEnter={e=>{e.currentTarget.style.borderColor="#4a8af8";e.currentTarget.style.background="linear-gradient(135deg,#152545,#112040)";e.currentTarget.style.color="#8ab4f8"}}
        onMouseLeave={e=>{e.currentTarget.style.borderColor="#1e3050";e.currentTarget.style.background="linear-gradient(135deg,#111d35,#0e1628)";e.currentTarget.style.color="#5a8abf"}}>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>
      </button>
      </div>
      <input ref={fileRef} type="file" accept="image/*" capture="environment" multiple style={{display:"none"}} onChange={handleCapture}/>
      <input ref={galleryRef} type="file" accept="image/*" multiple style={{display:"none"}} onChange={handleCapture}/>
      <canvas ref={canvasRef} style={{display:"none"}}/>

      {/* Live camera view */}
      {cameraOpen&&<div style={{width:"100%",borderRadius:12,overflow:"hidden",border:"1px solid #1e3050",marginBottom:12,position:"relative",background:"#000"}}>
        <video ref={videoRef} autoPlay playsInline muted style={{width:"100%",maxHeight:300,objectFit:"cover",display:"block"}}/>
        <div style={{position:"absolute",bottom:12,left:0,right:0,display:"flex",justifyContent:"center",gap:16}}>
          <button onClick={takePhoto} style={{width:52,height:52,borderRadius:"50%",background:"#fff",border:"3px solid #ccc",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 2px 12px rgba(0,0,0,.4)"}}
            title="Prendre la photo">
            <div style={{width:40,height:40,borderRadius:"50%",background:"#fff",border:"2px solid #ddd"}}/>
          </button>
          <button onClick={closeCamera} style={{width:42,height:42,borderRadius:"50%",background:"rgba(200,60,60,.85)",border:"none",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontSize:18,fontWeight:700}} title="Fermer">✕</button>
        </div>
      </div>}

      {/* Photo thumbnails */}
      {photos.length>0&&<div style={{display:"flex",gap:10,flexWrap:"wrap",justifyContent:"center",marginBottom:10}}>
        {photos.map((p,i)=>(<div key={i} style={{position:"relative",width:72,height:72,borderRadius:8,overflow:"hidden",border:"1px solid #1e2d4a"}}>
          <img src={p.preview} style={{width:"100%",height:"100%",objectFit:"cover"}}/>
          <button onClick={()=>removePhoto(i)} style={{position:"absolute",top:2,right:2,background:"rgba(0,0,0,.75)",border:"none",color:"#c94c4c",fontSize:13,cursor:"pointer",borderRadius:"50%",width:18,height:18,display:"flex",alignItems:"center",justifyContent:"center",padding:0,lineHeight:1}}>✕</button>
        </div>))}
      </div>}

      {/* Analyze button + API key */}
      {photos.length>0&&<div style={{display:"flex",flexDirection:"column",alignItems:"center",gap:8}}>
        <button onClick={startAnalysis} disabled={analyzing} style={{...btnP,padding:"10px 20px",opacity:analyzing?.6:1,display:"flex",alignItems:"center",gap:8,fontSize:12}}>
        {analyzing?<span style={{display:"inline-block",width:14,height:14,border:"2px solid #0a0f1e",borderTop:"2px solid transparent",borderRadius:"50%",animation:"spin 1s linear infinite"}}/>:
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>}
        {analyzing?"Analyse en cours...":"Analyser "+photos.length+" photo"+(photos.length>1?"s":"")}
        </button>
        {showKeyInput&&<div style={{display:"flex",flexDirection:"column",alignItems:"center",gap:6,marginTop:4,width:"100%",maxWidth:400}}>
          <div style={{fontSize:11,color:"#6a8aaa",fontFamily:"'JetBrains Mono',monospace",textAlign:"center"}}>Clé API Anthropic requise pour l'analyse :</div>
          <div style={{display:"flex",gap:8,width:"100%"}}>
            <input style={{...inp,flex:1,fontSize:12}} type="password" placeholder="sk-ant-..." value={apiKey} onChange={e=>saveKey(e.target.value)}/>
            <button onClick={()=>{if(apiKey){setShowKeyInput(false);analyzePhotos()}}} style={{...btnP,padding:"8px 16px",fontSize:11,whiteSpace:"nowrap"}}>OK</button>
          </div>
          <div style={{fontSize:10,color:"#3a4a6a",fontFamily:"'JetBrains Mono',monospace",textAlign:"center"}}>Synchronisée sur tous vos appareils. <span style={{cursor:"pointer",color:"#c94c4c"}} onClick={()=>{saveKey("");setShowKeyInput(false)}}>Effacer</span></div>
        </div>}
      </div>}
      {analyzeMsg&&<div style={{fontSize:12,fontFamily:"'JetBrains Mono',monospace",color:analyzeMsg.startsWith("✓")?"#4cc98c":analyzeMsg.startsWith("✗")?"#c94c4c":"#8ab4f8",padding:"6px 0",textAlign:"center"}}>{analyzeMsg}</div>}
    </div>
    <style>{`@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}`}</style>
    <div style={{width:"100%",fontSize:11,textTransform:"uppercase",letterSpacing:2,color:"#c9a84c",marginBottom:10,fontFamily:"'JetBrains Mono',monospace"}}>Caractéristiques</div>
    <Field label="Titre ✱" w="1 1 100%"><input style={{...inp,borderColor:formErr&&!f.titre.trim()?"#c94c4c":undefined}} value={f.titre} onChange={e=>{s("titre",e.target.value);setFormErr("")}}/></Field>
    <Field label="Auteur"><input style={inp} value={f.auteur} onChange={e=>s("auteur",e.target.value)}/></Field>
    <Field label="Date"><input style={inp} value={f.date} onChange={e=>s("date",e.target.value)}/></Field>
    <Field label="Éditeur"><input style={inp} value={f.editeur} onChange={e=>s("editeur",e.target.value)}/></Field>
    <Field label="Lieu d'édition"><input style={inp} value={f.lieuEdition||""} onChange={e=>s("lieuEdition",e.target.value)}/></Field>
    <Field label="Catégorie"><select style={sel} value={f.categorie} onChange={e=>s("categorie",e.target.value)}><option value="">—</option>{CATEGORIES.map(x=><option key={x}>{x}</option>)}</select></Field>
    <Field label="Complétion"><input style={inp} value={f.completion} onChange={e=>s("completion",e.target.value)}/></Field>
    <Field label="EO"><select style={sel} value={f.eo} onChange={e=>s("eo",e.target.value)}><option value="">—</option>{EO_VALS.map(x=><option key={x}>{x}</option>)}</select></Field>
    <Field label="Thème"><select style={sel} value={f.theme} onChange={e=>s("theme",e.target.value)}><option value="">—</option>{THEMES.map(x=><option key={x}>{x}</option>)}</select></Field>
    <Field label="État"><select style={sel} value={f.etat} onChange={e=>s("etat",e.target.value)}><option value="">—</option>{ETATS.map(x=><option key={x}>{x}</option>)}</select></Field>
    <Field label="Format"><select style={sel} value={f.format} onChange={e=>s("format",e.target.value)}><option value="">—</option>{FORMATS.map(x=><option key={x}>{x}</option>)}</select></Field>
    <Field label="Nb vol"><input style={inp} type="number" value={f.nbVol} onChange={e=>s("nbVol",e.target.value===""?"":+e.target.value)}/></Field>
    <Field label="Nb pages"><input style={inp} type="number" value={f.nbPages||""} onChange={e=>s("nbPages",e.target.value===""?"":+e.target.value)}/></Field>
    <Field label="Poids (Kg)"><input style={inp} type="number" step="0.001" value={f.poids} onChange={e=>s("poids",e.target.value===""?"":+e.target.value)}/></Field>
    <Field label="Stockage"><input style={inp} value={f.stockage} onChange={e=>s("stockage",e.target.value)}/></Field>
    <div style={{width:"100%",marginBottom:14,marginTop:6}}>
      <label style={{display:"block",fontSize:10,textTransform:"uppercase",letterSpacing:1.5,color:"#5a7a9a",marginBottom:10,fontFamily:"'JetBrains Mono',monospace"}}>Caractéristiques spéciales</label>
      <div style={{display:"flex",gap:18,flexWrap:"wrap"}}>
        {[["frontispice","Frontispice"],["gravures","Gravures"],["exLibris","Ex libris"],["cartes","Cartes"],["illustrations","Illustrations"]].map(([k,label])=>(
          <label key={k} style={{display:"flex",alignItems:"center",gap:7,cursor:"pointer",fontSize:13,color:(f.caracSpec||{})[k]?"#c9a84c":"#4a5a7a"}}>
            <div onClick={()=>toggleSpec(k)} style={{width:20,height:20,borderRadius:5,border:(f.caracSpec||{})[k]?"2px solid #c9a84c":"2px solid #2a3a5a",background:(f.caracSpec||{})[k]?"#c9a84c":"transparent",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",transition:"all .2s"}}>
              {(f.caracSpec||{})[k]&&<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#0a0f1e" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>}
            </div>{label}
          </label>
        ))}
      </div>
    </div>
    <div style={{width:"100%",fontSize:11,textTransform:"uppercase",letterSpacing:2,color:"#c9a84c",margin:"14px 0 10px",fontFamily:"'JetBrains Mono',monospace"}}>Informations sur l'achat</div>
    <Field label="N° achat ✱"><select style={{...sel,borderColor:formErr&&!f.numAchat?"#c94c4c":undefined}} value={f.numAchat} onChange={e=>selectVente(e.target.value)}><option value="">—</option>{venteNums.map(n=><option key={n} value={n}>Vente n°{n}</option>)}</select></Field>
    <Field label="Date achat"><input style={{...inp,color:"#8892b0"}} type="date" value={f.dateAchat} readOnly/></Field>
    <Field label="Lieu achat"><input style={{...inp,color:"#8892b0"}} value={f.lieuAchat} readOnly/></Field>
    <div style={{width:"100%",fontSize:11,textTransform:"uppercase",letterSpacing:2,color:"#c9a84c",margin:"14px 0 10px",fontFamily:"'JetBrains Mono',monospace"}}>Mise en vente</div>
    <Field label="Prix conseillé (IA)"><div style={{position:"relative"}}><input style={{...inp,color:"#8892b0",fontStyle:"italic",paddingRight:28}} value={f.prixConseilleIA||"—"} readOnly/><span style={{position:"absolute",right:10,top:"50%",transform:"translateY(-50%)",color:"#5a6a8a",fontSize:13,fontFamily:"'JetBrains Mono',monospace",pointerEvents:"none"}}>€</span></div></Field>
    <Field label="Px mise en vente"><div style={{position:"relative"}}><input style={{...inp,paddingRight:28}} type="number" step="0.01" value={f.pxMiseEnVente} onChange={e=>s("pxMiseEnVente",e.target.value===""?"":+e.target.value)}/><span style={{position:"absolute",right:10,top:"50%",transform:"translateY(-50%)",color:"#5a6a8a",fontSize:13,fontFamily:"'JetBrains Mono',monospace",pointerEvents:"none"}}>€</span></div></Field>
    {book&&<><div style={{width:"100%",marginBottom:14,marginTop:6}}>
      <label style={{display:"block",fontSize:10,textTransform:"uppercase",letterSpacing:1.5,color:"#5a7a9a",marginBottom:10,fontFamily:"'JetBrains Mono',monospace"}}>Publication de l'annonce</label>
      <div style={{display:"flex",gap:20}}>
        <label style={{display:"flex",alignItems:"center",gap:8,cursor:"pointer",fontSize:13,color:f.publie==="Oui"?"#4cc98c":"#5a6a8a"}}>
          <div onClick={()=>s("publie","Oui")} style={{width:20,height:20,borderRadius:6,border:f.publie==="Oui"?"2px solid #4cc98c":"2px solid #2a3a5a",background:f.publie==="Oui"?"#4cc98c":"transparent",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",transition:"all .2s"}}>
            {f.publie==="Oui"&&<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#0a0f1e" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>}
          </div>Oui
        </label>
        <label style={{display:"flex",alignItems:"center",gap:8,cursor:"pointer",fontSize:13,color:f.publie!=="Oui"?"#c9a84c":"#5a6a8a"}}>
          <div onClick={()=>{s("publie","Non");s("dateMiseEnVente","")}} style={{width:20,height:20,borderRadius:6,border:f.publie!=="Oui"?"2px solid #c9a84c":"2px solid #2a3a5a",background:f.publie!=="Oui"?"#c9a84c":"transparent",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",transition:"all .2s"}}>
            {f.publie!=="Oui"&&<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#0a0f1e" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>}
          </div>Non
        </label>
      </div>
    </div>
    {f.publie==="Oui"&&<Field label="Date mise en vente"><input style={inp} type="date" value={f.dateMiseEnVente||""} onChange={e=>s("dateMiseEnVente",e.target.value)}/></Field>}</>}
    {formErr&&<div style={{width:"100%",padding:"10px 14px",background:"rgba(201,76,76,.1)",border:"1px solid rgba(201,76,76,.3)",borderRadius:8,color:"#c94c4c",fontSize:12,fontFamily:"'JetBrains Mono',monospace",marginTop:4}}>{formErr}</div>}
    <div style={{display:"flex",gap:12,width:"100%",justifyContent:"space-between",alignItems:"center",marginTop:14}}>
      <button style={{...btnS,padding:"10px 18px",fontSize:12,display:"flex",alignItems:"center",gap:6,opacity:analyzing?.5:1}} disabled={analyzing} onClick={()=>{if(annonceHtml){setShowAnnonce(true)}else{generateAnnonceFromForm()}}}><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg> Afficher l'annonce</button>
      <div style={{display:"flex",gap:12}}>
        <button style={btnS} onClick={onCancel}>Annuler</button>
        <button style={btnP} onClick={handleSave}>{book?"Modifier":"Ajouter"}</button>
      </div>
    </div>
    {showAnnonce&&<div onClick={()=>setShowAnnonce(false)} style={{position:"fixed",inset:0,background:"rgba(0,0,0,.75)",backdropFilter:"blur(6px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:2000,padding:16}}>
      <div onClick={e=>e.stopPropagation()} style={{background:"#fff",borderRadius:14,padding:28,width:"100%",maxWidth:820,maxHeight:"90vh",overflowY:"auto",position:"relative"}}>
        <button onClick={()=>setShowAnnonce(false)} style={{position:"absolute",top:12,right:16,background:"none",border:"none",fontSize:22,cursor:"pointer",color:"#666"}}>✕</button>
        <div style={{marginBottom:16,display:"flex",gap:10,justifyContent:"flex-end",paddingTop:4}}>
          <button onClick={()=>{navigator.clipboard.writeText(annonceHtml);setFormErr("");setAnalyzeMsg("✓ HTML copié !")}} style={{...btnS,fontSize:11,padding:"6px 14px",color:"#333",borderColor:"#ccc"}}>📋 Copier HTML</button>
        </div>
        <div dangerouslySetInnerHTML={{__html:annonceHtml}}/>
      </div>
    </div>}
  </div>);
};

function exportCSV(books){const h=["N°","Titre","Auteur","Date","Éditeur","Complétion","Catégorie","Nb vol","Siècle","EO","Thème","État","Format","Poids","Stockage","N° achat","Date achat","Px achat","Total achat","Lieu achat","Publié","Vendu","Date mise en vente","Date vente","Durée vente","Px mise en vente","Px encaissé","Modalités","Livré","Frais expédition","Bénéf attendu","Bénéf réalisé","Différence"];const rows=books.map(b=>[b.id,b.titre,b.auteur,b.date,b.editeur,b.completion,b.categorie,b.nbVol,b.siecle,b.eo,b.theme,b.etat,b.format,b.poids,b.stockage,b.numAchat,b.dateAchat,b.pxAchat,b.totalAchat,b.lieuAchat,b.publie,b.vendu,b.dateMiseEnVente,b.dateVente,b.dureeVente,b.pxMiseEnVente,b.pxEncaisse,b.modalites,b.livre,b.fraisExpedition,b.benefAttendu,b.benefRealise,b.difference]);let csv="\uFEFF"+h.join(";")+"\n"+rows.map(r=>r.map(x=>`"${String(x??"").replace(/"/g,'""')}"`).join(";")).join("\n");const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download=`Livres_CRM_${new Date().toISOString().slice(0,10)}.csv`;a.click();}

// ─── Dashboard ──────────────────────────────────────────────────────
const Dashboard=({books,expenses})=>{
  const s=useMemo(()=>{
    const vendus=books.filter(b=>b.vendu==="Oui"),enVente=books.filter(b=>b.publie==="Oui"&&b.vendu!=="Oui");
    const totalAchat=books.reduce((a,b)=>a+b.pxAchat,0),totalMEV=books.reduce((a,b)=>a+b.pxMiseEnVente,0);
    const totalEnc=vendus.reduce((a,b)=>a+b.pxEncaisse,0),benefAtt=books.reduce((a,b)=>a+b.benefAttendu,0),benefReal=vendus.reduce((a,b)=>a+b.benefRealise,0);
    const totalDep=expenses.reduce((a,b)=>a+b.montant,0);
    const tc={};books.forEach(b=>{if(b.theme)tc[b.theme]=(tc[b.theme]||0)+1});
    const sc={};books.forEach(b=>{if(b.siecle)sc[b.siecle+"ème"]=(sc[b.siecle+"ème"]||0)+1});
    const ec={};books.forEach(b=>{if(b.etat)ec[b.etat]=(ec[b.etat]||0)+1});
    const lc={};books.forEach(b=>{if(b.lieuAchat)lc[b.lieuAchat]=(lc[b.lieuAchat]||0)+1});
    return{vendus,enVente,totalAchat,totalMEV,totalEnc,benefAtt,benefReal,totalDep,topThemes:Object.entries(tc).sort((a,b)=>b[1]-a[1]).slice(0,8),topSiecles:Object.entries(sc).sort((a,b)=>b[1]-a[1]),etatCounts:Object.entries(ec),topSources:Object.entries(lc).sort((a,b)=>b[1]-a[1])};
  },[books,expenses]);
  const eC={"Excellent":"#4cc98c","Bon":"#4c8cc9","Correct":"#c9a84c","Moyen":"#c98c4c","Mauvais":"#c94c4c"};
  return(<div>
    <div style={{display:"flex",flexWrap:"wrap",gap:14,marginBottom:28}}>
      <Stat label="Total livres" value={books.length} sub={`${books.filter(b=>b.categorie==="Ouvrage").length} ouvrages · ${books.filter(b=>b.categorie==="Lot").length} lots`}/>
      <Stat label="Publiés / En vente" value={`${books.filter(b=>b.publie==="Oui").length} / ${s.enVente.length}`} accent="#4c8cc9"/>
      <Stat label="Vendus" value={s.vendus.length} accent="#4cc9a8"/>
      <Stat label="Total investi" value={fmt(s.totalAchat)} accent="#a84cc9"/>
      <Stat label="Valeur stock" value={fmt(s.totalMEV)} accent="#4c8cc9"/>
      <Stat label="CA encaissé" value={fmt(s.totalEnc)} accent="#4cc98c"/>
      <Stat label="Bénéf. attendu" value={fmt(s.benefAtt)} accent="#c9a84c"/>
      <Stat label="Bénéf. réalisé" value={fmt(s.benefReal)} accent={s.benefReal>=0?"#4cc98c":"#c94c4c"}/>
      <Stat label="Total dépenses" value={fmt(s.totalDep)} accent="#c94c8c"/>
    </div>
    <div style={{display:"flex",flexWrap:"wrap",gap:20}}>
      <div style={{...c,flex:"1 1 300px"}}><h3 style={{margin:"0 0 16px",fontSize:13,textTransform:"uppercase",letterSpacing:2,color:"#6a7a9a",fontFamily:"'JetBrains Mono',monospace"}}>Par thème</h3>
        {s.topThemes.map(([t,n])=>(<div key={t} style={{display:"flex",justifyContent:"space-between",padding:"7px 0",borderBottom:"1px solid #111827"}}><span style={{color:"#8892b0",fontSize:13}}>{t}</span><div style={{display:"flex",alignItems:"center",gap:8}}><div style={{width:n*12,maxWidth:120,height:6,background:"linear-gradient(90deg,#c9a84c,#6a5a28)",borderRadius:3}}/><span style={{color:"#c9a84c",fontWeight:700,fontSize:13,fontFamily:"'JetBrains Mono',monospace"}}>{n}</span></div></div>))}</div>
      <div style={{...c,flex:"1 1 200px"}}><h3 style={{margin:"0 0 16px",fontSize:13,textTransform:"uppercase",letterSpacing:2,color:"#6a7a9a",fontFamily:"'JetBrains Mono',monospace"}}>Par siècle</h3>
        {s.topSiecles.map(([t,n])=>(<div key={t} style={{display:"flex",justifyContent:"space-between",padding:"8px 0",borderBottom:"1px solid #111827"}}><span style={{color:"#8892b0"}}>{t}</span><span style={{color:"#4c8cc9",fontWeight:700,fontFamily:"'JetBrains Mono',monospace"}}>{n}</span></div>))}</div>
      <div style={{...c,flex:"1 1 200px"}}><h3 style={{margin:"0 0 16px",fontSize:13,textTransform:"uppercase",letterSpacing:2,color:"#6a7a9a",fontFamily:"'JetBrains Mono',monospace"}}>Par état</h3>
        {s.etatCounts.map(([t,n])=>(<div key={t} style={{display:"flex",justifyContent:"space-between",padding:"8px 0",borderBottom:"1px solid #111827"}}><span style={{color:eC[t]||"#8892b0"}}>{t}</span><span style={{color:eC[t]||"#c9a84c",fontWeight:700,fontFamily:"'JetBrains Mono',monospace"}}>{n}</span></div>))}</div>
      <div style={{...c,flex:"1 1 220px"}}><h3 style={{margin:"0 0 16px",fontSize:13,textTransform:"uppercase",letterSpacing:2,color:"#6a7a9a",fontFamily:"'JetBrains Mono',monospace"}}>Par source</h3>
        {s.topSources.map(([t,n])=>(<div key={t} style={{display:"flex",justifyContent:"space-between",padding:"8px 0",borderBottom:"1px solid #111827"}}><span style={{color:"#8892b0",fontSize:13}}>{t}</span><span style={{color:"#4cc9a8",fontWeight:700,fontFamily:"'JetBrains Mono',monospace"}}>{n}</span></div>))}</div>
    </div>
  </div>);
};

// ─── Inventaire ─────────────────────────────────────────────────────
const Inventaire=({books,onAdd,onEdit,onDelete,expenses})=>{
  const [q,setQ]=useState("");const [fT,setFT]=useState("all");const [fE,setFE]=useState("all");const [fV,setFV]=useState("all");const [fS,setFS]=useState("all");
  const [sk,setSk]=useState("id");const [sd,setSd]=useState(1);const [mo,setMo]=useState(false);const [ed,setEd]=useState(null);const [vi,setVi]=useState(null);
  const list=useMemo(()=>{let l=[...books];if(q){const s=q.toLowerCase();l=l.filter(b=>b.titre.toLowerCase().includes(s)||b.auteur.toLowerCase().includes(s)||b.theme.toLowerCase().includes(s))}
    if(fT!=="all")l=l.filter(b=>b.theme===fT);if(fE!=="all")l=l.filter(b=>b.etat===fE);if(fV!=="all")l=l.filter(b=>b.vendu===fV);if(fS!=="all")l=l.filter(b=>String(b.siecle)===fS);
    l.sort((a,b)=>{const va=a[sk],vb=b[sk];if(typeof va==="number")return(va-vb)*sd;return String(va||"").localeCompare(String(vb||""),"fr")*sd});return l;
  },[books,q,fT,fE,fV,fS,sk,sd]);
  const ds=k=>{if(sk===k)setSd(d=>-d);else{setSk(k);setSd(1)}};
  const SH=({k,children,w})=><th onClick={()=>ds(k)} style={{padding:"10px 12px",textAlign:"left",fontSize:10,textTransform:"uppercase",letterSpacing:1.5,color:"#4a5a7a",cursor:"pointer",userSelect:"none",width:w,fontFamily:"'JetBrains Mono',monospace",borderBottom:"1px solid #1e2d4a",whiteSpace:"nowrap",position:"sticky",top:0,background:"#111827",zIndex:1}}>{children}{sk===k?(sd===1?" ▲":" ▼"):""}</th>;
  return(<div>
    <div style={{display:"flex",flexWrap:"wrap",gap:10,marginBottom:16,alignItems:"center"}}>
      <input style={{...inp,flex:"1 1 220px",maxWidth:320}} placeholder="🔍 Rechercher..." value={q} onChange={e=>setQ(e.target.value)}/>
      <select style={{...sel,width:130}} value={fT} onChange={e=>setFT(e.target.value)}><option value="all">Tous thèmes</option>{THEMES.map(t=><option key={t}>{t}</option>)}</select>
      <select style={{...sel,width:110}} value={fE} onChange={e=>setFE(e.target.value)}><option value="all">Tous états</option>{ETATS.map(t=><option key={t}>{t}</option>)}</select>
      <select style={{...sel,width:110}} value={fV} onChange={e=>setFV(e.target.value)}><option value="all">Statut</option><option value="Oui">Vendu</option><option value="Non">En vente</option></select>
      <select style={{...sel,width:100}} value={fS} onChange={e=>setFS(e.target.value)}><option value="all">Siècle</option>{SIECLES.map(s=><option key={s} value={s}>{s}ème</option>)}</select>
      <div style={{flex:1}}/><button style={btnP} onClick={()=>{setEd(null);setMo(true)}}>+ Ajouter</button>
    </div>
    <div style={{overflowX:"auto",borderRadius:12,border:"1px solid #1e2d4a",maxHeight:"65vh",overflowY:"auto"}}>
      <table style={{width:"100%",borderCollapse:"collapse",background:"#111827",minWidth:1000}}>
        <thead><tr><SH k="id" w="40px">N°</SH><SH k="titre">Titre</SH><SH k="auteur">Auteur</SH><SH k="date" w="60px">Date</SH><SH k="siecle" w="50px">S.</SH><SH k="eo" w="40px">EO</SH><SH k="theme">Thème</SH><SH k="etat" w="70px">État</SH><SH k="pxAchat" w="75px">Achat</SH><SH k="pxMiseEnVente" w="80px">Px vente</SH><SH k="publie" w="65px">Publié</SH><SH k="vendu" w="55px">Vendu</SH><th style={{padding:"10px 8px",width:80,borderBottom:"1px solid #1e2d4a",position:"sticky",top:0,background:"#111827"}}/></tr></thead>
        <tbody>{list.length===0?<tr><td colSpan={13} style={{padding:40,textAlign:"center",color:"#3a4a6a",fontStyle:"italic"}}>Aucun résultat</td></tr>
        :list.map(b=>(<tr key={b.id} style={{borderBottom:"1px solid #0d1525",cursor:"pointer"}} onClick={()=>setVi(b)} onMouseEnter={e=>e.currentTarget.style.background="#141e33"} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
          <td style={{padding:"10px 12px",color:"#4a5a7a",fontSize:12,fontFamily:"'JetBrains Mono',monospace"}}>{b.id}</td>
          <td style={{padding:"10px 12px",color:"#e6f1ff",fontWeight:600,fontSize:13,fontFamily:"'Playfair Display',serif",maxWidth:260,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{b.titre}</td>
          <td style={{padding:"10px 12px",color:"#8892b0",fontSize:12}}>{b.auteur}</td>
          <td style={{padding:"10px 12px",color:"#5a6a8a",fontSize:12,fontFamily:"'JetBrains Mono',monospace"}}>{b.date}</td>
          <td style={{padding:"10px 12px",color:"#5a6a8a",fontSize:11,fontFamily:"'JetBrains Mono',monospace"}}>{b.siecle||""}</td>
          <td style={{padding:"10px 12px",color:b.eo==="EO"||b.eo==="Oui"?"#c9a84c":"#2a3a5a",fontSize:11,fontWeight:700}}>{b.eo==="EO"||b.eo==="Oui"?"EO":"·"}</td>
          <td style={{padding:"10px 12px",color:"#6a8aaa",fontSize:12}}>{b.theme}</td>
          <td style={{padding:"10px 12px"}}><span style={{fontSize:11,color:({"Excellent":"#4cc98c","Bon":"#4c8cc9","Correct":"#c9a84c","Moyen":"#c98c4c","Mauvais":"#c94c4c"})[b.etat]||"#5a6a8a"}}>{b.etat}</span></td>
          <td style={{padding:"10px 12px",color:"#a84cc9",fontSize:12,fontFamily:"'JetBrains Mono',monospace"}}>{fmt(b.pxAchat)}</td>
          <td style={{padding:"10px 12px",color:"#4c8cc9",fontSize:12,fontFamily:"'JetBrains Mono',monospace"}}>{fmt(b.pxMiseEnVente)}</td>
          <td style={{padding:"10px 12px"}} onClick={e=>e.stopPropagation()}>{b.publie==="Oui"?<span style={{color:"#4cc98c",fontWeight:700,fontSize:11}}>✓</span>:<button onClick={()=>{const now=new Date().toISOString().split("T")[0];onEdit({...b,publie:"Oui",dateMiseEnVente:b.dateMiseEnVente||now});window.open("https://www.ebay.fr/sl/prelist/suggest?sr=shstart","_blank")}} style={{background:"none",border:"1px solid #1e3050",borderRadius:5,color:"#4c8cc9",cursor:"pointer",padding:"3px 8px",fontSize:10,fontFamily:"'JetBrains Mono',monospace",whiteSpace:"nowrap"}}>Publier</button>}</td>
          <td style={{padding:"10px 12px",color:b.vendu==="Oui"?"#4cc98c":"#4a5a7a",fontSize:11,fontWeight:700}}>{b.vendu==="Oui"?"✓":"·"}</td>
          <td style={{padding:"10px 8px"}} onClick={e=>e.stopPropagation()}><div style={{display:"flex",gap:4}}>
            <button onClick={()=>{setEd(b);setMo(true)}} style={{background:"none",border:"1px solid #1e2d4a",borderRadius:5,color:"#5a7a9a",cursor:"pointer",padding:"4px 7px",fontSize:12}}>✎</button>
            <button onClick={()=>{if(confirm("Supprimer ?"))onDelete(b.id)}} style={{background:"none",border:"1px solid #2a1520",borderRadius:5,color:"#c94c4c",cursor:"pointer",padding:"4px 7px",fontSize:12}}>✕</button>
          </div></td>
        </tr>))}</tbody>
      </table>
    </div>
    <div style={{marginTop:10,fontSize:11,color:"#3a4a6a",fontFamily:"'JetBrains Mono',monospace"}}>{list.length} livre{list.length>1?"s":""}</div>
    <Modal open={mo} onClose={()=>setMo(false)} title={ed?"Modifier":"Ajouter"} wide><BookForm book={ed} expenses={expenses} onCancel={()=>setMo(false)} onSave={b=>{ed?onEdit(b):onAdd(b);setMo(false)}}/></Modal>
    <Modal open={!!vi} onClose={()=>setVi(null)} title="" narrow><BookDetail book={vi}/></Modal>
  </div>);
};

// ─── Ventes ─────────────────────────────────────────────────────────
const Ventes=({books})=>{
  const vendus=useMemo(()=>books.filter(b=>b.vendu==="Oui").sort((a,b)=>(b.dateVente||"").localeCompare(a.dateVente||"")),[books]);
  const enVente=useMemo(()=>books.filter(b=>b.publie==="Oui"&&b.vendu!=="Oui").sort((a,b)=>b.pxMiseEnVente-a.pxMiseEnVente),[books]);
  return(<div>
    <div style={{display:"flex",flexWrap:"wrap",gap:14,marginBottom:28}}>
      <Stat label="Vendus" value={vendus.length} accent="#4cc9a8"/><Stat label="CA encaissé" value={fmt(vendus.reduce((a,b)=>a+b.pxEncaisse,0))} accent="#4cc98c"/>
      <Stat label="Bénéf. réalisé" value={fmt(vendus.reduce((a,b)=>a+b.benefRealise,0))} accent="#4cc98c"/><Stat label="En vente" value={enVente.length} sub={"Bénéf att: "+fmt(enVente.reduce((a,b)=>a+b.benefAttendu,0))} accent="#c9a84c"/>
    </div>
    <div style={{display:"flex",flexWrap:"wrap",gap:20}}>
      <div style={{...c,flex:"1 1 450px"}}><h3 style={{margin:"0 0 16px",fontSize:13,textTransform:"uppercase",letterSpacing:2,color:"#6a7a9a",fontFamily:"'JetBrains Mono',monospace"}}>Ventes réalisées</h3>
        {vendus.length===0?<div style={{color:"#3a4a6a",textAlign:"center",padding:30,fontStyle:"italic"}}>Aucune vente</div>:vendus.map(b=>(<div key={b.id} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"12px 0",borderBottom:"1px solid #111827",flexWrap:"wrap",gap:6}}>
          <div><div style={{color:"#e6f1ff",fontWeight:600,fontSize:13,fontFamily:"'Playfair Display',serif"}}>{b.titre}</div><div style={{color:"#4a5a7a",fontSize:11,marginTop:2}}>{b.auteur} · {fmtD(b.dateVente)} · {b.modalites}</div></div>
          <div style={{textAlign:"right"}}><div style={{color:"#4cc9a8",fontWeight:700,fontFamily:"'JetBrains Mono',monospace",fontSize:14}}>{fmt(b.pxEncaisse)}</div><div style={{color:b.benefRealise>=0?"#4cc98c":"#c94c4c",fontSize:11,fontFamily:"'JetBrains Mono',monospace"}}>Bénéf: {fmt(b.benefRealise)}</div></div>
        </div>))}</div>
      <div style={{...c,flex:"1 1 400px"}}><h3 style={{margin:"0 0 16px",fontSize:13,textTransform:"uppercase",letterSpacing:2,color:"#6a7a9a",fontFamily:"'JetBrains Mono',monospace"}}>En vente ({enVente.length})</h3>
        {enVente.slice(0,20).map(b=>(<div key={b.id} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 0",borderBottom:"1px solid #111827",gap:6}}>
          <div><div style={{color:"#ccd6f6",fontSize:13,fontFamily:"'Playfair Display',serif"}}>{b.titre}</div><div style={{color:"#3a4a6a",fontSize:10,marginTop:2}}>{b.dureeVente}</div></div>
          <div style={{color:"#c9a84c",fontWeight:700,fontFamily:"'JetBrains Mono',monospace",fontSize:13,whiteSpace:"nowrap"}}>{fmt(b.pxMiseEnVente)}</div>
        </div>))}</div>
    </div>
  </div>);
};

// ─── Sourcing ───────────────────────────────────────────────────────
const Sourcing=({books})=>{
  const sources=useMemo(()=>{const m={};books.forEach(b=>{if(!b.lieuAchat)return;if(!m[b.lieuAchat])m[b.lieuAchat]={count:0,spent:0,sold:0,revenue:0,ba:0};m[b.lieuAchat].count++;m[b.lieuAchat].spent+=b.pxAchat;m[b.lieuAchat].ba+=b.benefAttendu;if(b.vendu==="Oui"){m[b.lieuAchat].sold++;m[b.lieuAchat].revenue+=b.pxEncaisse}});return Object.entries(m).map(([n,d])=>({name:n,...d})).sort((a,b)=>b.count-a.count)},[books]);
  const recent=useMemo(()=>[...books].sort((a,b)=>(b.dateAchat||"").localeCompare(a.dateAchat||"")).slice(0,15),[books]);
  const eo=books.filter(b=>b.eo==="EO"||b.eo==="Oui");
  return(<div>
    <div style={{display:"flex",flexWrap:"wrap",gap:14,marginBottom:28}}>
      <Stat label="Sources" value={sources.length} accent="#c9a84c"/><Stat label="Total investi" value={fmt(books.reduce((a,b)=>a+b.pxAchat,0))} accent="#a84cc9"/>
      <Stat label="Px achat moyen" value={books.length?fmt(books.reduce((a,b)=>a+b.pxAchat,0)/books.length):"—"} accent="#4c8cc9"/><Stat label="Éditions originales" value={eo.length} accent="#c9a84c"/>
    </div>
    <div style={{display:"flex",flexWrap:"wrap",gap:20}}>
      <div style={{...c,flex:"1 1 450px"}}><h3 style={{margin:"0 0 16px",fontSize:13,textTransform:"uppercase",letterSpacing:2,color:"#6a7a9a",fontFamily:"'JetBrains Mono',monospace"}}>Performance par source</h3>
        {sources.map(s=>(<div key={s.name} style={{padding:"14px 0",borderBottom:"1px solid #111827"}}>
          <div style={{display:"flex",justifyContent:"space-between",marginBottom:6}}><span style={{color:"#e6f1ff",fontWeight:600,fontSize:14}}>{s.name}</span><span style={{color:"#4a5a7a",fontSize:12,fontFamily:"'JetBrains Mono',monospace"}}>{s.count} livre{s.count>1?"s":""}</span></div>
          <div style={{display:"flex",gap:14,fontSize:11,fontFamily:"'JetBrains Mono',monospace",flexWrap:"wrap"}}><span style={{color:"#a84cc9"}}>Investi: {fmt(s.spent)}</span><span style={{color:"#4cc9a8"}}>Vendu: {s.sold}/{s.count}</span><span style={{color:"#4c8cc9"}}>CA: {fmt(s.revenue)}</span><span style={{color:"#c9a84c"}}>Bénéf att: {fmt(s.ba)}</span></div>
        </div>))}</div>
      <div style={{...c,flex:"1 1 350px"}}><h3 style={{margin:"0 0 16px",fontSize:13,textTransform:"uppercase",letterSpacing:2,color:"#6a7a9a",fontFamily:"'JetBrains Mono',monospace"}}>Derniers achats</h3>
        {recent.map(b=>(<div key={b.id} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"9px 0",borderBottom:"1px solid #111827"}}>
          <div><div style={{color:"#e6f1ff",fontSize:12,fontWeight:600,fontFamily:"'Playfair Display',serif"}}>{b.titre.length>45?b.titre.slice(0,45)+"…":b.titre}</div><div style={{color:"#3a4a6a",fontSize:10,marginTop:2}}>{fmtD(b.dateAchat)} · {b.lieuAchat}</div></div>
          <div style={{color:"#a84cc9",fontWeight:700,fontFamily:"'JetBrains Mono',monospace",fontSize:12,whiteSpace:"nowrap"}}>{fmt(b.pxAchat)}</div>
        </div>))}</div>
    </div>
  </div>);
};

// ─── Dépenses ───────────────────────────────────────────────────────
const Depenses=({expenses,onAdd})=>{
  const [mo,setMo]=useState(false);const [f,setF]=useState({venteNum:"",date:new Date().toISOString().slice(0,10),categorie:"Achat de livres",vendeur:"",montant:0,description:""});
  const sf=(k,v)=>setF(p=>({...p,[k]:v}));const total=expenses.reduce((a,b)=>a+b.montant,0);
  const byCat={};expenses.forEach(e=>{byCat[e.categorie]=(byCat[e.categorie]||0)+e.montant});
  return(<div>
    <div style={{display:"flex",flexWrap:"wrap",gap:14,marginBottom:28}}><Stat label="Total dépenses" value={fmt(total)} accent="#c94c8c"/><Stat label="Écritures" value={expenses.length} accent="#4c8cc9"/>
      {Object.entries(byCat).map(([k,m])=><Stat key={k} label={k} value={fmt(m)} accent="#8892b0"/>)}</div>
    <div style={{display:"flex",justifyContent:"flex-end",marginBottom:16}}><button style={btnP} onClick={()=>setMo(true)}>+ Ajouter</button></div>
    <div style={{...c}}><table style={{width:"100%",borderCollapse:"collapse"}}>
      <thead><tr>{["Vente N°","Date","Catégorie","Vendeur","Montant","Description"].map(h=><th key={h} style={{padding:"10px 12px",textAlign:"left",fontSize:10,textTransform:"uppercase",letterSpacing:1.5,color:"#4a5a7a",fontFamily:"'JetBrains Mono',monospace",borderBottom:"1px solid #1e2d4a"}}>{h}</th>)}</tr></thead>
      <tbody>{expenses.map((e,i)=>(<tr key={i} style={{borderBottom:"1px solid #111827"}}>
        <td style={{padding:"10px 12px",color:"#5a6a8a",fontSize:12,fontFamily:"'JetBrains Mono',monospace"}}>{e.venteNum}</td>
        <td style={{padding:"10px 12px",color:"#8892b0",fontSize:12}}>{fmtD(e.date)}</td>
        <td style={{padding:"10px 12px",color:"#6a8aaa",fontSize:12}}>{e.categorie}</td>
        <td style={{padding:"10px 12px",color:"#8892b0",fontSize:12}}>{e.vendeur}</td>
        <td style={{padding:"10px 12px",color:"#c94c8c",fontWeight:700,fontSize:13,fontFamily:"'JetBrains Mono',monospace"}}>{fmt(e.montant)}</td>
        <td style={{padding:"10px 12px",color:"#5a6a8a",fontSize:12}}>{e.description}</td>
      </tr>))}
      <tr><td colSpan={4} style={{padding:"12px",textAlign:"right",color:"#6a7a9a",fontWeight:700}}>TOTAL</td><td style={{padding:"12px",color:"#c94c8c",fontWeight:700,fontSize:14,fontFamily:"'JetBrains Mono',monospace"}}>{fmt(total)}</td><td/></tr>
      </tbody></table></div>
    <Modal open={mo} onClose={()=>setMo(false)} title="Ajouter une dépense">
      <div style={{display:"flex",flexWrap:"wrap",gap:"0 14px"}}>
        <Field label="Vente N°"><input style={inp} value={f.venteNum} onChange={e=>sf("venteNum",e.target.value)}/></Field>
        <Field label="Date"><input style={inp} type="date" value={f.date} onChange={e=>sf("date",e.target.value)}/></Field>
        <Field label="Catégorie"><select style={sel} value={f.categorie} onChange={e=>sf("categorie",e.target.value)}>{EXPENSE_CATS.map(x=><option key={x}>{x}</option>)}</select></Field>
        <Field label="Vendeur"><input style={inp} value={f.vendeur} onChange={e=>sf("vendeur",e.target.value)}/></Field>
        <Field label="Montant €"><input style={inp} type="number" step="0.01" value={f.montant} onChange={e=>sf("montant",+e.target.value)}/></Field>
        <Field label="Description" w="1 1 100%"><input style={inp} value={f.description} onChange={e=>sf("description",e.target.value)}/></Field>
        <div style={{display:"flex",gap:12,width:"100%",justifyContent:"flex-end",marginTop:10}}>
          <button style={btnS} onClick={()=>setMo(false)}>Annuler</button>
          <button style={btnP} onClick={()=>{onAdd({...f});setMo(false);setF({venteNum:"",date:new Date().toISOString().slice(0,10),categorie:"Achat de livres",vendeur:"",montant:0,description:""})}}>Ajouter</button>
        </div>
      </div>
    </Modal>
  </div>);
};

// ─── App ────────────────────────────────────────────────────────────
function App(){
  const [books,setBooks]=useState([]);
  const [expenses,setExpenses]=useState([]);
  const [tab,setTab]=useState("dashboard");
  const [loading,setLoading]=useState(true);
  const [syncMsg,setSyncMsg]=useState("");

  useEffect(()=>{(async()=>{try{
    const bRes=await fetch(SB_URL+"/rest/v1/livres?select=*&order=id.asc",{headers:{"apikey":SB_KEY,"Authorization":"Bearer "+SB_KEY}});
    const bData=bRes.ok?await bRes.json():[];
    const eRes=await fetch(SB_URL+"/rest/v1/depenses?select=*&order=id.asc",{headers:{"apikey":SB_KEY,"Authorization":"Bearer "+SB_KEY}});
    const eData=eRes.ok?await eRes.json():[];
    if(bData.length===0){
      setSyncMsg("Initialisation...");
      for(let i=0;i<IMPORTED_BOOKS.length;i+=10){await fetch(SB_URL+"/rest/v1/livres",{method:"POST",headers:SB_H,body:JSON.stringify(IMPORTED_BOOKS.slice(i,i+10).map(bookToDb))})}
      for(let i=0;i<IMPORTED_EXPENSES.length;i+=10){await fetch(SB_URL+"/rest/v1/depenses",{method:"POST",headers:SB_H,body:JSON.stringify(IMPORTED_EXPENSES.slice(i,i+10).map(expToDb))})}
      setBooks(IMPORTED_BOOKS);setExpenses(IMPORTED_EXPENSES);setSyncMsg("✓ Base initialisée");
    }else{setBooks(bData.map(dbToBook));setExpenses(eData.map(dbToExp));setSyncMsg("✓ "+bData.length+" livres")}
  }catch(err){setBooks(IMPORTED_BOOKS);setExpenses(IMPORTED_EXPENSES);setSyncMsg("✗ Mode hors-ligne")}
  setLoading(false);setTimeout(()=>setSyncMsg(""),4000)})()},[]);

  const addBook=async(b)=>{setBooks(p=>[...p,b]);try{await fetch(SB_URL+"/rest/v1/livres",{method:"POST",headers:SB_H,body:JSON.stringify(bookToDb(b))})}catch(e){}};
  const editBook=async(b)=>{setBooks(p=>p.map(x=>x.id===b.id?b:x));try{await fetch(SB_URL+"/rest/v1/livres?id=eq."+encodeURIComponent(b.id),{method:"PATCH",headers:SB_H,body:JSON.stringify(bookToDb(b))})}catch(e){}};
  const deleteBook=async(id)=>{setBooks(p=>p.filter(x=>x.id!==id));try{await fetch(SB_URL+"/rest/v1/livres?id=eq."+encodeURIComponent(id),{method:"DELETE",headers:{"apikey":SB_KEY,"Authorization":"Bearer "+SB_KEY}})}catch(e){}};
  const addExpense=async(e)=>{setExpenses(p=>[...p,e]);try{await fetch(SB_URL+"/rest/v1/depenses",{method:"POST",headers:SB_H,body:JSON.stringify(expToDb(e))})}catch(e2){}};

  if(loading)return(<div style={{minHeight:"100vh",background:"#080c18",display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:16}}>
    <div style={{fontSize:28,color:"#c9a84c"}}>📚</div>
    <div style={{color:"#8892b0",fontFamily:"'JetBrains Mono',monospace",fontSize:13}}>Chargement...</div>
  </div>);

  return(<div style={{minHeight:"100vh",background:"#080c18",color:"#ccd6f6",fontFamily:"'Georgia','Times New Roman',serif"}}>
    <header style={{background:"linear-gradient(135deg,#0d1525,#111827,#0d1525)",borderBottom:"1px solid #1a2540",padding:"16px 28px",display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:12}}>
      <div style={{display:"flex",alignItems:"center",gap:14}}>
        <div style={{fontSize:28,fontFamily:"'Playfair Display',serif",color:"#c9a84c"}}>📚</div>
        <div><h1 style={{margin:0,fontSize:20,fontWeight:700,color:"#e6f1ff",fontFamily:"'Playfair Display',serif",letterSpacing:1}}>Reliures & Livres</h1>
        <div style={{fontSize:10,color:"#3a4a6a",fontFamily:"'JetBrains Mono',monospace",letterSpacing:2,textTransform:"uppercase"}}>CRM · {books.length} ouvrages</div></div>
      </div>
      <div style={{display:"flex",gap:3,background:"#0a0f1e",borderRadius:10,padding:3,border:"1px solid #1a2540",flexWrap:"wrap"}}>
        {TABS.map(t=>(<button key={t.key} onClick={()=>setTab(t.key)} style={{padding:"9px 14px",border:"none",borderRadius:8,background:tab===t.key?"linear-gradient(135deg,#c9a84c22,#c9a84c11)":"transparent",color:tab===t.key?"#c9a84c":"#4a5a7a",fontSize:12,fontWeight:600,cursor:"pointer",fontFamily:"'JetBrains Mono',monospace",transition:"all .2s"}}><span style={{marginRight:5}}>{t.icon}</span>{t.label}</button>))}
      </div>
      <div style={{display:"flex",alignItems:"center",gap:12}}>
        {syncMsg&&<div style={{fontSize:10,fontFamily:"'JetBrains Mono',monospace",color:syncMsg.startsWith("✓")?"#4cc98c":syncMsg.startsWith("✗")?"#c94c4c":"#8ab4f8"}}>{syncMsg}</div>}
        <button onClick={()=>exportCSV(books)} style={{...btnS,padding:"9px 16px",fontSize:11}}>⬇ Export CSV</button>
      </div>
    </header>
    <main style={{padding:"24px 28px",maxWidth:1440,margin:"0 auto"}}>
      {tab==="dashboard"&&<Dashboard books={books} expenses={expenses}/>}
      {tab==="inventaire"&&<Inventaire books={books} expenses={expenses} onAdd={addBook} onEdit={editBook} onDelete={deleteBook}/>}
      {tab==="ventes"&&<Ventes books={books}/>}
      {tab==="sourcing"&&<Sourcing books={books}/>}
      {tab==="depenses"&&<Depenses expenses={expenses} onAdd={addExpense}/>}
    </main>
  </div>);
}

ReactDOM.render(<App/>,document.getElementById("root"));
</script>
</body>
</html>
